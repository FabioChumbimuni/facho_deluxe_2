{% extends "admin/change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrahead %}
{{ block.super }}
<style>
    .time-remaining {
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-block;
        min-width: 120px;
        text-align: center;
    }
    .time-remaining.ready {
        background-color: #ffebee;
        color: #c62828;
        border: 1px solid #ef5350;
    }
    .time-remaining.waiting {
        background-color: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #4caf50;
    }
    .time-remaining.soon {
        background-color: #fff3e0;
        color: #ef6c00;
        border: 1px solid #ff9800;
    }
    .time-remaining.disabled {
        background-color: #f5f5f5;
        color: #757575;
        border: 1px solid #bdbdbd;
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Funci√≥n para actualizar el tiempo restante
    function updateTimeRemaining() {
        const timeElements = document.querySelectorAll('.time-remaining');
        timeElements.forEach(function(element) {
            const nextRunText = element.getAttribute('data-next-run');
            if (!nextRunText || nextRunText === 'No programado') {
                element.textContent = 'No programado';
                element.className = 'time-remaining waiting';
                return;
            }
            
            // Si es "No disponible" (job deshabilitado)
            if (nextRunText === 'No disponible') {
                element.textContent = '‚ö´ No disponible';
                element.className = 'time-remaining disabled';
                return;
            }
            
            // Parsear la fecha (formato: DD/MM/YYYY HH:MM:SS)
            const [datePart, timePart] = nextRunText.split(' ');
            const [day, month, year] = datePart.split('/');
            const [hours, minutes, seconds] = timePart.split(':');
            
            const nextRun = new Date(year, month - 1, day, hours, minutes, seconds);
            const now = new Date();
            const diff = nextRun - now;
            
            if (diff <= 0) {
                element.textContent = 'üî¥ Listo para ejecutar';
                element.className = 'time-remaining ready';
            } else {
                const totalSeconds = Math.floor(diff / 1000);
                const days = Math.floor(totalSeconds / 86400);
                const hours = Math.floor((totalSeconds % 86400) / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                let timeText = '';
                if (days > 0) {
                    timeText = `En ${days}d ${hours}h`;
                } else if (hours > 0) {
                    timeText = `En ${hours}h ${minutes}m`;
                } else if (minutes > 0) {
                    timeText = `En ${minutes}m ${seconds}s`;
                } else {
                    timeText = `En ${seconds}s`;
                }
                
                element.textContent = `‚è∞ ${timeText}`;
                
                if (totalSeconds < 300) { // Menos de 5 minutos
                    element.className = 'time-remaining soon';
                } else {
                    element.className = 'time-remaining waiting';
                }
            }
        });
    }
    
    // Actualizar inmediatamente
    updateTimeRemaining();
    
    // Actualizar cada 30 segundos
    setInterval(updateTimeRemaining, 30000);
});
</script>
{% endblock %}

{% block result_list %}
    {% if action_form and actions_on_top and cl.full_result_count %}
        {% admin_actions %}
    {% endif %}
    
    <div class="results">
        <table id="result_list">
            <thead>
                <tr>
                    {% for header in result_headers %}
                        <th scope="col" {{ header.class_attrib }}>
                            {% if header.sortable %}
                                {% if header.sort_priority > 0 %}
                                    <div class="sortoptions">
                                        <a class="sortremove" href="{{ header.url_remove }}" title="{% trans "Remove from sorting" %}"></a>
                                        {% if num_sorted_fields > 1 %}<span class="sortpriority" title="{% blocktrans with priority_number=header.sort_priority %}Sorting priority: {{ priority_number }}{% endblocktrans %}">{{ header.sort_priority }}</span>{% endif %}
                                        <a href="{{ header.url_toggle }}" class="toggle {% if header.ascending %}ascending{% else %}descending{% endif %}" title="{% trans "Toggle sorting" %}"></a>
                                    </div>
                                {% endif %}
                            {% endif %}
                            <div class="text">
                                {% if header.sortable %}<a href="{{ header.url_primary }}">{{ header.text|capfirst }}</a>{% else %}<span>{{ header.text|capfirst }}</span>{% endif %}
                            </div>
                            <div class="clear"></div>
                        </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for result in results %}
                    <tr class="{% cycle 'row1' 'row2' %}">
                        {% for item in result %}
                            <td class="{{ item.classes }}">
                                {% if item.field == 'get_time_until_next_run' %}
                                    <span class="time-remaining" data-next-run="{{ result|slice:":1"|first.get_next_run_display }}">
                                        {{ item.contents }}
                                    </span>
                                {% else %}
                                    {{ item.contents }}
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if action_form and actions_on_bottom and cl.full_result_count %}
        {% admin_actions %}
    {% endif %}
{% endblock %}
