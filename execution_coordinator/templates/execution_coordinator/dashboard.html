
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Coordinaci贸n - Facho Deluxe v2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f1419;
            color: #e6e6e6;
            min-height: 100vh;
            padding: 12px;
            font-size: 13px;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 18px 26px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            box-shadow: 0 6px 18px rgba(102, 126, 234, 0.25);
        }
        .header h1 {
            font-size: 22px;
            letter-spacing: 0.4px;
        }
        .header-info {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        .header-stats {
            display: flex;
            gap: 18px;
        }
        .header-stat {
            text-align: center;
        }
        .header-stat .value {
            font-size: 24px;
            font-weight: 700;
        }
        .header-stat .label {
            font-size: 11px;
            text-transform: uppercase;
            opacity: 0.9;
            letter-spacing: 0.5px;
        }
        .live-clock {
            font-size: 22px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }
        .summary-card {
            background: #16202c;
            border-radius: 8px;
            padding: 12px 14px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .summary-card .label {
            font-size: 11px;
            text-transform: uppercase;
            color: #8892a6;
            letter-spacing: 0.4px;
        }
        .summary-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #e6e6e6;
        }
        .summary-card .subtext {
            font-size: 11px;
            color: #8892a6;
        }
        .strategy-banner {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 14px 18px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }
        .strategy-info { flex: 1; }
        .strategy-title {
            font-weight: 600;
            color: #ffc107;
            letter-spacing: 0.3px;
        }
        .strategy-desc {
            font-size: 12px;
            color: #cfd2da;
            margin-top: 4px;
        }
        .strategy-features {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .strategy-feature {
            background: rgba(255, 255, 255, 0.07);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            color: #ffc107;
        }
        .strategy-metrics {
            min-width: 220px;
            display: grid;
            gap: 8px;
        }
        .metric-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 10px;
        }
        .metric-card .label {
            font-size: 10px;
            text-transform: uppercase;
            color: #ffc107;
            letter-spacing: 0.4px;
        }
        .metric-card .value {
            font-size: 20px;
            font-weight: 700;
        }
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 12px;
        }
        .main-table-wrapper {
            background: #16202c;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
        }
        .main-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .main-table thead {
            background: #1e2936;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .main-table th,
        .main-table td {
            padding: 9px 12px;
        }
        .main-table th {
            font-size: 10px;
            text-transform: uppercase;
            color: #8892a6;
            letter-spacing: 0.3px;
            border-bottom: 2px solid #0f1419;
        }
        .main-table tbody tr:hover { background: #1e2936; }
        .olt-col {
            background: #1a2332;
            border-right: 2px solid #0f1419;
        }
        .olt-name {
            font-weight: 700;
            color: #7b8dff;
            font-size: 13px;
        }
        .olt-ip { font-size: 10px; color: #8892a6; }
        .olt-extra {
            margin-top: 6px;
            font-size: 10px;
            color: #a3adbe;
            line-height: 1.4;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge.discovery { background: #28a745; color: white; }
        .badge.get { background: #17a2b8; color: white; }
        .priority { font-weight: 700; font-size: 11px; }
        .priority.p90 { color: #dc3545; }
        .priority.p40 { color: #ffc107; }
        .time-until { font-weight: 600; }
        .time-until.ready { color: #ff7675; animation: pulse 1s infinite; }
        .time-until.soon { color: #ffc107; }
        .time-until.normal { color: #28a745; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .quota-bar {
            width: 90px;
            height: 16px;
            background: #0f1419;
            border-radius: 8px;
            border: 1px solid #1e2936;
            overflow: hidden;
        }
        .quota-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 700;
            transition: width 0.3s ease;
        }
        .quota-fill.low { background: #dc3545; }
        .quota-fill.medium { background: #ffc107; color: #000; }
        .quota-fill.high { background: #28a745; }
        .quota-text { font-size: 10px; color: #8892a6; margin-top: 2px; }
        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        .status-badge.SUCCESS { background: #28a745; color: white; }
        .status-badge.FAILED { background: #dc3545; color: white; }
        .status-badge.RUNNING { background: #17a2b8; color: white; }
        .status-badge.PENDING { background: #ffc107; color: #000; }
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .panel {
            background: #16202c;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
        }
        .panel h2 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #8892a6;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .queue-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        .queue-table th,
        .queue-table td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid #1f2a38;
        }
        .events-list {
            max-height: 360px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .event-item {
            background: #1a2332;
            border-left: 3px solid #667eea;
            border-radius: 6px;
            padding: 8px 10px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .event-header {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #8892a6;
        }
        .event-title { font-weight: 600; color: #e6e6e6; }
        .event-meta {
            display: flex;
            gap: 8px;
            font-size: 11px;
            color: #a3adbe;
            flex-wrap: wrap;
        }
        .event-meta span {
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 6px;
            border-radius: 12px;
        }
        .no-data,
        .loading { text-align: center; padding: 40px; color: #8892a6; }
        .footer {
            text-align: center;
            font-size: 11px;
            color: #8892a6;
            margin-top: 4px;
        }
        @media (max-width: 1200px) {
            .main-content { grid-template-columns: 1fr; }
            .sidebar { flex-direction: row; flex-wrap: wrap; }
            .panel { flex: 1; min-width: 280px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> Dashboard de Coordinaci贸n SNMP</h1>
            <div class="header-info">
                <div class="header-stats">
                    <div class="header-stat">
                        <div class="value" id="total-olts">0</div>
                        <div class="label">OLTs</div>
                    </div>
                    <div class="header-stat">
                        <div class="value" id="total-tasks">0</div>
                        <div class="label">Tareas</div>
                    </div>
                    <div class="header-stat">
                        <div class="value" id="total-exec-hour">0</div>
                        <div class="label">Exec/Hora</div>
                    </div>
                </div>
                <div class="current-time">
                    <div id="current-date" style="font-size: 11px; opacity: 0.9;"></div>
                    <div class="live-clock" id="live-clock">--:--:--</div>
                </div>
            </div>
        </div>

        <div class="summary-cards">
            <div class="summary-card">
                <div class="label">Pendientes</div>
                <div class="value" id="pending-count">0</div>
                <div class="subtext">Tareas esperando workers</div>
            </div>
            <div class="summary-card">
                <div class="label">En ejecuci贸n</div>
                <div class="value" id="running-count">0</div>
                <div class="subtext">Workers procesando en vivo</div>
            </div>
            <div class="summary-card">
                <div class="label">Listas para disparar</div>
                <div class="value" id="ready-count">0</div>
                <div class="subtext">next_run vencido</div>
            </div>
            <div class="summary-card">
                <div class="label">Interrumpidas (1h)</div>
                <div class="value" id="interrupted-count">0</div>
                <div class="subtext">Monitor delivery checker</div>
            </div>
        </div>

        <div class="strategy-banner">
            <div class="strategy-info">
                <div class="strategy-title">锔 Estrategia: Coordinaci贸n con Prioridades y Cuotas</div>
                <div class="strategy-desc">
                    El coordinator ejecuta tareas secuencialmente por OLT evitando colisiones. Discovery (P90) siempre antes que GET (P40). Cada ciclo respeta cuotas por hora y monitorea saturaci贸n.
                </div>
                <div class="strategy-features" id="strategy-features">
                    <span class="strategy-feature">Una tarea SNMP por OLT</span>
                    <span class="strategy-feature">Auto-reparaci贸n de JobHosts</span>
                    <span class="strategy-feature">Colisiones &lt; 60s detectadas</span>
                </div>
            </div>
            <div class="strategy-metrics">
                <div class="metric-card">
                    <div class="label">Colisiones detectadas</div>
                    <div class="value" id="collisions-total">0</div>
                </div>
                <div class="metric-card">
                    <div class="label">Tareas secuenciadas</div>
                    <div class="value" id="tasks-sequenced">0</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="main-table-wrapper">
                <table class="main-table" id="main-table">
                    <thead>
                        <tr>
                            <th style="width: 220px;">OLT</th>
                            <th style="width: 200px;">Tarea</th>
                            <th style="width: 80px;">Tipo</th>
                            <th style="width: 120px;">OID</th>
                            <th style="width: 80px;">Intervalo</th>
                            <th style="width: 60px;">Veces/Hora</th>
                            <th style="width: 40px;">Prior.</th>
                            <th style="width: 90px;">Pr贸xima</th>
                            <th style="width: 100px;">Tiempo Rest.</th>
                            <th style="width: 110px;">Cuota Hora</th>
                            <th style="width: 130px;">ltima Ejec.</th>
                            <th style="width: 80px;">Duraci贸n</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr><td colspan="12" class="loading">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="sidebar">
                <div class="panel">
                    <h2>Cola por tipo de tarea</h2>
                    <table class="queue-table">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Pendientes</th>
                                <th>Ejecutando</th>
                            </tr>
                        </thead>
                        <tbody id="queue-breakdown-body">
                            <tr><td colspan="3" class="no-data">Sin tareas en cola</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="panel">
                    <h2>Eventos recientes del coordinator</h2>
                    <div class="events-list" id="events-list">
                        <div class="no-data">Sin eventos registrados</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            Actualizaci贸n autom谩tica cada 3s | ltima actualizaci贸n: <span id="last-update">--:--:--</span>
        </div>
    </div>

    <script>
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('live-clock').textContent = `${hours}:${minutes}:${seconds}`;
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            document.getElementById('current-date').textContent = `${day}/${month}/${year}`;
        }
        updateClock();
        setInterval(updateClock, 1000);

        function renderQueueBreakdown(breakdown) {
            const tbody = document.getElementById('queue-breakdown-body');
            if (!breakdown.length) {
                tbody.innerHTML = '<tr><td colspan="3" class="no-data">Sin tareas en cola</td></tr>';
                return;
            }
            tbody.innerHTML = breakdown.map(item => `
                <tr>
                    <td>${item.type_display}</td>
                    <td style="color:#ffc107; font-weight:700;">${item.pending}</td>
                    <td style="color:#17a2b8; font-weight:700;">${item.running}</td>
                </tr>
            `).join('');
        }

        function renderEvents(events) {
            const container = document.getElementById('events-list');
            if (!events.length) {
                container.innerHTML = '<div class="no-data">Sin eventos registrados</div>';
                return;
            }
            container.innerHTML = events.map(event => `
                <div class="event-item">
                    <div class="event-header">
                        <span>${event.time} 路 ${event.olt}</span>
                        <span>ID Exec: ${event.execution_id || 'N/A'}</span>
                    </div>
                    <div class="event-title">${event.event_type}</div>
                    <div class="event-meta">
                        <span>${event.source}</span>
                        ${event.decision ? `<span>Decisi贸n: ${event.decision}</span>` : ''}
                        <span>${event.job}</span>
                    </div>
                    ${event.reason ? `<div style="font-size:11px; color:#cfd2da;">${event.reason}</div>` : ''}
                    ${event.details_summary ? `<div style="font-size:10px; color:#8892a6;">${event.details_summary}</div>` : ''}
                </div>
            `).join('');
        }

        function updateDashboard() {
            fetch('/coordinator/dashboard/data/')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-olts').textContent = data.stats.total_olts;
                    document.getElementById('total-tasks').textContent = data.stats.total_tasks;
                    document.getElementById('total-exec-hour').textContent = data.stats.total_executions_hour;
                    document.getElementById('pending-count').textContent = data.stats.pending_executions;
                    document.getElementById('running-count').textContent = data.stats.running_executions;
                    document.getElementById('interrupted-count').textContent = data.stats.interrupted_last_hour;
                    document.getElementById('collisions-total').textContent = data.strategy.metrics.collisions_detected;
                    document.getElementById('tasks-sequenced').textContent = data.strategy.metrics.tasks_sequenced;
                    document.getElementById('ready-count').textContent = data.strategy.metrics.ready_to_run;

                    const now = new Date();
                    const updateTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
                    document.getElementById('last-update').textContent = updateTime;

                    const tbody = document.getElementById('table-body');
                    if (!data.olts.length) {
                        tbody.innerHTML = '<tr><td colspan="12" class="no-data">No hay OLTs activas</td></tr>';
                    } else {
                        let html = '';
                        data.olts.forEach(olt => {
                            olt.tasks.forEach((task, index) => {
                                const isFirst = index === 0;
                                const rowspan = olt.tasks.length;
                                html += '<tr>';
                                if (isFirst) {
                                    html += `
                                        <td class="olt-col" rowspan="${rowspan}">
                                            <div class="olt-name">${olt.name}</div>
                                            <div class="olt-ip">${olt.ip}</div>
                                            <div class="olt-extra">
                                                ${olt.tasks_count} tareas 路 ${olt.total_executions_hour} exec/h<br>
                                                Pendientes: ${olt.status_counts.PENDING || 0} 路 Ejecutando: ${olt.status_counts.RUNNING || 0}<br>
                                                Listas: ${olt.ready_tasks} 路 Colisiones: ${olt.collisions}
                                            </div>
                                            ${olt.recent_events.length ? `
                                                <div class="olt-extra" style="margin-top:6px;">
                                                    ltimos eventos:<br>
                                                    ${olt.recent_events.map(ev => `<span style="display:block;">${ev.time} 路 ${ev.event_type}</span>`).join('')}
                                                </div>
                                            ` : ''}
                                        </td>
                                    `;
                                }
                                html += `
                                    <td><div>${task.name}</div></td>
                                    <td><span class="badge ${task.type}">${task.type_display}</span></td>
                                    <td style="font-size:10px; color:#8892a6;">${task.oid}</td>
                                    <td><span class="badge" style="background:rgba(255,255,255,0.08);">${task.interval_raw}</span></td>
                                    <td style="text-align:center; font-weight:700; font-size:14px;">${task.executions_per_hour}x</td>
                                    <td><span class="priority p${task.priority}">P${task.priority}</span></td>
                                    <td class="time-cell">${task.next_run}</td>
                                    <td><span class="time-until ${task.time_class}">${task.time_until}</span></td>
                                    <td>
                                        <div class="quota-bar">
                                            <div class="quota-fill ${task.quota.percentage >= 80 ? 'high' : task.quota.percentage >= 50 ? 'medium' : 'low'}" style="width: ${Math.min(task.quota.percentage, 100)}%;">
                                                ${Math.round(task.quota.percentage)}%
                                            </div>
                                        </div>
                                        <div class="quota-text">${task.quota.completed}/${task.quota.required}</div>
                                    </td>
                                    <td>
                                        ${task.last_execution.time ? `
                                            <div style="font-size:11px; font-family:'Courier New', monospace;">${task.last_execution.time}</div>
                                            <span class="status-badge ${task.last_execution.status}">${task.last_execution.status}</span>
                                        ` : '<span style="color:#666; font-size:10px;">Sin datos</span>'}
                                    </td>
                                    <td style="font-size:10px; color:#8892a6;">
                                        ${task.last_execution.duration > 0 ? (task.last_execution.duration / 1000).toFixed(1) + 's' : '-'}
                                    </td>
                                `;
                                html += '</tr>';
                            });
                        });
                        tbody.innerHTML = html;
                    }

                    renderQueueBreakdown(data.stats.queue_breakdown);
                    renderEvents(data.events);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('table-body').innerHTML = '<tr><td colspan="12" class="no-data">Error al cargar datos</td></tr>';
                });
        }

        updateDashboard();
        setInterval(updateDashboard, 3000);
    </script>
</body>
</html>
