<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Coordinaci贸n - Facho Deluxe v2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f1419;
            color: #e6e6e6;
            min-height: 100vh;
            padding: 10px;
            font-size: 13px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 25px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .header h1 {
            font-size: 22px;
        }
        
        .header-stats {
            display: flex;
            gap: 20px;
            font-size: 12px;
        }
        
        .header-stat .value {
            font-size: 20px;
            font-weight: bold;
        }
        
        .header-stat .label {
            font-size: 10px;
            text-transform: uppercase;
            opacity: 0.9;
        }
        
        .live-clock {
            font-size: 20px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        
        .strategy-banner {
            background: rgba(255, 193, 7, 0.15);
            border-left: 4px solid #ffc107;
            padding: 12px 20px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .strategy-banner .title {
            font-weight: bold;
            color: #ffc107;
            font-size: 13px;
        }
        
        .strategy-banner .desc {
            font-size: 11px;
            color: #ccc;
            margin-top: 3px;
        }
        
        .strategy-stats {
            display: flex;
            gap: 15px;
            font-size: 11px;
        }
        
        .strategy-stat {
            padding: 5px 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            text-align: center;
        }
        
        .strategy-stat .val {
            font-size: 16px;
            font-weight: bold;
            color: #28a745;
        }
        
        .main-table-wrapper {
            background: #16202c;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .main-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .main-table thead {
            background: #1e2936;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .main-table th {
            padding: 10px 12px;
            text-align: left;
            font-size: 10px;
            text-transform: uppercase;
            color: #8892a6;
            font-weight: 600;
            border-bottom: 2px solid #0f1419;
        }
        
        .main-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #1e2936;
        }
        
        .main-table tbody tr:hover {
            background: #1e2936;
        }
        
        .main-table tbody tr.olt-row {
            background: #1a2332;
            font-weight: bold;
        }
        
        .main-table tbody tr.olt-row:hover {
            background: #1e2936;
        }
        
        .main-table tbody tr.task-row {
            background: #16202c;
        }
        
        .olt-name {
            font-weight: bold;
            color: #667eea;
            font-size: 13px;
        }
        
        .olt-ip {
            font-size: 10px;
            color: #8892a6;
        }
        
        .task-name {
            color: #e6e6e6;
            padding-left: 20px;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 7px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge.discovery {
            background: #28a745;
            color: white;
        }
        
        .badge.get {
            background: #17a2b8;
            color: white;
        }
        
        .priority {
            font-weight: bold;
            font-size: 11px;
        }
        
        .priority.p90 {
            color: #dc3545;
        }
        
        .priority.p40 {
            color: #ffc107;
        }
        
        .time-cell {
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }
        
        .time-until {
            font-weight: 600;
        }
        
        .time-until.ready {
            color: #dc3545;
            animation: pulse 1s infinite;
        }
        
        .time-until.soon {
            color: #ffc107;
        }
        
        .time-until.normal {
            color: #28a745;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .quota-bar {
            width: 80px;
            height: 16px;
            background: #0f1419;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            border: 1px solid #1e2936;
        }
        
        .quota-fill {
            height: 100%;
            transition: width 0.3s ease;
            font-size: 9px;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quota-fill.low {
            background: #dc3545;
        }
        
        .quota-fill.medium {
            background: #ffc107;
        }
        
        .quota-fill.high {
            background: #28a745;
        }
        
        .quota-text {
            font-size: 10px;
            color: #8892a6;
            margin-top: 2px;
        }
        
        .status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
        }
        
        .status.SUCCESS {
            background: #28a745;
            color: white;
        }
        
        .status.FAILED {
            background: #dc3545;
            color: white;
        }
        
        .status.RUNNING {
            background: #17a2b8;
            color: white;
        }
        
        .status.PENDING {
            background: #ffc107;
            color: #000;
        }
        
        .footer {
            text-align: center;
            margin-top: 15px;
            font-size: 11px;
            color: #8892a6;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 16px;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #8892a6;
        }
        
        .interval-badge {
            background: rgba(255,255,255,0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            color: #8892a6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> Dashboard de Coordinaci贸n SNMP</h1>
            <div class="header-info">
                <div class="header-stats">
                    <div class="header-stat">
                        <div class="value" id="total-olts">0</div>
                        <div class="label">OLTs</div>
                    </div>
                    <div class="header-stat">
                        <div class="value" id="total-tasks">0</div>
                        <div class="label">Tareas</div>
                    </div>
                    <div class="header-stat">
                        <div class="value" id="total-exec-hour">0</div>
                        <div class="label">Exec/Hora</div>
                    </div>
                </div>
                <div class="current-time">
                    <div id="current-date" style="font-size: 11px; opacity: 0.9;"></div>
                    <div class="live-clock" id="live-clock">--:--:--</div>
                </div>
            </div>
        </div>
        
        <div class="strategy-banner">
            <div class="strategy-info">
                <div class="strategy-title">锔 Estrategia: Coordinaci贸n con Prioridades y Cuotas</div>
                <div class="strategy-desc">
                    El coordinator ejecuta tareas secuencialmente por OLT evitando colisiones. 
                    Discovery (prioridad 90) siempre antes que GET (prioridad 40). 
                    Cada tarea cumple su cuota de ejecuciones por hora.
                </div>
            </div>
            <div class="strategy-stats">
                <div class="strategy-stat">
                    <div class="val" id="collision-prevented">0</div>
                    <div>Colisiones Evitadas</div>
                </div>
                <div class="strategy-stat">
                    <div class="val" id="tasks-sequenced">0</div>
                    <div>Tareas Secuenciadas</div>
                </div>
            </div>
        </div>
        
        <div class="main-table-wrapper">
            <table class="main-table" id="main-table">
                <thead>
                    <tr>
                        <th style="width: 180px;">OLT</th>
                        <th style="width: 200px;">Tarea</th>
                        <th style="width: 80px;">Tipo</th>
                        <th style="width: 120px;">OID</th>
                        <th style="width: 80px;">Intervalo</th>
                        <th style="width: 60px;">Veces/Hora</th>
                        <th style="width: 40px;">Prior.</th>
                        <th style="width: 80px;">Pr贸xima</th>
                        <th style="width: 90px;">Tiempo Rest.</th>
                        <th style="width: 100px;">Cuota Hora</th>
                        <th style="width: 120px;">ltima Ejec.</th>
                        <th style="width: 80px;">Duraci贸n</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <tr>
                        <td colspan="12" class="loading">Cargando datos...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            Actualizaci贸n autom谩tica cada 3s | ltima actualizaci贸n: <span id="last-update">--:--:--</span>
        </div>
    </div>
    
    <script>
        // Actualizar reloj en tiempo real cada segundo
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            document.getElementById('live-clock').textContent = `${hours}:${minutes}:${seconds}`;
            
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            document.getElementById('current-date').textContent = `${day}/${month}/${year}`;
        }
        
        // Actualizar reloj cada segundo
        updateClock();
        setInterval(updateClock, 1000);
        
        function updateDashboard() {
            fetch('/coordinator/dashboard/data/')
                .then(response => response.json())
                .then(data => {
                    // Actualizar estad铆sticas globales
                    document.getElementById('total-olts').textContent = data.stats.total_olts;
                    document.getElementById('total-tasks').textContent = data.stats.total_tasks;
                    document.getElementById('total-exec-hour').textContent = data.stats.total_executions_hour;
                    
                    // Actualizar timestamp
                    const now = new Date();
                    const updateTime = String(now.getHours()).padStart(2, '0') + ':' + 
                                      String(now.getMinutes()).padStart(2, '0') + ':' + 
                                      String(now.getSeconds()).padStart(2, '0');
                    document.getElementById('last-update').textContent = updateTime;
                    
                    // Renderizar tabla
                    const tbody = document.getElementById('table-body');
                    
                    if (data.olts.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="12" class="no-data">No hay OLTs activas</td></tr>';
                        return;
                    }
                    
                    let html = '';
                    let totalCollisions = 0;
                    let totalSequenced = 0;
                    
                    data.olts.forEach(olt => {
                        olt.tasks.forEach((task, index) => {
                            const isFirstTask = index === 0;
                            const rowspan = olt.tasks.length;
                            
                            // Calcular si hay colisi贸n con otras tareas
                            const hasCollision = olt.tasks.some((t, i) => 
                                i !== index && Math.abs(
                                    new Date(t.next_run).getTime() - new Date(task.next_run).getTime()
                                ) < 60000 // Menos de 1 minuto de diferencia
                            );
                            
                            if (hasCollision) totalCollisions++;
                            totalSequenced++;
                            
                            html += `<tr class="task-row">`;
                            
                            // Columna OLT (solo en primera fila)
                            if (isFirstTask) {
                                html += `
                                    <td rowspan="${rowspan}" style="background: #1a2332; border-right: 2px solid #0f1419;">
                                        <div class="olt-name">${olt.name}</div>
                                        <div class="olt-ip">${olt.ip}</div>
                                        <div style="font-size: 10px; color: #8892a6; margin-top: 3px;">
                                            ${olt.tasks_count} tareas | ${olt.total_executions_hour} exec/h
                                        </div>
                                    </td>
                                `;
                            }
                            
                            // Resto de columnas
                            html += `
                                <td>
                                    <div>${task.name}</div>
                                </td>
                                <td>
                                    <span class="badge ${task.type}">${task.type_display}</span>
                                </td>
                                <td style="font-size: 10px; color: #8892a6;">${task.oid}</td>
                                <td>
                                    <span class="interval-badge">${task.interval_raw}</span>
                                </td>
                                <td style="text-align: center; font-weight: bold; font-size: 14px;">
                                    ${task.executions_per_hour}x
                                </td>
                                <td>
                                    <span class="priority p${task.priority}">P${task.priority}</span>
                                </td>
                                <td class="time-cell">${task.next_run}</td>
                                <td>
                                    <span class="time-until ${task.time_class}">${task.time_until}</span>
                                </td>
                                <td>
                                    <div class="quota-bar">
                                        <div class="quota-fill ${
                                            task.quota.percentage >= 80 ? 'high' : 
                                            task.quota.percentage >= 50 ? 'medium' : 'low'
                                        }" style="width: ${task.quota.percentage}%">
                                            ${Math.round(task.quota.percentage)}%
                                        </div>
                                    </div>
                                    <div class="quota-text">${task.quota.completed}/${task.quota.required}</div>
                                </td>
                                <td>
                                    ${task.last_execution.time ? `
                                        <div class="time-cell">${task.last_execution.time}</div>
                                        <span class="status ${task.last_execution.status}">${task.last_execution.status}</span>
                                    ` : '<span style="color: #666; font-size: 10px;">Sin datos</span>'}
                                </td>
                                <td style="font-size: 10px; color: #8892a6;">
                                    ${task.last_execution.duration > 0 ? 
                                        (task.last_execution.duration / 1000).toFixed(1) + 's' : 
                                        '-'
                                    }
                                </td>
                            </tr>`;
                        });
                    });
                    
                    tbody.innerHTML = html;
                    
                    // Actualizar m茅tricas de estrategia
                    document.getElementById('collision-prevented').textContent = totalCollisions;
                    document.getElementById('tasks-sequenced').textContent = totalSequenced;
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('table-body').innerHTML = 
                        '<tr><td colspan="12" class="no-data">Error al cargar datos</td></tr>';
                });
        }
        
        // Actualizar dashboard cada 3 segundos
        updateDashboard();
        setInterval(updateDashboard, 3000);
    </script>
</body>
</html>
