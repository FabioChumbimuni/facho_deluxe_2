{% load static %}
<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Panel Airflow SNMP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #111827;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent: #38bdf8;
            --success: #22c55e;
            --warning: #facc15;
            --danger: #f87171;
            --border: #1f2937;
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #e2e8f0;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --accent: #0ea5e9;
            --success: #16a34a;
            --warning: #f59e0b;
            --danger: #dc2626;
            --border: #cbd5f5;
        }

        body {
            margin: 0;
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 2rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(56,189,248,0.2), rgba(14,165,233,0.05));
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
            letter-spacing: 0.05em;
        }

        main {
            flex: 1;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 1.5rem;
            padding: 1.5rem 2rem 2rem;
            align-items: start;
        }

        aside, .workflow-stage, .dashboard-stage, .legacy-stage {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 18px;
            box-shadow: 0 18px 42px rgba(8,47,73,0.35);
            padding: 1.5rem;
            overflow: hidden;
        }

        aside h2, .workflow-stage h2, .dashboard-stage h2, .legacy-stage h2 {
            margin-top: 0;
            font-size: 1.1rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .theme-toggle {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.6rem 1rem;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--accent);
            color: #0f172a;
        }

        .select,
        .input,
        .button-primary {
            width: 100%;
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: border 0.2s ease, box-shadow 0.2s ease;
        }

        .select:focus,
        .input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(56,189,248,0.25);
        }

        .button-primary {
            background: var(--accent);
            color: #0f172a;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }

        .button-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 16px 30px rgba(14,165,233,0.35);
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.7rem;
            border-radius: 999px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .pill.priority-1 { background: rgba(248,113,113,0.15); color: var(--danger); }
        .pill.priority-2 { background: rgba(250,204,21,0.15); color: var(--warning); }
        .pill.priority-3 { background: rgba(34,197,94,0.15); color: var(--success); }

        .workflow-grid {
            display: grid;
            gap: 1.2rem;
        }

        .demo-card {
            border-radius: 16px;
            padding: 1.1rem;
            border: 1px solid rgba(56,189,248,0.45);
            background: linear-gradient(135deg, rgba(14,165,233,0.18), rgba(15,23,42,0.35));
            margin-bottom: 1.2rem;
        }

        .legacy-card {
            border-radius: 16px;
            padding: 1.1rem;
            border: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(15,23,42,0.85), rgba(30,41,59,0.92));
        }

        [data-theme="light"] .legacy-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(226,232,240,0.95));
        }

        .legacy-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.8rem;
            font-size: 0.88rem;
        }

        .legacy-table th,
        .legacy-table td {
            padding: 0.55rem 0.75rem;
            border-bottom: 1px solid var(--border);
            text-align: left;
        }

        .legacy-table th {
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .legacy-table td .status-dot {
            display: inline-flex;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.4rem;
        }

        .status-enabled { background: var(--success); }
        .status-disabled { background: var(--danger); }

        .global-panel {
            margin: 0 2rem 2rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 1.5rem;
            box-shadow: 0 18px 42px rgba(8,47,73,0.35);
        }

        .global-panel header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .global-panel h2 {
            margin: 0;
            font-size: 1.2rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .global-search {
            max-width: 280px;
        }

        .global-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .global-table th,
        .global-table td {
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid var(--border);
            text-align: left;
        }

        .global-table th {
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .global-olt-row {
            background: rgba(56,189,248,0.08);
            font-weight: 600;
        }

        .global-empty {
            margin-top: 0.6rem;
            color: var(--text-secondary);
        }
        .workflow-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.2rem;
        }
        .dashboard-table, .events-list {
            width: 100%;
            border-collapse: collapse;
        }
        .dashboard-table th, .dashboard-table td {
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }
        .dashboard-table th {
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .events-list li {
            list-style: none;
            padding: 0.6rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.88rem;
        }
        .workflow-stage header {
            margin-bottom: 1rem;
        }
        .legacy-stage {
            margin-top: 1.5rem;
        }

        [data-theme="light"] .demo-card {
            background: linear-gradient(135deg, rgba(191,219,254,0.5), rgba(14,165,233,0.12));
        }

        .demo-card h3 {
            margin: 0 0 0.6rem 0;
            font-size: 1.05rem;
        }

        .demo-card ul {
            margin: 0.35rem 0 0.9rem 1rem;
            padding: 0;
            color: var(--text-secondary);
            font-size: 0.88rem;
        }

        .node-card {
            border-radius: 16px;
            padding: 1.1rem;
            border: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(15,23,42,0.85), rgba(30,41,59,0.92));
            position: relative;
            overflow: hidden;
        }

        .node-card.highlight {
            box-shadow: 0 0 0 2px var(--accent);
        }

        [data-theme="light"] .node-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(226,232,240,0.95));
        }

        .node-card h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }

        .node-card footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .edge-list {
            margin-top: 1.5rem;
            border-top: 1px solid var(--border);
            padding-top: 1.2rem;
        }

        .edge-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .edge-item:last-child {
            border-bottom: none;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.35rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
            letter-spacing: 0.04em;
        }

        .toolbar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .status-badge {
            padding: 0.25rem 0.6rem;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(56,189,248,0.18);
            color: var(--accent);
        }

        .tabs {
            display: flex;
            gap: 0.35rem;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        .tab-btn {
            border: none;
            border-bottom: 3px solid transparent;
            background: transparent;
            color: var(--text-secondary);
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: rgba(56, 189, 248, 0.1);
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            background: rgba(56, 189, 248, 0.1);
        }

        .tab-content {
            display: block;
        }

        .tab-content.hidden {
            display: none;
        }

        .hidden { 
            display: none !important; 
        }
        
        .modal.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }
        
        .modal:not(.hidden) {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .message {
            margin-top: 0.75rem;
            font-size: 0.9rem;
        }

        .message.success { color: var(--success); }
        .message.error { color: var(--danger); }
        
        /* Modal tipo Zabbix */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        /* Tabla tipo Zabbix */
        #templatesTable tbody tr {
            transition: background 0.15s ease;
        }
        
        #templatesTable tbody tr:hover {
            background: var(--bg-card);
        }
        
        #templatesTable tbody td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }
        
        #templatesTable tbody tr:last-child td {
            border-bottom: none;
        }
        
        .template-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .template-status.active {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }
        
        .template-status.inactive {
            background: rgba(107, 114, 128, 0.15);
            color: var(--text-secondary);
        }
        
        .template-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            min-width: 300px;
        }
        
        .template-actions button {
            padding: 0.5rem 0.875rem;
            font-size: 0.875rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 80px;
        }
        
        .template-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .template-actions button:active {
            transform: translateY(0);
        }
        
        /* Hacer la fila de plantilla m√°s interactiva */
        #templatesTable tbody tr {
            transition: background-color 0.2s ease;
        }
        
        #templatesTable tbody tr:hover {
            background-color: var(--bg-secondary);
        }
        
        #templatesTable tbody tr td {
            vertical-align: middle;
        }
    </style>
</head>
<body>
<header>
    <div>
        <h1>Airflow SNMP Coordinator</h1>
        <span class="status-badge">Workflows Din√°micos por OLT</span>
    </div>
    <button class="theme-toggle" id="themeToggle">Tema: Oscuro</button>
</header>

<main style="display: flex; flex-direction: column; gap: 1rem; padding: 1.5rem; max-width: 100%;">
    <!-- TOP SECTION: WORKFLOW Header -->
    <div style="background: white; padding: 2rem; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h1 style="margin: 0 0 1.5rem 0; font-size: 2rem; font-weight: 700; color: #1e293b;">WORKFLOW</h1>
        
        <!-- Action Buttons -->
        <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1.5rem;">
            <button class="button-primary" id="createWorkflowBtnTop" style="padding: 0.75rem 1.5rem; font-size: 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Crear Workflow
            </button>
            <button class="button-primary" id="createTemplateBtnTop" style="padding: 0.75rem 1.5rem; font-size: 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Crear Plantilla
            </button>
        </div>
        
        <!-- DATA Tabs -->
        <div style="display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 1rem; align-items: center;">
            <span style="font-weight: 600; color: #475569; margin-right: 0.5rem;">DATA:</span>
            <button class="data-tab-btn active" id="dataWorkflowTab" data-tab="workflow" style="padding: 0.5rem 1rem; background: #fbbf24; color: #1e293b; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                Workflow
            </button>
            <button class="data-tab-btn" id="dataPlantillaTab" data-tab="plantilla" style="padding: 0.5rem 1rem; background: #e2e8f0; color: #475569; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                Plantilla
            </button>
        </div>
        
        <!-- List Area -->
        <div id="dataListArea" style="background: white; border: 2px solid #e2e8f0; border-radius: 6px; min-height: 400px; padding: 1rem; text-align: left;">
            <div id="workflowListContent" class="data-content active">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f1f5f9; border-bottom: 2px solid #cbd5e1;">
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #1e293b;">OLT</th>
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #1e293b;">NODO</th>
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #1e293b;">PLANTILLA</th>
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #1e293b;">ESTADO</th>
                            <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #1e293b; width: 150px;">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody id="workflowListItems">
                        <!-- Los workflows se cargar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
            <div id="plantillaListContent" class="data-content" style="display: none;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f1f5f9; border-bottom: 2px solid #cbd5e1;">
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #1e293b;">PLANTILLA</th>
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #1e293b;">NODOS</th>
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #1e293b;">OLTs (ASIGNADOS)</th>
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #1e293b;">ESTADO</th>
                            <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #1e293b; width: 150px;">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody id="plantillaListItems">
                        <!-- Las plantillas se cargar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODALES: Ventanas que aparecen seg√∫n la acci√≥n seleccionada -->
    
    <!-- Modal: Crear Workflow -->
    <div id="createWorkflowModal" class="modal hidden" style="display: none !important; visibility: hidden !important;">
        <div class="modal-content" style="max-width: 600px; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: #1e293b;">Crear Workflow</h3>
                <button class="button-secondary" id="closeCreateWorkflowModal" style="padding: 0.25rem 0.75rem; font-size: 1.5rem; line-height: 1; background: transparent; border: none; cursor: pointer;">√ó</button>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569;">Host seleccionar: el host trae consigo (marca y modelo)</label>
                <select id="createWorkflowHostSelect" class="select" style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 4px; background: white;">
                    <option value="">Selecciona OLT‚Ä¶</option>
                    {% for olt in olts %}
                        <option value="{{ olt.id }}" data-marca="{{ olt.marca.nombre }}" data-modelo="{{ olt.modelo.nombre|default:'' }}">
                            {{ olt.abreviatura }} ({{ olt.ip_address }})
                        </option>
                    {% endfor %}
                </select>
                <div id="selectedHostInfo" style="margin-top: 0.5rem; padding: 0.5rem; background: #f1f5f9; border-radius: 4px; font-size: 0.875rem; color: #475569; display: none;">
                    <div><strong>Marca:</strong> <span id="selectedMarca">-</span></div>
                    <div><strong>Modelo:</strong> <span id="selectedModelo">-</span></div>
                </div>
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569;">Descripci√≥n:</label>
                <textarea id="createWorkflowDescription" style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 4px; min-height: 100px; resize: vertical; background: white; font-family: inherit;" placeholder="Descripci√≥n del workflow..."></textarea>
            </div>
            <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="button-secondary" id="cancelCreateWorkflowBtn" style="padding: 0.75rem 1.5rem;">Cancelar</button>
                <button class="button-primary" id="saveCreateWorkflowBtn" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Guardar Workflow</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Crear Nodo -->
    <div id="createNodeModal" class="modal hidden" style="display: none !important; visibility: hidden !important;">
        <div class="modal-content" style="max-width: 600px; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: #1e293b;">Crear Nodo</h3>
                <button class="button-secondary" id="closeCreateNodeModal" style="padding: 0.25rem 0.75rem; font-size: 1.5rem; line-height: 1; background: transparent; border: none; cursor: pointer;">√ó</button>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569;">OID: Validas de acuerdo a lo que escoge en host</label>
                <select id="createNodeOidSelect" class="select" style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 4px; background: white;">
                    <option value="">Selecciona OID‚Ä¶</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569;">Intervalo: Colocar n√∫mero en segundos, minutos u horas</label>
                <input id="createNodeIntervalInput" type="text" placeholder="Ej: 300s, 5m, 1h" style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 4px; background: white; font-family: inherit;">
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569;">Key (identificador √∫nico):</label>
                <input id="createNodeKeyInput" type="text" placeholder="Ej: discover.60min" style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 4px; background: white; font-family: inherit;">
            </div>
            <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="button-secondary" id="cancelCreateNodeBtn" style="padding: 0.75rem 1.5rem;">Cancelar</button>
                <button class="button-primary" id="saveCreateNodeBtn" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Crear Nodo+</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Modificar Nodo -->
    <div id="modifyNodeModal" class="modal hidden" style="display: none !important; visibility: hidden !important;">
        <div class="modal-content" style="max-width: 600px; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: #1e293b;">Modificar Nodo</h3>
                <button class="button-secondary" id="closeModifyNodeModal" style="padding: 0.25rem 0.75rem; font-size: 1.5rem; line-height: 1; background: transparent; border: none; cursor: pointer;">√ó</button>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569;">OID: Validas de acuerdo a lo que escoge en host</label>
                <select id="modifyNodeOidSelect" class="select" style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 4px; background: white;">
                    <option value="">Selecciona OID‚Ä¶</option>
                </select>
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569;">Intervalo: Colocar n√∫mero en segundos, minutos u horas</label>
                <input id="modifyNodeIntervalInput" type="text" placeholder="Ej: 300s, 5m, 1h" style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 4px; background: white; font-family: inherit;">
            </div>
            <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="button-secondary" id="cancelModifyNodeBtn" style="padding: 0.75rem 1.5rem;">Cancelar</button>
                <button class="button-primary" id="saveModifyNodeBtn" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Ver Nodos (aparece al hacer clic en Editar de un workflow) -->
    <div id="viewNodesModal" class="modal hidden" style="display: none !important; visibility: hidden !important;">
        <div class="modal-content" style="max-width: 800px; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: #1e293b;">Nodo: (presenta los nodos)</h3>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button class="button-primary" id="addNodeBtn" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.875rem;">Crear Nodo+</button>
                    <button class="button-secondary" id="closeViewNodesModal" style="padding: 0.25rem 0.75rem; font-size: 1.5rem; line-height: 1; background: transparent; border: none; cursor: pointer;">√ó</button>
                </div>
            </div>
            <div id="nodesListContainer" style="min-height: 200px; max-height: 500px; overflow-y: auto;">
                <!-- Los nodos se mostrar√°n aqu√≠ -->
            </div>
        </div>
    </div>

    <!-- Mantener el aside original pero oculto para funcionalidad existente -->
    <aside style="display: none;">
        <h2>Configuraci√≥n</h2>
        <div class="form-group">
            <label for="workflowSelector">Workflow / OLT</label>
            <select id="workflowSelector" class="select"></select>
        </div>
                    <option value="">Selecciona OLT‚Ä¶</option>
                    {% for olt in olts %}
                        <option value="{{ olt.id }}" data-marca="{{ olt.marca.nombre }}" data-modelo="{{ olt.modelo.nombre|default:'' }}">
                            {{ olt.abreviatura }} ({{ olt.ip_address }})
                        </option>
                    {% endfor %}
                </select>
                <div id="selectedHostInfo" style="margin-top: 0.5rem; padding: 0.5rem; background: #f1f5f9; border-radius: 4px; font-size: 0.875rem; color: #475569; display: none;">
                    <div><strong>Marca:</strong> <span id="selectedMarca">-</span></div>
                    <div><strong>Modelo:</strong> <span id="selectedModelo">-</span></div>
                </div>
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569; font-size: 0.9rem;">Descripci√≥n:</label>
                <textarea id="createWorkflowDescription" style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 4px; min-height: 100px; resize: vertical; background: white; font-family: inherit;" placeholder="Descripci√≥n del workflow..."></textarea>
            </div>
            <button class="button-primary" id="saveCreateWorkflowBtn" style="width: 100%; padding: 0.75rem; margin-top: 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Guardar Workflow
            </button>
        </div>
        
        <!-- Panel Centro: Crear Nodo -->
        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 1rem 0; font-size: 1.25rem; font-weight: 700; color: #1e293b;">Crear Nodo</h3>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569; font-size: 0.9rem;">OID: Validas de acuerdo a lo que escoge en host</label>
                <select id="createNodeOidSelect" class="select" style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 4px; background: white;">
                    <option value="">Selecciona OID‚Ä¶</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569; font-size: 0.9rem;">Intervalo: Colocar n√∫mero en segundos, minutos u horas</label>
                <input id="createNodeIntervalInput" type="text" placeholder="Ej: 300s, 5m, 1h" style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 4px; background: white; font-family: inherit;">
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569; font-size: 0.9rem;">Key (identificador √∫nico):</label>
                <input id="createNodeKeyInput" type="text" placeholder="Ej: discover.60min" style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 4px; background: white; font-family: inherit;">
            </div>
            <button class="button-primary" id="saveCreateNodeBtn" style="width: 100%; padding: 0.75rem; margin-top: 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Crear Nodo+
            </button>
        </div>
        
        <!-- Panel Derecho: Modificar Nodo -->
        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 1rem 0; font-size: 1.25rem; font-weight: 700; color: #1e293b;">Modificar Nodo</h3>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569; font-size: 0.9rem;">OID: Validas de acuerdo a lo que escoge en host</label>
                <select id="modifyNodeOidSelect" class="select" style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 4px; background: white;">
                    <option value="">Selecciona OID‚Ä¶</option>
                </select>
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569; font-size: 0.9rem;">Intervalo: Colocar n√∫mero en segundos, minutos u horas</label>
                <input id="modifyNodeIntervalInput" type="text" placeholder="Ej: 300s, 5m, 1h" style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 4px; background: white; font-family: inherit;">
            </div>
            <button class="button-primary" id="saveModifyNodeBtn" style="width: 100%; padding: 0.75rem; margin-top: 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Guardar Cambios
            </button>
        </div>
    </div>
    
    <!-- NODOS SECTION -->
    <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700; color: #1e293b;">Nodo: (presenta los nodos)</h3>
            <button class="button-primary" id="addNodeBtn" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.875rem;">
                Crear Nodo+
            </button>
        </div>
        <div id="nodesListContainer" style="min-height: 150px;">
            <!-- Los nodos se mostrar√°n aqu√≠ -->
        </div>
    </div>
    
    <!-- RIGHT SIDE: Ejecuciones y Dashboard -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 1rem 0; font-size: 1.25rem; font-weight: 700; color: #1e293b;">EJECUCIONES</h3>
            <div id="executionsContent" style="min-height: 200px; color: #475569;">
                <!-- Contenido de ejecuciones -->
            </div>
        </div>
        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 1rem 0; font-size: 1.25rem; font-weight: 700; color: #1e293b;">DASBOARD de las OLT con nodos pendientes</h3>
            <div id="dashboardContent" style="min-height: 200px; color: #475569;">
                <!-- Contenido del dashboard -->
            </div>
        </div>
    </div>
    
    <!-- OLT SELECTION SECTIONS -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div style="background: #3b82f6; padding: 1rem; border-radius: 8px; color: white;">
            <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; font-weight: 700;">OLT</h3>
            <div style="margin-bottom: 0.75rem; font-size: 0.9rem;">
                <div><strong>MARCA:</strong> <span id="selectedOltMarca">(Escogido)</span></div>
                <div><strong>MODELO:</strong> <span id="selectedOltModelo">(Escogido)</span></div>
            </div>
            <div id="selectedOltsList" style="display: flex; flex-direction: column; gap: 0.5rem;">
                <!-- OLTs seleccionados aparecer√°n aqu√≠ -->
            </div>
        </div>
        <div style="background: #3b82f6; padding: 1rem; border-radius: 8px; color: white;">
            <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; font-weight: 700;">Asignar OLT</h3>
            <p style="margin: 0 0 1rem 0; font-size: 0.875rem; opacity: 0.9;">Es obligatorio seleccionar antes en OLT para que aparezcan ac√° las OLT</p>
            <div id="assignOltsList" style="display: flex; flex-direction: column; gap: 0.5rem;">
                <!-- OLTs asignables aparecer√°n aqu√≠ -->
            </div>
        </div>
    </div>

    <!-- Mantener el aside original pero oculto para funcionalidad existente -->
    <aside style="display: none;">
        <h2>Configuraci√≥n</h2>

        {% if demo %}
            <div class="demo-card">
                <h3>Ejemplo cargado ¬∑ OLT {{ demo.olt.abreviatura }}</h3>
                <ul>
                    <li>Marca: {{ demo.olt.marca.nombre }}{% if demo.olt.modelo %} ¬∑ Modelo: {{ demo.olt.modelo.nombre }}{% endif %}</li>
                    <li>Tarea demo: {{ demo.template.name }} (prioridad 1 / {{ demo.template.default_interval_seconds }}‚ÄØs)</li>
                    <li>Funci√≥n Python: {{ demo.function.dotted_path }}</li>
                    {% if demo.oid_value %}
                        <li>OID descubrimiento: {{ demo.oid_value }}{% if demo.oid_name %} ¬∑ {{ demo.oid_name }}{% endif %}</li>
                    {% endif %}
                </ul>
                <button class="button-primary" id="demoWorkflowBtn"
                        data-workflow-id="{{ demo.workflow.id }}">
                    Abrir demo SMP-10
                </button>
            </div>
        {% endif %}

        <div class="form-group">
            <label for="workflowSelector">Workflow / OLT</label>
            <select id="workflowSelector" class="select"></select>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" id="multiOltMode" style="margin-right: 0.5rem;">
                Crear workflows para m√∫ltiples OLTs
            </label>
        </div>
        <div class="form-group" id="singleOltGroup">
            <label for="oltSelector">Crear workflow para OLT</label>
            <select id="oltSelector" class="select">
                <option value="">Selecciona OLT‚Ä¶</option>
                {% for olt in olts %}
                    <option value="{{ olt.id }}">{{ olt.abreviatura }} ({{ olt.ip_address }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group hidden" id="multiOltGroup">
            <label>Seleccionar OLTs (m√∫ltiple)</label>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;">
                {% for olt in olts %}
                    <label style="display: block; padding: 0.25rem 0; cursor: pointer;">
                        <input type="checkbox" class="olt-checkbox" value="{{ olt.id }}" style="margin-right: 0.5rem;">
                        {{ olt.abreviatura }} ({{ olt.ip_address }})
                    </label>
                {% endfor %}
            </div>
            <button type="button" class="button-secondary" id="selectAllOlts" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.875rem;">Seleccionar todas</button>
            <button type="button" class="button-secondary" id="deselectAllOlts" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.875rem;">Deseleccionar todas</button>
        </div>
        <button class="button-primary" id="createWorkflowBtn">Crear Workflow(s)</button>
        <div id="workflowMessage" class="message"></div>

        <hr style="border: none; border-top: 1px solid var(--border); margin: 1.5rem 0;">

        <!-- Pesta√±as para Plantillas -->
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid var(--border);">
            <button class="tab-btn active" id="templatesTabBtn" data-tab="templates">
                üìã Gestionar Plantillas
            </button>
            <button class="tab-btn" id="assignTabBtn" data-tab="assign">
                üîó Asignar a OLTs
            </button>
        </div>

        <!-- Secci√≥n: Gestionar Plantillas -->
        <div id="templatesSection" class="tab-content">
            <h2>üìã Plantillas (Tipo Zabbix)</h2>
            
            <!-- Bot√≥n para crear plantilla -->
            <div style="margin-bottom: 1rem;">
                <button class="button-primary" id="createTemplateBtn" style="padding: 0.5rem 1rem;">
                    ‚ûï Crear Nueva Plantilla
                </button>
            </div>
            
            <!-- Tabla de plantillas tipo Zabbix -->
            <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; overflow-x: auto;">
                <table id="templatesTable" style="width: 100%; border-collapse: collapse; min-width: 800px;">
                    <thead>
                        <tr style="background: var(--bg-secondary); border-bottom: 2px solid var(--border);">
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: var(--text-secondary);">Nombre</th>
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: var(--text-secondary);">Nodos</th>
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: var(--text-secondary);">OLTs</th>
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: var(--text-secondary);">Estado</th>
                            <th style="padding: 0.75rem; text-align: center; font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); min-width: 350px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="templatesTableBody">
                        <tr>
                            <td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                                Cargando plantillas...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Secci√≥n: Asignar Plantillas a OLTs -->
        <div id="assignSection" class="tab-content hidden">
            <h2>üîó Asignar Plantillas a OLTs</h2>
            
            <div style="margin-bottom: 1rem;">
                <button class="button-primary" id="applyTemplateBtn" style="padding: 0.5rem 1rem;">
                    üîó Asignar Plantilla a OLTs
                </button>
            </div>
            
            <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                <p style="color: var(--text-secondary); margin: 0;">
                    Selecciona una plantilla y las OLTs a las que deseas asignarla. Los nodos de la plantilla se vincular√°n autom√°ticamente a los workflows de las OLTs seg√∫n sus keys.
                </p>
            </div>
        </div>
        
        <!-- Formulario de creaci√≥n/edici√≥n de plantilla (modal tipo Zabbix) -->
        <div id="templateModal" class="modal hidden" style="display: none !important; visibility: hidden !important;">
            <div class="modal-content" style="max-width: 95%; max-height: 95vh; width: 1200px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
                    <h3 style="margin: 0; font-size: 1.5rem;" id="templateModalTitle">Crear Nueva Plantilla</h3>
                    <button class="button-secondary" id="closeTemplateModal" style="padding: 0.25rem 0.75rem; font-size: 1.5rem; line-height: 1;">√ó</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 2rem; max-height: calc(95vh - 200px); overflow-y: auto;">
                    <!-- Columna izquierda: Informaci√≥n b√°sica de la plantilla (M√ÅS GRANDE) -->
                    <div style="min-width: 0;">
                        <h4 style="margin-top: 0; margin-bottom: 1.5rem; font-size: 1.25rem; color: var(--text-primary); font-weight: 700;">üìã Informaci√≥n de la Plantilla</h4>
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label for="templateName" style="display: block; margin-bottom: 0.75rem; font-weight: 600; font-size: 1rem;">Nombre de la Plantilla *</label>
                            <input class="input" id="templateName" type="text" placeholder="Ej. Template Huawei MA5800 Discovery" style="width: 100%; padding: 1rem; font-size: 1rem;">
                        </div>
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label for="templateDescription" style="display: block; margin-bottom: 0.75rem; font-weight: 600; font-size: 1rem;">Descripci√≥n</label>
                            <textarea class="input" id="templateDescription" rows="6" placeholder="Descripci√≥n de la plantilla..." style="width: 100%; resize: vertical; padding: 1rem; font-size: 1rem; min-height: 150px;"></textarea>
                        </div>
                    </div>
                    
                    <!-- Columna derecha: Gesti√≥n de nodos/items -->
                    <div>
                        <h4 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem; color: var(--text-primary);">Nodos/Items de la Plantilla</h4>
                        
                        <!-- Lista de nodos existentes -->
                        <div id="templateNodesList" style="margin-bottom: 1.5rem; max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem;">
                            <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                                No hay nodos agregados a√∫n. Agrega el primero usando el formulario de abajo.
                            </div>
                        </div>
                        
                        <!-- Formulario para agregar nuevo nodo -->
                        <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 1rem;">
                            <h5 style="margin-top: 0; margin-bottom: 0.75rem; font-size: 1rem; color: var(--text-primary);">‚ûï Agregar Nuevo Nodo</h5>
                            <div class="form-group">
                                <label for="nodeKeyInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">Key ‚≠ê <span style="color: var(--text-secondary); font-weight: normal;">(√∫nica por plantilla)</span></label>
                                <input class="input" id="nodeKeyInput" type="text" placeholder="Ej. discover.60min, get.description.10min" style="width: 100%; padding: 0.5rem; font-size: 0.9rem;">
                                <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem; font-size: 0.85rem;">Identificador √∫nico del nodo (como keys en Zabbix)</small>
                            </div>
                            <div class="form-group">
                                <label for="nodeNameInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">Nombre del Nodo</label>
                                <input class="input" id="nodeNameInput" type="text" placeholder="Ej. Descubrimiento principal" style="width: 100%; padding: 0.5rem; font-size: 0.9rem;">
                            </div>
                            <div class="form-group">
                                <label for="nodeOidInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">OID ‚≠ê</label>
                                <select class="select" id="nodeOidInput" style="width: 100%; padding: 0.5rem; font-size: 0.9rem;">
                                    <option value="">Selecciona un OID‚Ä¶</option>
                                </select>
                                <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem; font-size: 0.85rem;">El OID define marca, modelo y tipo de operaci√≥n (descubrimiento o GET)</small>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                <div class="form-group">
                                    <label for="nodeIntervalInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">Intervalo (segundos)</label>
                                    <input class="input" id="nodeIntervalInput" type="number" min="10" step="5" placeholder="300" style="width: 100%; padding: 0.5rem; font-size: 0.9rem;">
                                </div>
                                <div class="form-group">
                                    <label for="nodePriorityInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">Prioridad</label>
                                    <select class="select" id="nodePriorityInput" style="width: 100%; padding: 0.5rem; font-size: 0.9rem;">
                                        <option value="1">1 - Discovery (Alta)</option>
                                        <option value="2">2 - GET cr√≠tico (Media)</option>
                                        <option value="3" selected>3 - GET est√°ndar (Baja)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="nodeEnabledInput" checked style="width: 18px; height: 18px;">
                                    <span style="font-weight: 600; font-size: 0.9rem;">Habilitado</span>
                                </label>
                            </div>
                            <button class="button-primary" id="addNodeToTemplateBtn" style="width: 100%; padding: 0.75rem; margin-top: 0.75rem;">‚ûï Agregar Nodo</button>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <button class="button-secondary" id="cancelTemplateBtn" style="padding: 0.75rem 1.5rem;">Cancelar</button>
                    <button class="button-primary" id="saveTemplateBtn" style="padding: 0.75rem 1.5rem;">Guardar Plantilla</button>
                </div>
                <div id="templateFormMessage" class="message" style="margin-top: 1rem;"></div>
            </div>
        </div>
        
        <!-- Modal de asignaci√≥n a OLTs tipo Zabbix -->
        <div id="assignModal" class="modal hidden">
            <div class="modal-content" style="max-width: 800px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
                    <h3 style="margin: 0; font-size: 1.25rem;">Asignar Plantilla a OLTs</h3>
                    <button class="button-secondary" id="closeAssignModal" style="padding: 0.25rem 0.75rem; font-size: 1.25rem; line-height: 1;">√ó</button>
                </div>
                <div class="form-group">
                    <label for="applyTemplateSelect" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Seleccionar Plantilla *</label>
                    <select id="applyTemplateSelect" class="select" style="width: 100%;">
                        <option value="">Selecciona una plantilla‚Ä¶</option>
                    </select>
                </div>
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label style="font-weight: 600;">Seleccionar OLTs</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="button-secondary" id="selectAllApplyOlts" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">Seleccionar todas</button>
                            <button type="button" class="button-secondary" id="deselectAllApplyOlts" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">Deseleccionar todas</button>
                        </div>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-card);">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 10;">
                                <tr>
                                    <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); width: 40px;">
                                        <input type="checkbox" id="selectAllOltsInModal" style="cursor: pointer;">
                                    </th>
                                    <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: var(--text-secondary);">OLT</th>
                                    <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: var(--text-secondary);">IP</th>
                                    <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: var(--text-secondary);">Marca</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.875rem; font-weight: 600; color: var(--text-secondary);">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="oltsTableBody">
                                {% for olt in olts %}
                                <tr style="border-bottom: 1px solid var(--border);" data-olt-id="{{ olt.id }}">
                                    <td style="padding: 0.75rem;">
                                        <input type="checkbox" class="apply-olt-checkbox" value="{{ olt.id }}" style="cursor: pointer;">
                                    </td>
                                    <td style="padding: 0.75rem; font-weight: 500;">{{ olt.abreviatura }}</td>
                                    <td style="padding: 0.75rem; color: var(--text-secondary); font-family: monospace;">{{ olt.ip_address }}</td>
                                    <td style="padding: 0.75rem; color: var(--text-secondary);">{{ olt.marca.nombre }}</td>
                                    <td style="padding: 0.75rem; text-align: center;">
                                        {% if olt.habilitar_olt %}
                                            <span style="color: var(--success);">‚óè</span>
                                        {% else %}
                                            <span style="color: var(--text-secondary);">‚óã</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="applyAutoSync" checked>
                        <span style="font-weight: 600;">Auto-sincronizar cambios</span>
                    </label>
                    <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem; margin-left: 1.75rem;">
                        Los cambios en la plantilla se propagan autom√°ticamente a los workflows vinculados
                    </small>
                </div>
                <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <button class="button-secondary" id="cancelApplyBtn">Cancelar</button>
                    <button class="button-primary" id="doApplyTemplateBtn">Asignar Plantilla</button>
                </div>
                <div id="applyTemplateMessage" class="message" style="margin-top: 1rem;"></div>
            </div>
        </div>

    </aside>

    <div class="workflow-layout">
        <section class="workflow-stage">
            <header class="toolbar">
                <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                    <h2 id="workflowTitle" style="margin: 0;">Selecciona un workflow</h2>
                    <span id="workflowStatus" class="status-badge hidden">Activo</span>
                </div>
                <button id="deleteWorkflowBtn" class="button-secondary" style="display: none; padding: 0.5rem 1rem; background: #ef4444; color: white; border-color: #ef4444;" title="Eliminar este workflow">
                    üóëÔ∏è Eliminar Workflow
                </button>
            </header>

            <div class="tabs">
                <button class="tab-btn active" data-tab="nodesTab">Nodos</button>
                <button class="tab-btn" data-tab="edgesTab">Dependencias</button>
                <button class="tab-btn" data-tab="metaTab">Metadatos</button>
            </div>

            <div id="nodesTab" class="workflow-grid">
                <div class="node-card" style="border-style: dashed; text-align: center; padding: 1.8rem; background: transparent;">
                    <h3 style="margin-bottom: 0.6rem;">A√±adir nodo</h3>
                    {% if not selectedWorkflow %}
                    <div style="background: var(--warning-bg, rgba(251,191,36,0.1)); border: 1px solid var(--warning-border, rgba(251,191,36,0.3)); border-radius: 4px; padding: 0.75rem; margin-bottom: 1rem;">
                        <p style="margin: 0; color: var(--warning-text, #f59e0b); font-size: 0.875rem;">
                            ‚ö†Ô∏è <strong>Primero selecciona un workflow</strong> en el dropdown superior para agregar nodos.
                        </p>
                    </div>
                    {% endif %}
                    <div class="form-group">
                        <label for="nodeKey">Key ‚≠ê <span style="color: var(--text-secondary); font-weight: normal;">(requerida)</span></label>
                        <input class="input" id="nodeKey" type="text" placeholder="Ej. discover.60min, get.description.10min">
                        <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">
                            Identificador √∫nico del nodo (como keys en Zabbix). Si coincide con una key de plantilla vinculada, se vincular√° autom√°ticamente.
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="nodeName">Nombre del nodo</label>
                        <input class="input" id="nodeName" type="text" placeholder="Ej. Descubrimiento principal">
                        <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">Nombre descriptivo para esta tarea en el workflow</small>
                    </div>
                    <div class="form-group">
                        <label for="nodeTemplate">
                            Plantilla ‚≠ê <span style="color: var(--text-secondary); font-weight: normal;">(requerida)</span>
                        </label>
                        <select id="nodeTemplate" class="select">
                            <option value="">Selecciona una plantilla‚Ä¶</option>
                            {% for tpl in templates %}
                                <option value="{{ tpl.id }}"
                                        data-interval="{{ tpl.default_interval_seconds }}"
                                        data-priority="{{ tpl.default_priority }}"
                                        data-snmp-job="{% if tpl.snmp_job %}{{ tpl.snmp_job.id }}{% endif %}"
                                        data-snmp-name="{% if tpl.snmp_job %}{{ tpl.snmp_job.nombre }}{% endif %}">
                                    {{ tpl.name }} ({{ tpl.function.function_type }}){% if tpl.snmp_job %} ¬∑ {{ tpl.snmp_job.nombre }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">
                            La plantilla define <strong>qu√© funci√≥n ejecutar</strong>. Al seleccionar una, se llenan autom√°ticamente intervalo y prioridad sugeridos.
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="nodeInterval">Intervalo (segundos)</label>
                        <input class="input" id="nodeInterval" type="number" min="10" step="5" placeholder="Se llena autom√°ticamente al seleccionar plantilla">
                        <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">Cada cu√°ntos segundos se ejecutar√° esta tarea</small>
                    </div>
                    <div class="form-group">
                        <label for="nodePriority">Prioridad</label>
                        <select class="select" id="nodePriority">
                            <option value="1">1 - Discovery (Alta)</option>
                            <option value="2">2 - GET cr√≠tico (Media)</option>
                            <option value="3" selected>3 - GET est√°ndar (Baja)</option>
                        </select>
                        <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">Se ajusta autom√°ticamente seg√∫n la plantilla seleccionada</small>
                    </div>
                    <button class="button-primary" id="createNodeBtn" {% if not selectedWorkflow %}disabled title="Selecciona un workflow primero"{% endif %}>Agregar nodo</button>
                    <div id="nodeMessage" class="message"></div>
                </div>

                <div id="nodesContainer" class="workflow-grid"></div>
            </div>

            <div id="edgesTab" class="workflow-grid hidden">
                <div class="node-card" style="border-style: dashed;">
                    <h3 style="margin-bottom: 0.6rem;">Crear dependencia</h3>
                    <div class="form-group">
                        <label for="edgeUpstream">Nodo anterior</label>
                        <select class="select" id="edgeUpstream"></select>
                    </div>
                    <div class="form-group">
                        <label for="edgeDownstream">Nodo siguiente</label>
                        <select class="select" id="edgeDownstream"></select>
                    </div>
                    <div class="form-group">
                        <label for="edgeType">Tipo</label>
                        <select class="select" id="edgeType">
                            <option value="secuencial">Secuencial</option>
                            <option value="condicional">Condicional</option>
                        </select>
                    </div>
                    <button class="button-primary" id="createEdgeBtn">Crear dependencia</button>
                    <div id="edgeMessage" class="message"></div>
                </div>

                <div class="edge-list" id="edgesContainer"></div>
            </div>

            <div id="metaTab" class="workflow-grid hidden">
                <div class="node-card">
                    <h3>Metadatos & configuraci√≥n</h3>
                    <p style="margin-bottom: 1.2rem; color: var(--text-secondary);">Pr√≥ximamente: layout manual, marcadores y exportaci√≥n.</p>
                    <div class="form-group">
                        <label for="workflowTheme">Tema del workflow</label>
                        <select class="select" id="workflowTheme">
                            <option value="auto">Autom√°tico</option>
                            <option value="light">Claro</option>
                            <option value="dark">Oscuro</option>
                        </select>
                    </div>
                    <button class="button-primary" id="saveWorkflowMeta">Guardar cambios</button>
                    <div id="metaMessage" class="message"></div>
                </div>
            </div>
        </section>

        <div>
            <section class="dashboard-stage">
                <h2>Dashboard de ejecuciones</h2>
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th>Nodo</th>
                            <th>Estado</th>
                            <th>√öltima ejecuci√≥n</th>
                            <th>Pr√≥xima ejecuci√≥n</th>
                            <th>Intentos</th>
                            <th>Duraci√≥n promedio</th>
                        </tr>
                    </thead>
                    <tbody id="executionTableBody">
                        <tr>
                            <td colspan="6" style="text-align:center; padding:0.8rem;" id="executionTableEmpty">
                                Conecta un workflow para ver estad√≠sticas en vivo.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section class="dashboard-stage" style="margin-top:1.5rem;">
                <h2>Eventos recientes</h2>
                <ul class="events-list" id="executionEvents">
                    <li style="color: var(--text-secondary);">Sin eventos recientes.</li>
                </ul>
            </section>

            <section class="legacy-stage">
                <h2>Control legacy (SnmpJob)</h2>
                <p id="legacyJobsEmpty" style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;"></p>
                <table class="legacy-table hidden" id="legacyJobsTable">
                    <thead>
                        <tr>
                            <th>Tarea</th>
                            <th>Tipo</th>
                            <th>Intervalo</th>
                            <th>Pr√≥xima ejecuci√≥n</th>
                            <th>Estado</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="legacyJobsBody"></tbody>
                </table>
            </section>
        </div>
    </div>
</main>
</main>

<section class="global-panel">
    <header>
        <h2>Resumen global de tareas por OLT</h2>
        <input class="input global-search" id="globalSearch" type="text" placeholder="Filtrar por OLT o tarea">
    </header>
    <table class="global-table" id="globalJobsTable">
        <thead>
            <tr>
                <th>OLT</th>
                <th>Tarea</th>
                <th>Tipo</th>
                <th>Intervalo</th>
                <th>Pr√≥xima ejecuci√≥n</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody id="globalJobsBody"></tbody>
    </table>
    <p class="global-empty" id="globalJobsEmpty"></p>
</section>

<script>
    // Esperar a que el DOM est√© completamente cargado
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM cargado, inicializando...');
        
        // Variables globales
        let workflows = [];
        let selectedWorkflow = null;
        let globalJobs = [];
        let pendingHighlightNodeId = null;
        let selectedTemplateId = null;
        let templateNodes = [];
        
        const themeToggle = document.getElementById('themeToggle');
        const rootHtml = document.documentElement;
        let currentTheme = localStorage.getItem('workflow-theme') || 'dark';
        rootHtml.setAttribute('data-theme', currentTheme);
        if (themeToggle) {
            themeToggle.textContent = `Tema: ${currentTheme === 'dark' ? 'Oscuro' : 'Claro'}`;
            themeToggle.addEventListener('click', () => {
                currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
                rootHtml.setAttribute('data-theme', currentTheme);
                localStorage.setItem('workflow-theme', currentTheme);
                themeToggle.textContent = `Tema: ${currentTheme === 'dark' ? 'Oscuro' : 'Claro'}`;
            });
        }

        // Obtener referencias a elementos del DOM
        const workflowSelector = document.getElementById('workflowSelector');
        const oltSelector = document.getElementById('oltSelector');
        const workflowTitle = document.getElementById('workflowTitle');
        const workflowStatus = document.getElementById('workflowStatus');
        const deleteWorkflowBtn = document.getElementById('deleteWorkflowBtn');
        const workflowMessage = document.getElementById('workflowMessage');
        const nodeMessage = document.getElementById('nodeMessage');
        const edgeMessage = document.getElementById('edgeMessage');
        const metaMessage = document.getElementById('metaMessage');

        const nodeNameInput = document.getElementById('nodeName');
        const nodeTemplateSelect = document.getElementById('nodeTemplate');
        const nodeIntervalInput = document.getElementById('nodeInterval');
        const nodePrioritySelect = document.getElementById('nodePriority');
        const nodesContainer = document.getElementById('nodesContainer');
        const edgesContainer = document.getElementById('edgesContainer');
        const edgeUpstreamSelect = document.getElementById('edgeUpstream');
        const edgeDownstreamSelect = document.getElementById('edgeDownstream');
        const edgeTypeSelect = document.getElementById('edgeType');
        const workflowThemeSelect = document.getElementById('workflowTheme');
        const legacyJobsEmpty = document.getElementById('legacyJobsEmpty');
        const legacyJobsTable = document.getElementById('legacyJobsTable');
        const legacyJobsBody = document.getElementById('legacyJobsBody');
        const globalJobsTable = document.getElementById('globalJobsTable');
        const globalJobsBody = document.getElementById('globalJobsBody');
        const globalJobsEmpty = document.getElementById('globalJobsEmpty');
        const globalSearchInput = document.getElementById('globalSearch');

        // workflows, selectedWorkflow, globalJobs, pendingHighlightNodeId ya est√°n declaradas arriba

        // Funciones auxiliares
        function csrfToken() {
            const name = 'csrftoken=';
            const decoded = decodeURIComponent(document.cookie || '');
            const parts = decoded.split(';');
            for (let part of parts) {
                part = part.trim();
                if (part.indexOf(name) === 0) return part.substring(name.length, part.length);
            }
            return '';
        }

        function apiFetch(url, options = {}) {
            return fetch(url, {
                credentials: 'same-origin',
                ...options,
            });
        }

    function setMessage(element, message, type = 'success') {
        if (!element) {
            console.error('setMessage: elemento no encontrado, usando alert como fallback');
            alert(message);
            return;
        }
        element.textContent = message;
        element.classList.remove('success', 'error');
        element.classList.add(type);
        if (message) {
            setTimeout(() => {
                if (element) {
                    element.textContent = '';
                    element.classList.remove(type);
                }
            }, 3500);
        }
    }

    function formatInterval(seconds) {
        if (!seconds) return '‚Äî';
        if (seconds < 60) return `${seconds}s`;
        const minutes = Math.floor(seconds / 60);
        const remainder = seconds % 60;
        if (!remainder) return `${minutes}m`;
        return `${minutes}m ${remainder}s`;
    }

    function renderLegacyJobs(jobs, oltId) {
        legacyJobsBody.innerHTML = '';
        if (!jobs.length) {
            legacyJobsTable.classList.add('hidden');
            legacyJobsEmpty.textContent = 'Esta OLT no tiene tareas legacy asignadas.';
            return;
        }
        legacyJobsEmpty.textContent = '';
        legacyJobsTable.classList.remove('hidden');
        jobs.forEach(job => {
            const tr = document.createElement('tr');
            const statusClass = job.enabled ? 'status-enabled' : 'status-disabled';
            const buttonEnabled = job.host_enabled;
            const canCreateNode = Boolean(
                job.template_id &&
                selectedWorkflow &&
                selectedWorkflow.olt_id === oltId &&
                !(selectedWorkflow.nodes || []).some(n => n.template_id === job.template_id)
            );
            const createNodeButton = canCreateNode
                ? `<button class="toggle-btn legacy-create-node" data-job-host-id="${job.id}">Agregar al workflow</button>`
                : '';
            const metaInfo = job.template_id ? '' : '<small style="color: var(--text-secondary); display:block; margin-top:0.35rem;">Sin plantilla asociada al SnmpJob.</small>';
            tr.innerHTML = `
                <td>${job.name}</td>
                <td>${job.job_type || '‚Äî'}</td>
                <td>${formatInterval(job.interval_seconds)}</td>
                <td>${job.next_run_at ? formatDateTime(job.next_run_at) : 'No programado'}</td>
                <td><span class="status-dot ${statusClass}"></span>${job.enabled ? 'Activo' : 'Inactivo'}</td>
                <td>
                    <div style="display:flex; gap:0.4rem; flex-wrap:wrap;">
                        <button class="theme-toggle legacy-toggle" data-enabled="${buttonEnabled ? '1' : '0'}">
                            ${buttonEnabled ? 'Desactivar' : 'Activar'}
                        </button>
                        ${createNodeButton}
                    </div>
                    ${metaInfo}
                </td>
            `;
            tr.dataset.jobHostId = job.id;
            tr.dataset.oltId = oltId;
            tr.dataset.templateId = job.template_id || '';
            legacyJobsBody.appendChild(tr);
        });
    }

    async function loadLegacyJobs(oltId) {
        if (!oltId) {
            legacyJobsBody.innerHTML = '';
            legacyJobsTable.classList.add('hidden');
            legacyJobsEmpty.textContent = '';
            return;
        }
        try {
            const response = await apiFetch(`/snmp_jobs/api/olts/${oltId}/legacy-jobs/`);
            if (!response.ok) {
                legacyJobsBody.innerHTML = '';
                legacyJobsTable.classList.add('hidden');
                legacyJobsEmpty.textContent = 'No se pudieron obtener las tareas legacy.';
                return;
            }
            const data = await response.json();
            renderLegacyJobs(data.jobs || [], oltId);
        } catch (error) {
            legacyJobsBody.innerHTML = '';
            legacyJobsTable.classList.add('hidden');
            legacyJobsEmpty.textContent = 'Error de conexi√≥n al listar tareas legacy.';
        }
    }

    async function toggleLegacyJob(jobHostId, enabled) {
        if (!selectedWorkflow) {
            setMessage(workflowMessage, 'Selecciona un workflow primero.', 'error');
            return;
        }
        try {
            const response = await apiFetch(`/snmp_jobs/api/olts/${selectedWorkflow.olt_id}/legacy-jobs/${jobHostId}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken(),
                },
                body: JSON.stringify({ enabled }),
            });
            if (!response.ok) {
                const text = await response.text();
                setMessage(workflowMessage, text || 'No se pudo actualizar la tarea legacy.', 'error');
                return;
            }
            await loadLegacyJobs(selectedWorkflow.olt_id);
            await loadGlobalLegacyJobs();
            setMessage(workflowMessage, `Tarea legacy ${enabled ? 'activada' : 'desactivada'}.`);
        } catch (error) {
            setMessage(workflowMessage, 'Error al actualizar la tarea legacy.', 'error');
        }
    }

    async function toggleNode(nodeId, enabled) {
        if (!selectedWorkflow) return;
        try {
            const response = await apiFetch(`/snmp_jobs/api/workflows/${selectedWorkflow.id}/nodes/${nodeId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken(),
                },
                body: JSON.stringify({ enabled }),
            });
            if (!response.ok) {
                const text = await response.text();
                setMessage(nodeMessage, text || 'No se pudo actualizar el nodo.', 'error');
                return;
            }
            setMessage(nodeMessage, `Nodo ${enabled ? 'activado' : 'desactivado'}.`);
            await selectWorkflow(selectedWorkflow.id);
        } catch (error) {
            setMessage(nodeMessage, 'Error al actualizar el nodo.', 'error');
        }
    }

    async function createNodeFromLegacy(jobHostId, oltId) {
        if (!selectedWorkflow) {
            setMessage(workflowMessage, 'Selecciona un workflow primero.', 'error');
            return;
        }
        if (String(selectedWorkflow.olt_id) !== String(oltId)) {
            setMessage(workflowMessage, 'La tarea legacy pertenece a otra OLT.', 'error');
            return;
        }
        try {
            const response = await apiFetch(`/snmp_jobs/api/workflows/${selectedWorkflow.id}/nodes/from-job/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken(),
                },
                body: JSON.stringify({ job_host_id: parseInt(jobHostId, 10) }),
            });
            if (!response.ok) {
                const text = await response.text();
                setMessage(workflowMessage, text || 'No se pudo crear el nodo a partir de la tarea legacy.', 'error');
                return;
            }
            const data = await response.json();
            const nodeId = data.node ? data.node.id : null;
            setMessage(workflowMessage, data.created ? 'Nodo agregado desde la tarea legacy.' : 'Nodo ya exist√≠a y fue reactivado.');
            pendingHighlightNodeId = nodeId;
            await selectWorkflow(selectedWorkflow.id, { highlightNodeId: nodeId });
            await loadGlobalLegacyJobs();
        } catch (error) {
            setMessage(workflowMessage, 'Error al crear nodo desde tarea legacy.', 'error');
        }
    }

    function renderGlobalLegacyJobs(filterText = '') {
        globalJobsBody.innerHTML = '';
        const query = (filterText || '').trim().toLowerCase();
        const matchesFilter = (oltName, jobName) => {
            if (!query) return true;
            return oltName.toLowerCase().includes(query) || jobName.toLowerCase().includes(query);
        };

        let rows = 0;
        globalJobs.forEach(group => {
            let firstRow = true;
            group.jobs.forEach(job => {
                if (!matchesFilter(group.olt_name, job.name)) {
                    return;
                }
                const tr = document.createElement('tr');
                if (firstRow) {
                    tr.classList.add('global-olt-row');
                }
                tr.innerHTML = `
                    <td>${firstRow ? group.olt_name : ''}</td>
                    <td>${job.name}</td>
                    <td>${(job.job_type || '‚Äî').toUpperCase()}</td>
                    <td>${formatInterval(job.interval_seconds)}</td>
                    <td>${job.next_run_at ? formatDateTime(job.next_run_at) : 'No programado'}</td>
                    <td>${job.enabled ? 'Activo' : 'Inactivo'}</td>
                `;
                globalJobsBody.appendChild(tr);
                firstRow = false;
                rows += 1;
            });
        });

        if (!rows) {
            globalJobsEmpty.textContent = query ? 'Sin coincidencias para el filtro.' : 'A√∫n no hay tareas asignadas a las OLTs.';
        } else {
            globalJobsEmpty.textContent = '';
        }
    }

    async function loadGlobalLegacyJobs() {
        try {
            const response = await apiFetch('/snmp_jobs/api/legacy-jobs/');
            if (!response.ok) {
                globalJobs = [];
                renderGlobalLegacyJobs(globalSearchInput.value);
                globalJobsEmpty.textContent = 'No se pudo cargar el resumen global.';
                return;
            }
            const data = await response.json();
            globalJobs = data.olts || [];
            renderGlobalLegacyJobs(globalSearchInput.value);
        } catch (error) {
            globalJobs = [];
            renderGlobalLegacyJobs(globalSearchInput.value);
            globalJobsEmpty.textContent = 'Error de conexi√≥n al cargar el resumen global.';
        }
    }

    async function loadWorkflows() {
        const response = await apiFetch('/snmp_jobs/api/workflows/');
        const data = await response.json();
        workflows = data.workflows || [];

        // Filtrar solo workflows que tienen nodos creados
        const workflowsWithNodes = workflows.filter(wf => wf.nodes && wf.nodes.length > 0);

        workflowSelector.innerHTML = '<option value="">Selecciona workflow‚Ä¶</option>';
        const currentId = selectedWorkflow ? selectedWorkflow.id : null;
        let desiredId = null;
        let demoId = null;
        let firstRealId = null;

        workflowsWithNodes.forEach(wf => {
            const option = document.createElement('option');
            option.value = wf.id;
            const nodeCount = wf.nodes ? wf.nodes.length : 0;
            option.textContent = `${wf.olt_name || 'OLT'} - ${wf.name} (${nodeCount} nodo${nodeCount !== 1 ? 's' : ''})`;
            workflowSelector.appendChild(option);
            const isDemo = wf.layout && (wf.layout.demo || wf.layout.demo === true);
            if (!demoId && isDemo) {
                demoId = wf.id;
            }
            if (!isDemo && !firstRealId) {
                firstRealId = wf.id;
            }
        });

        // Solo auto-seleccionar si hay un workflow seleccionado actualmente y sigue existiendo
        // NO auto-seleccionar al cargar inicialmente para evitar crear workflows autom√°ticamente
        if (currentId && workflows.some(wf => wf.id === currentId)) {
            desiredId = currentId;
        }
        // NO auto-seleccionar el primer workflow al cargar para evitar crear workflows autom√°ticamente
        // else if (firstRealId) {
        //     desiredId = firstRealId;
        // } else if (demoId) {
        //     desiredId = demoId;
        // } else if (workflows.length) {
        //     desiredId = workflows[0].id;
        // }

        if (desiredId) {
            workflowSelector.value = desiredId;
            workflowSelector.dispatchEvent(new Event('change'));
        }
    }

    function renderWorkflow(workflow) {
        selectedWorkflow = workflow;
        const isDemo = workflow.layout && (workflow.layout.demo || workflow.layout.demo === true);
        workflowTitle.textContent = `${workflow.olt_name || 'OLT'} ¬∑ ${workflow.name}${isDemo ? ' (Demo)' : ''}`;
        workflowStatus.classList.remove('hidden');
        workflowStatus.textContent = `${workflow.is_active ? 'Activo' : 'Inactivo'} ¬∑ ${workflow.nodes.length} nodo(s)`;
        workflowThemeSelect.value = workflow.theme || 'auto';
        
        // Mostrar bot√≥n de eliminar solo si no es demo
        if (deleteWorkflowBtn) {
            deleteWorkflowBtn.style.display = isDemo ? 'none' : 'block';
        }
        
        if (isDemo) {
            setMessage(workflowMessage, 'Est√°s viendo el workflow demo. Selecciona el flujo real para operar tareas productivas.', 'error');
        } else {
            setMessage(workflowMessage, 'Workflow cargado.', 'success');
        }

        nodesContainer.innerHTML = '';
        workflow.nodes.forEach(node => {
            const card = document.createElement('div');
            card.className = 'node-card';
            card.style.borderColor = node.color;
            const nextRun = node.next_run_at ? new Date(node.next_run_at).toLocaleString() : 'No programado';
            const lastRun = node.last_run_at ? new Date(node.last_run_at).toLocaleString() : 'Nunca';
            const toggleLabel = node.enabled ? 'Desactivar nodo' : 'Activar nodo';
            // Indicador de nodo vinculado a plantilla
            const templateBadge = node.template_node_id ? 
                `<span style="background: rgba(59,130,246,0.2); color: #3b82f6; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;" title="Vinculado a plantilla">üîó ${node.template_node_key || 'Plantilla'}</span>` : 
                '<span style="background: rgba(107,114,128,0.2); color: #6b7280; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">Custom</span>';
            
            // Indicadores de override
            const overrideBadges = [];
            if (node.override_interval) overrideBadges.push('‚è±Ô∏è Intervalo');
            if (node.override_priority) overrideBadges.push('‚ö° Prioridad');
            if (node.override_enabled) overrideBadges.push('üîí Estado');
            if (node.override_parameters) overrideBadges.push('‚öôÔ∏è Par√°metros');
            const overrideText = overrideBadges.length > 0 ? 
                `<small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">Override: ${overrideBadges.join(', ')}</small>` : '';
            
            card.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;gap:0.5rem;">
                    <h3>${node.icon ? node.icon + ' ' : ''}${node.name}${templateBadge}</h3>
                    <span class="pill priority-${node.priority}">P${node.priority}</span>
                </div>
                <p style="color:var(--text-secondary);margin:0.4rem 0 0.6rem;">
                    ${node.template_name} ¬∑ ${node.function_type.toUpperCase()}<br>
                    Key: <code style="background: rgba(0,0,0,0.1); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.85em;">${node.key || 'sin-key'}</code><br>
                    Intervalo: ${node.interval_seconds}s${overrideText}<br>
                    Pr√≥xima ejecuci√≥n: ${nextRun}<br>
                    √öltima ejecuci√≥n: ${lastRun}
                </p>
                <footer style="display:flex; gap:0.5rem;">
                    <span style="flex:1;">${node.enabled ? 'üîì habilitado' : 'üîí deshabilitado'} | fallos: ${node.consecutive_failures}</span>
                    <button class="theme-toggle node-edit" data-node="${node.id}" style="padding:0.35rem 0.8rem;" title="Editar nodo">‚úèÔ∏è Editar</button>
                    <button class="theme-toggle node-toggle" data-node="${node.id}" data-enabled="${node.enabled ? '1' : '0'}" style="padding:0.35rem 0.8rem;">
                        ${toggleLabel}
                    </button>
                    <button class="theme-toggle node-delete" data-node="${node.id}" style="padding:0.35rem 0.8rem;">Eliminar</button>
                </footer>
            `;
            card.querySelector('.node-delete').addEventListener('click', () => deleteNode(node.id));
            card.querySelector('.node-toggle').addEventListener('click', () => toggleNode(node.id, !node.enabled));
            card.querySelector('.node-edit').addEventListener('click', () => editWorkflowNode(node));
            nodesContainer.appendChild(card);

            if (pendingHighlightNodeId && node.id === pendingHighlightNodeId) {
                card.classList.add('highlight');
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => {
                    card.classList.remove('highlight');
                }, 2500);
            }
        });
        pendingHighlightNodeId = null;

        edgesContainer.innerHTML = '';
        workflow.edges.forEach(edge => {
            const upstream = workflow.nodes.find(n => n.id === edge.upstream_id);
            const downstream = workflow.nodes.find(n => n.id === edge.downstream_id);
            const div = document.createElement('div');
            div.className = 'edge-item';
            div.innerHTML = `
                <span>${upstream ? upstream.name : '??'} ‚ûú ${downstream ? downstream.name : '??'} (${edge.edge_type})</span>
                <button class="theme-toggle" data-edge="${edge.id}" style="padding:0.35rem 0.8rem;">Eliminar</button>
            `;
            div.querySelector('button').addEventListener('click', () => deleteEdge(edge.id));
            edgesContainer.appendChild(div);
        });

        const options = workflow.nodes.map(node => `<option value="${node.id}">${node.name}</option>`).join('');
        edgeUpstreamSelect.innerHTML = `<option value="">Selecciona nodo‚Ä¶</option>${options}`;
        edgeDownstreamSelect.innerHTML = `<option value="">Selecciona nodo‚Ä¶</option>${options}`;

        if (isDemo) {
            legacyJobsBody.innerHTML = '';
            legacyJobsTable.classList.add('hidden');
            legacyJobsEmpty.textContent = 'El workflow demo no tiene tareas legacy asociadas. Selecciona un workflow real para gestionarlas.';
        } else {
            loadLegacyJobs(workflow.olt_id);
        }
    }

    async function createWorkflow() {
        const multiMode = document.getElementById('multiOltMode').checked;
        let oltIds = [];
        
        if (multiMode) {
            // Modo m√∫ltiple: obtener todas las OLTs seleccionadas
            const checkboxes = document.querySelectorAll('.olt-checkbox:checked');
            oltIds = Array.from(checkboxes).map(cb => parseInt(cb.value, 10));
            if (oltIds.length === 0) {
                setMessage(workflowMessage, 'Selecciona al menos una OLT.', 'error');
                return;
            }
        } else {
            // Modo simple: una sola OLT
            const oltId = oltSelector.value;
            if (!oltId) {
                setMessage(workflowMessage, 'Selecciona una OLT.', 'error');
                return;
            }
            oltIds = [parseInt(oltId, 10)];
        }
        
        // Confirmar creaci√≥n m√∫ltiple
        if (multiMode && oltIds.length > 1) {
            if (!confirm(`¬øCrear workflows para ${oltIds.length} OLTs?\n\nSe crear√°n ${oltIds.length} workflows independientes.`)) {
                return;
            }
        }
        
        // Crear workflows (uno por OLT)
        let created = 0;
        let errors = 0;
        let createdOltIds = []; // Guardar IDs de OLTs creadas
        const errorMessages = [];
        
        for (const oltId of oltIds) {
            try {
                const response = await apiFetch('/snmp_jobs/api/workflows/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken(),
                    },
                    body: JSON.stringify({ olt_id: oltId }),
                });
                if (response.ok) {
                    created++;
                    createdOltIds.push(oltId);
                } else {
                    errors++;
                    const text = await response.text();
                    errorMessages.push(`OLT ID ${oltId}: ${text || 'Error desconocido'}`);
                }
            } catch (error) {
                errors++;
                errorMessages.push(`OLT ID ${oltId}: ${error.message}`);
            }
        }
        
        // Mostrar resultado
        if (created > 0 && errors === 0) {
            setMessage(workflowMessage, `‚úÖ ${created} workflow(s) creado(s) correctamente.`, 'success');
        } else if (created > 0 && errors > 0) {
            setMessage(workflowMessage, `‚ö†Ô∏è ${created} creado(s), ${errors} error(es).\n${errorMessages.join('\n')}`, 'error');
        } else {
            setMessage(workflowMessage, `‚ùå Error al crear workflows:\n${errorMessages.join('\n')}`, 'error');
        }
        
        // Limpiar selecci√≥n
        if (multiMode) {
            document.querySelectorAll('.olt-checkbox').forEach(cb => cb.checked = false);
        } else {
            oltSelector.value = '';
        }
        
        await loadWorkflows();
        
        // Si se crearon workflows exitosamente, cambiar a pesta√±a de asignaci√≥n
        if (created > 0 && createdOltIds.length > 0) {
            // Esperar un momento para que se carguen las plantillas
            await loadWorkflowTemplates();
            
            // Preseleccionar las OLTs creadas en el modal de asignaci√≥n
            document.querySelectorAll('.apply-olt-checkbox').forEach(cb => {
                if (createdOltIds.includes(parseInt(cb.value, 10))) {
                    cb.checked = true;
                }
            });
            
            // Cambiar a pesta√±a de asignaci√≥n
            switchTab('assign');
            
            // Actualizar checkbox "Seleccionar todas" si todas las creadas est√°n seleccionadas
            const selectAllCheckbox = document.getElementById('selectAllOltsInModal');
            if (selectAllCheckbox) {
                const allCheckboxes = document.querySelectorAll('.apply-olt-checkbox');
                const checkedCount = Array.from(allCheckboxes).filter(cb => cb.checked).length;
                selectAllCheckbox.checked = checkedCount === allCheckboxes.length && allCheckboxes.length > 0;
            }
        }
    }

    function switchTab(tabName) {
        // Desactivar todas las pesta√±as
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
        
        // Activar la pesta√±a seleccionada
        const tabBtn = document.getElementById(`${tabName}TabBtn`);
        const tabContent = document.getElementById(`${tabName}Section`);
        
        if (tabBtn && tabContent) {
            tabBtn.classList.add('active');
            tabContent.classList.remove('hidden');
        }
    }

    async function selectWorkflow(workflowId, options = {}) {
        if (!workflowId) {
            selectedWorkflow = null;
            workflowTitle.textContent = 'Selecciona un workflow';
            workflowStatus.classList.add('hidden');
            if (deleteWorkflowBtn) deleteWorkflowBtn.style.display = 'none';
            nodesContainer.innerHTML = '';
            edgesContainer.innerHTML = '';
            legacyJobsBody.innerHTML = '';
            legacyJobsTable.classList.add('hidden');
            legacyJobsEmpty.textContent = '';
            return;
        }
        const response = await apiFetch(`/snmp_jobs/api/workflows/${workflowId}/`);
        if (!response.ok) {
            setMessage(workflowMessage, 'No se pudo cargar el workflow.', 'error');
            return;
        }
        const data = await response.json();
        pendingHighlightNodeId = options.highlightNodeId || null;
        renderWorkflow(data.workflow);
    }

    async function createNode() {
        if (!selectedWorkflow) {
            setMessage(nodeMessage, 'Selecciona un workflow primero.', 'error');
            return;
        }
        const templateId = nodeTemplateSelect.value;
        if (!templateId) {
            setMessage(nodeMessage, 'Selecciona una plantilla.', 'error');
            return;
        }
        const payload = {
            name: nodeNameInput.value || undefined,
            template_id: parseInt(templateId, 10),
            interval_seconds: parseInt(nodeIntervalInput.value || nodeTemplateSelect.selectedOptions[0].dataset.interval, 10),
            priority: parseInt(nodePrioritySelect.value, 10),
        };
        const response = await apiFetch(`/snmp_jobs/api/workflows/${selectedWorkflow.id}/nodes/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken(),
            },
            body: JSON.stringify(payload),
        });
        if (!response.ok) {
            const text = await response.text();
            setMessage(nodeMessage, text || 'Error al crear nodo.', 'error');
            return;
        }
        const data = await response.json();
        const newNodeId = data.node ? data.node.id : null;
        setMessage(nodeMessage, 'Nodo agregado.');
        nodeNameInput.value = '';
        document.getElementById('nodeKey').value = '';
        nodeTemplateSelect.value = '';
        nodeIntervalInput.value = '';
        nodePrioritySelect.value = '3';
        pendingHighlightNodeId = newNodeId;
        await selectWorkflow(selectedWorkflow.id, { highlightNodeId: newNodeId });
    }

    async function deleteNode(nodeId) {
        if (!selectedWorkflow) return;
        
        // Buscar el nodo para mostrar su nombre en la confirmaci√≥n
        const node = selectedWorkflow.nodes.find(n => n.id === nodeId);
        const nodeName = node ? node.name : `nodo #${nodeId}`;
        
        // Confirmar eliminaci√≥n
        if (!confirm(`¬øEst√°s seguro de eliminar el nodo "${nodeName}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
            return;
        }
        
        const response = await apiFetch(`/snmp_jobs/api/workflows/${selectedWorkflow.id}/nodes/${nodeId}/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': csrfToken() },
        });
        if (!response.ok) {
            setMessage(nodeMessage, 'No se pudo eliminar el nodo.', 'error');
            return;
        }
        setMessage(nodeMessage, `Nodo "${nodeName}" eliminado correctamente.`, 'success');
        await selectWorkflow(selectedWorkflow.id);
    }
    
    // Funci√≥n para editar nodo del workflow
    function editWorkflowNode(node) {
        if (!selectedWorkflow || !node) return;
        
        // Crear modal de edici√≥n
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
                    <h3 style="margin: 0; font-size: 1.5rem;">‚úèÔ∏è Editar Nodo: ${node.name}</h3>
                    <button class="button-secondary" id="closeEditNodeModal" style="padding: 0.25rem 0.75rem; font-size: 1.5rem; line-height: 1;">√ó</button>
                </div>
                
                <div class="form-group">
                    <label for="editNodeKey" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Key ‚≠ê</label>
                    <input class="input" id="editNodeKey" type="text" value="${node.key || ''}" placeholder="Ej. discover.60min" style="width: 100%; padding: 0.75rem;">
                    <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">Identificador √∫nico del nodo</small>
                </div>
                
                <div class="form-group">
                    <label for="editNodeName" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nombre del Nodo</label>
                    <input class="input" id="editNodeName" type="text" value="${node.name || ''}" placeholder="Ej. Descubrimiento principal" style="width: 100%; padding: 0.75rem;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="editNodeInterval" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Intervalo (segundos)</label>
                        <input class="input" id="editNodeInterval" type="number" min="10" step="5" value="${node.interval_seconds || 300}" style="width: 100%; padding: 0.75rem;">
                    </div>
                    <div class="form-group">
                        <label for="editNodePriority" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Prioridad</label>
                        <select class="select" id="editNodePriority" style="width: 100%; padding: 0.75rem;">
                            <option value="1" ${node.priority === 1 ? 'selected' : ''}>1 - Discovery (Alta)</option>
                            <option value="2" ${node.priority === 2 ? 'selected' : ''}>2 - GET cr√≠tico (Media)</option>
                            <option value="3" ${node.priority === 3 ? 'selected' : ''}>3 - GET est√°ndar (Baja)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="editNodeEnabled" ${node.enabled ? 'checked' : ''} style="width: 18px; height: 18px;">
                        <span style="font-weight: 600;">Habilitado</span>
                    </label>
                </div>
                
                <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <button class="button-secondary" id="cancelEditNodeBtn" style="padding: 0.75rem 1.5rem;">Cancelar</button>
                    <button class="button-primary" id="saveEditNodeBtn" style="padding: 0.75rem 1.5rem;">üíæ Guardar Cambios</button>
                </div>
                <div id="editNodeMessage" class="message" style="margin-top: 1rem;"></div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Event listeners del modal
        const closeBtn = modal.querySelector('#closeEditNodeModal');
        const cancelBtn = modal.querySelector('#cancelEditNodeBtn');
        const saveBtn = modal.querySelector('#saveEditNodeBtn');
        const editNodeMessage = modal.querySelector('#editNodeMessage');
        
        const closeModal = () => {
            modal.style.display = 'none';
            modal.style.visibility = 'hidden';
            modal.style.opacity = '0';
            setTimeout(() => modal.remove(), 300);
        };
        
        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        
        saveBtn.addEventListener('click', async () => {
            const key = modal.querySelector('#editNodeKey').value.trim();
            const name = modal.querySelector('#editNodeName').value.trim();
            const interval = parseInt(modal.querySelector('#editNodeInterval').value, 10);
            const priority = parseInt(modal.querySelector('#editNodePriority').value, 10);
            const enabled = modal.querySelector('#editNodeEnabled').checked;
            
            if (!key) {
                setMessage(editNodeMessage, 'La key es requerida.', 'error');
                return;
            }
            
            if (!interval || interval < 10) {
                setMessage(editNodeMessage, 'El intervalo debe ser al menos 10 segundos.', 'error');
                return;
            }
            
            try {
                const response = await apiFetch(`/snmp_jobs/api/workflows/${selectedWorkflow.id}/nodes/${node.id}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken(),
                    },
                    body: JSON.stringify({
                        key: key,
                        name: name || key,
                        interval_seconds: interval,
                        priority: priority,
                        enabled: enabled,
                    }),
                });
                
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || 'Error al actualizar nodo');
                }
                
                setMessage(editNodeMessage, 'Nodo actualizado correctamente.', 'success');
                setTimeout(async () => {
                    closeModal();
                    await selectWorkflow(selectedWorkflow.id);
                }, 1000);
            } catch (error) {
                console.error('Error al actualizar nodo:', error);
                setMessage(editNodeMessage, `Error: ${error.message}`, 'error');
            }
        });
    }

    async function createEdge() {
        if (!selectedWorkflow) {
            setMessage(edgeMessage, 'Selecciona un workflow primero.', 'error');
            return;
        }
        const upstreamId = edgeUpstreamSelect.value;
        const downstreamId = edgeDownstreamSelect.value;
        if (!upstreamId || !downstreamId) {
            setMessage(edgeMessage, 'Selecciona ambos nodos.', 'error');
            return;
        }
        if (upstreamId === downstreamId) {
            setMessage(edgeMessage, 'Los nodos no pueden ser iguales.', 'error');
            return;
        }
        const response = await apiFetch(`/snmp_jobs/api/workflows/${selectedWorkflow.id}/edges/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken(),
            },
            body: JSON.stringify({
                upstream_id: parseInt(upstreamId, 10),
                downstream_id: parseInt(downstreamId, 10),
                edge_type: edgeTypeSelect.value,
            }),
        });
        if (!response.ok) {
            const text = await response.text();
            setMessage(edgeMessage, text || 'Error al crear dependencia.', 'error');
            return;
        }
        setMessage(edgeMessage, 'Dependencia creada.');
        edgeUpstreamSelect.value = '';
        edgeDownstreamSelect.value = '';
        edgeTypeSelect.value = 'secuencial';
        await selectWorkflow(selectedWorkflow.id);
    }

    async function deleteEdge(edgeId) {
        if (!selectedWorkflow) return;
        const response = await apiFetch(`/snmp_jobs/api/workflows/${selectedWorkflow.id}/edges/${edgeId}/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': csrfToken() },
        });
        if (!response.ok) {
            setMessage(edgeMessage, 'No se pudo eliminar la dependencia.', 'error');
            return;
        }
        await selectWorkflow(selectedWorkflow.id);
    }

    async function saveWorkflowMeta() {
        if (!selectedWorkflow) {
            setMessage(metaMessage, 'Selecciona un workflow primero.', 'error');
            return;
        }
        const response = await apiFetch(`/snmp_jobs/api/workflows/${selectedWorkflow.id}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken(),
            },
            body: JSON.stringify({ theme: workflowThemeSelect.value }),
        });
        if (!response.ok) {
            const text = await response.text();
            setMessage(metaMessage, text || 'Error al guardar.', 'error');
            return;
        }
        setMessage(metaMessage, 'Tema guardado.');
        await selectWorkflow(selectedWorkflow.id);
    }

    // Toggle entre modo simple y m√∫ltiple para crear workflows
    const multiOltModeCheckbox = document.getElementById('multiOltMode');
    const singleOltGroup = document.getElementById('singleOltGroup');
    const multiOltGroup = document.getElementById('multiOltGroup');
    
    if (multiOltModeCheckbox) {
        multiOltModeCheckbox.addEventListener('change', () => {
            if (multiOltModeCheckbox.checked) {
                singleOltGroup.classList.add('hidden');
                multiOltGroup.classList.remove('hidden');
            } else {
                singleOltGroup.classList.remove('hidden');
                multiOltGroup.classList.add('hidden');
            }
        });
    }
    
    // Botones para seleccionar/deseleccionar todas las OLTs
    const selectAllBtn = document.getElementById('selectAllOlts');
    const deselectAllBtn = document.getElementById('deselectAllOlts');
    
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', () => {
            document.querySelectorAll('.olt-checkbox').forEach(cb => cb.checked = true);
        });
    }
    
    if (deselectAllBtn) {
        deselectAllBtn.addEventListener('click', () => {
            document.querySelectorAll('.olt-checkbox').forEach(cb => cb.checked = false);
        });
    }
    
    document.getElementById('createWorkflowBtn').addEventListener('click', createWorkflow);
    document.getElementById('createNodeBtn').addEventListener('click', createNode);
    document.getElementById('createEdgeBtn').addEventListener('click', createEdge);
    document.getElementById('saveWorkflowMeta').addEventListener('click', saveWorkflowMeta);

    workflowSelector.addEventListener('change', event => {
        selectWorkflow(event.target.value);
    });
    
    // Event listener para borrar workflow
    if (deleteWorkflowBtn) {
        deleteWorkflowBtn.addEventListener('click', async () => {
            if (!selectedWorkflow) return;
            
            const workflowName = selectedWorkflow.name || 'este workflow';
            const oltName = selectedWorkflow.olt_name || 'OLT';
            const nodeCount = selectedWorkflow.nodes ? selectedWorkflow.nodes.length : 0;
            
            if (!confirm(`¬øEst√°s seguro de eliminar el workflow "${workflowName}" de ${oltName}?\n\nEsta acci√≥n eliminar√° el workflow y sus ${nodeCount} nodo(s). Esta acci√≥n NO se puede deshacer.`)) {
                return;
            }
            
            try {
                const response = await apiFetch(`/snmp_jobs/api/workflows/${selectedWorkflow.id}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken(),
                    },
                });
                
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || 'Error al eliminar workflow');
                }
                
                const data = await response.json();
                setMessage(workflowMessage, data.message || 'Workflow eliminado correctamente.', 'success');
                
                // Limpiar selecci√≥n
                selectedWorkflow = null;
                workflowTitle.textContent = 'Selecciona un workflow';
                workflowStatus.classList.add('hidden');
                deleteWorkflowBtn.style.display = 'none';
                nodesContainer.innerHTML = '';
                edgesContainer.innerHTML = '';
                
                // Recargar lista de workflows
                await loadWorkflows();
                
                // Limpiar selector
                workflowSelector.value = '';
            } catch (error) {
                console.error('Error al eliminar workflow:', error);
                setMessage(workflowMessage, `Error al eliminar workflow: ${error.message}`, 'error');
            }
        });
    }

    const demoWorkflowBtn = document.getElementById('demoWorkflowBtn');
    if (demoWorkflowBtn) {
        demoWorkflowBtn.addEventListener('click', () => {
            const workflowId = demoWorkflowBtn.dataset.workflowId;
            if (!workflowId) return;
            workflowSelector.value = workflowId;
            workflowSelector.dispatchEvent(new Event('change'));
            setMessage(workflowMessage, 'Se abri√≥ el workflow de ejemplo SMP-10.');
        });
    }

    nodeTemplateSelect.addEventListener('change', event => {
        const option = event.target.selectedOptions[0];
        if (!option) return;
        
        // Auto-llenar intervalo y prioridad desde la plantilla
        const interval = option.dataset.interval || '';
        const priority = option.dataset.priority || '3';
        
        if (interval) {
            nodeIntervalInput.value = interval;
        }
        if (priority) {
            nodePrioritySelect.value = priority;
        }
        
        // Mostrar informaci√≥n de la plantilla seleccionada
        const templateName = option.textContent.trim();
        const snmpInfo = option.dataset.snmpName ? `SnmpJob: ${option.dataset.snmpName}` : 'Sin SnmpJob asociada';
        setMessage(nodeMessage, `‚úÖ Plantilla seleccionada: ${templateName}\n${snmpInfo}`, 'success');
    });

    legacyJobsBody.addEventListener('click', async event => {
        const target = event.target;
        if (target.classList.contains('legacy-toggle')) {
            const row = target.closest('tr');
            const jobHostId = row.dataset.jobHostId;
            const currentEnabled = target.dataset.enabled === '1';
            target.disabled = true;
            await toggleLegacyJob(jobHostId, !currentEnabled);
            target.disabled = false;
        } else if (target.classList.contains('legacy-create-node')) {
            const row = target.closest('tr');
            const jobHostId = row.dataset.jobHostId;
            target.disabled = true;
            await createNodeFromLegacy(jobHostId, row.dataset.oltId);
            target.disabled = false;
        }
    });

    globalSearchInput.addEventListener('input', event => {
        renderGlobalLegacyJobs(event.target.value);
    });

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('#nodesTab, #edgesTab, #metaTab').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(btn.dataset.tab).classList.remove('hidden');
        });
    });

    // ========================================================================
    // Gesti√≥n de Plantillas de Workflow (Tipo Zabbix)
    // ========================================================================
    
    // selectedTemplateId y templateNodes ya est√°n declaradas arriba en el DOMContentLoaded
    // Las referencias a elementos del DOM se obtendr√°n dentro del DOMContentLoaded m√°s abajo
    // para evitar declaraciones duplicadas
    
    // Funci√≥n para obtener elementos del formulario de nodos (se ejecuta cuando se necesita)
    function getNodeFormElements() {
        return {
            nodeKeyInput: document.getElementById('nodeKeyInput'),
            nodeNameInput: document.getElementById('nodeNameInput'),
            nodeOidInput: document.getElementById('nodeOidInput'),
            nodeIntervalInput: document.getElementById('nodeIntervalInput'),
            nodePriorityInput: document.getElementById('nodePriorityInput'),
            nodeEnabledInput: document.getElementById('nodeEnabledInput'),
            addNodeToTemplateBtn: document.getElementById('addNodeToTemplateBtn'),
            templateNodesList: document.getElementById('templateNodesList'),
        };
    }
    
    // Cargar todos los OIDs disponibles
    async function loadOIDs() {
        const elements = getNodeFormElements();
        if (!elements.nodeOidInput) return;
        
        const response = await apiFetch('/snmp_jobs/api/oids/');
        if (!response.ok) return;
        const data = await response.json();
        elements.nodeOidInput.innerHTML = '<option value="">Selecciona un OID‚Ä¶</option>';
        data.oids.forEach(oid => {
            const option = document.createElement('option');
            option.value = oid.id;
            option.textContent = `${oid.nombre} (${oid.oid}) - ${oid.marca_nombre || 'Gen√©rico'} ${oid.modelo_nombre ? `[${oid.modelo_nombre}]` : ''} - ${oid.espacio_display}`;
            option.dataset.espacio = oid.espacio;
            option.dataset.marcaNombre = oid.marca_nombre || '';
            option.dataset.modeloNombre = oid.modelo_nombre || '';
            elements.nodeOidInput.appendChild(option);
        });
    }
    
    // Flag para evitar agregar listeners m√∫ltiples veces
    let nodeFormListenersInitialized = false;
    
    // Inicializar event listeners del formulario de nodos
    function initNodeFormListeners() {
        const elements = getNodeFormElements();
        console.log('initNodeFormListeners - elementos encontrados:', {
            nodeOidInput: !!elements.nodeOidInput,
            addNodeToTemplateBtn: !!elements.addNodeToTemplateBtn,
        });
        
        if (!elements.nodeOidInput || !elements.addNodeToTemplateBtn) {
            console.error('Elementos del formulario no encontrados');
            return;
        }
        
        // Evitar agregar listeners m√∫ltiples veces
        if (nodeFormListenersInitialized) {
            console.log('Listeners ya inicializados, omitiendo...');
            return;
        }
        nodeFormListenersInitialized = true;
        console.log('Agregando event listeners...');
        
        // Auto-llenar nombre y prioridad cuando se selecciona un OID
        if (elements.nodeOidInput) {
            elements.nodeOidInput.addEventListener('change', (e) => {
                const option = e.target.options[e.target.selectedIndex];
                const elems = getNodeFormElements();
                if (option.value) {
                    // Auto-llenar nombre si est√° vac√≠o
                    if (elems.nodeNameInput && !elems.nodeNameInput.value.trim()) {
                        elems.nodeNameInput.value = option.textContent.split(' - ')[0]; // Solo el nombre del OID
                    }
                    // Auto-ajustar prioridad seg√∫n el espacio del OID
                    if (elems.nodePriorityInput) {
                        const espacio = option.dataset.espacio;
                        if (espacio === 'descubrimiento') {
                            elems.nodePriorityInput.value = '1'; // Discovery = Alta prioridad
                        } else {
                            elems.nodePriorityInput.value = '3'; // GET = Baja prioridad
                        }
                    }
                }
            });
        }
        
        // Agregar nodo a la plantilla
        elements.addNodeToTemplateBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Bot√≥n agregar nodo clickeado');
            
            // Obtener elementos frescos cada vez
            const elems = getNodeFormElements();
            console.log('Elementos obtenidos:', {
                nodeKeyInput: !!elems.nodeKeyInput,
                nodeKeyValue: elems.nodeKeyInput ? elems.nodeKeyInput.value : 'NO ENCONTRADO',
                nodeOidInput: !!elems.nodeOidInput,
                nodeOidValue: elems.nodeOidInput ? elems.nodeOidInput.value : 'NO ENCONTRADO',
            });
            
            // Validar que los elementos existan
            if (!elems.nodeKeyInput) {
                console.error('nodeKeyInput no encontrado');
                const msgElement = document.getElementById('templateFormMessage');
                if (msgElement) {
                    setMessage(msgElement, 'Error: Campo Key no encontrado. Por favor, recarga la p√°gina.', 'error');
                } else {
                    alert('Error: Campo Key no encontrado. Por favor, recarga la p√°gina.');
                }
                return;
            }
            if (!elems.nodeOidInput) {
                console.error('nodeOidInput no encontrado');
                const msgElement = document.getElementById('templateFormMessage');
                if (msgElement) {
                    setMessage(msgElement, 'Error: Campo OID no encontrado. Por favor, recarga la p√°gina.', 'error');
                } else {
                    alert('Error: Campo OID no encontrado. Por favor, recarga la p√°gina.');
                }
                return;
            }
            
            // Obtener valores con validaci√≥n robusta
            const keyRaw = elems.nodeKeyInput ? elems.nodeKeyInput.value : '';
            const key = keyRaw ? keyRaw.trim() : '';
            const name = elems.nodeNameInput ? (elems.nodeNameInput.value || '').trim() : '';
            const oidIdRaw = elems.nodeOidInput ? elems.nodeOidInput.value : '';
            const oidId = oidIdRaw ? oidIdRaw.trim() : '';
            const intervalRaw = elems.nodeIntervalInput ? elems.nodeIntervalInput.value : '';
            const interval = intervalRaw ? parseInt(intervalRaw, 10) : 0;
            const priorityRaw = elems.nodePriorityInput ? elems.nodePriorityInput.value : '';
            const priority = priorityRaw ? parseInt(priorityRaw, 10) : 3;
            const enabled = elems.nodeEnabledInput ? elems.nodeEnabledInput.checked : true;
            
            console.log('Valores obtenidos:', { 
                keyRaw, 
                key, 
                keyLength: key.length,
                name, 
                oidId, 
                interval, 
                priority, 
                enabled 
            });
            
            // Validaciones con mejor feedback
            if (!key || key.length === 0) {
                console.error('Key vac√≠a despu√©s de trim. Valor original:', keyRaw, 'Valor despu√©s de trim:', key);
                const msgElement = document.getElementById('templateFormMessage');
                if (msgElement) {
                    setMessage(msgElement, 'La key es requerida. Por favor, ingresa un identificador √∫nico.', 'error');
                } else {
                    alert('La key es requerida. Por favor, ingresa un identificador √∫nico.');
                }
                if (elems.nodeKeyInput) {
                    elems.nodeKeyInput.focus();
                    elems.nodeKeyInput.style.borderColor = '#ef4444';
                    setTimeout(() => {
                        if (elems.nodeKeyInput) elems.nodeKeyInput.style.borderColor = '';
                    }, 3000);
                }
                return;
            }
            if (!oidId || oidId.length === 0) {
                console.error('OID vac√≠o');
                const msgElement = document.getElementById('templateFormMessage');
                if (msgElement) {
                    setMessage(msgElement, 'El OID es requerido. Por favor, selecciona un OID.', 'error');
                } else {
                    alert('El OID es requerido. Por favor, selecciona un OID.');
                }
                if (elems.nodeOidInput) {
                    elems.nodeOidInput.focus();
                    elems.nodeOidInput.style.borderColor = '#ef4444';
                    setTimeout(() => {
                        if (elems.nodeOidInput) elems.nodeOidInput.style.borderColor = '';
                    }, 3000);
                }
                return;
            }
            if (!interval || interval < 10) {
                console.error('Intervalo inv√°lido:', interval);
                const msgElement = document.getElementById('templateFormMessage');
                if (msgElement) {
                    setMessage(msgElement, 'El intervalo debe ser al menos 10 segundos.', 'error');
                } else {
                    alert('El intervalo debe ser al menos 10 segundos.');
                }
                if (elems.nodeIntervalInput) {
                    elems.nodeIntervalInput.focus();
                    elems.nodeIntervalInput.style.borderColor = '#ef4444';
                    setTimeout(() => {
                        if (elems.nodeIntervalInput) elems.nodeIntervalInput.style.borderColor = '';
                    }, 3000);
                }
                return;
            }
            
            // Verificar que la key no est√© duplicada (excepto si estamos editando el mismo nodo)
            const existingNodeIndex = templateNodes.findIndex(n => n.key === key);
            if (existingNodeIndex !== -1 && existingNodeIndex !== editingNodeIndex) {
                console.error('Key duplicada:', key);
                const msgElement = document.getElementById('templateFormMessage');
                if (msgElement) {
                    setMessage(msgElement, `La key "${key}" ya existe en esta plantilla. Por favor, usa otra key.`, 'error');
                } else {
                    alert(`La key "${key}" ya existe en esta plantilla. Por favor, usa otra key.`);
                }
                if (elems.nodeKeyInput) {
                    elems.nodeKeyInput.focus();
                    elems.nodeKeyInput.style.borderColor = '#ef4444';
                    setTimeout(() => {
                        if (elems.nodeKeyInput) elems.nodeKeyInput.style.borderColor = '';
                    }, 3000);
                }
                return;
            }
            
            // Obtener informaci√≥n del OID seleccionado
            const oidOption = elems.nodeOidInput ? elems.nodeOidInput.options[elems.nodeOidInput.selectedIndex] : null;
            const oidText = oidOption ? oidOption.textContent : 'Sin OID';
            const oidEspacio = oidOption ? oidOption.dataset.espacio : '';
            const oidMarcaNombre = oidOption ? oidOption.dataset.marcaNombre : '';
            const oidModeloNombre = oidOption ? oidOption.dataset.modeloNombre : '';
            
            // Si estamos editando un nodo existente
            if (editingNodeIndex !== null && editingNodeIndex >= 0 && editingNodeIndex < templateNodes.length) {
                const node = templateNodes[editingNodeIndex];
                
                // Si el nodo tiene ID, actualizarlo en el servidor
                if (node.id && selectedTemplateId) {
                    try {
                        const response = await apiFetch(`/snmp_jobs/api/workflow-templates/${selectedTemplateId}/nodes/${node.id}/`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                key: key,
                                name: name || key,
                                oid_id: parseInt(oidId, 10),
                                interval_seconds: interval,
                                priority: priority,
                                enabled: enabled,
                            }),
                        });
                        
                        if (!response.ok) {
                            const text = await response.text();
                            throw new Error(text || 'Error al actualizar nodo');
                        }
                        
                        const data = await response.json();
                        // Actualizar nodo con datos del servidor
                        Object.assign(node, data.node);
                    } catch (error) {
                        console.error('Error al actualizar nodo:', error);
                        alert(`Error al actualizar nodo: ${error.message}`);
                        return;
                    }
                } else {
                    // Actualizar nodo localmente
                    Object.assign(node, {
                        key: key,
                        name: name || key,
                        oid_id: parseInt(oidId, 10),
                        oid_nombre: oidText.split(' - ')[0],
                        oid_espacio: oidEspacio,
                        oid_marca_nombre: oidMarcaNombre,
                        oid_modelo_nombre: oidModeloNombre,
                        interval_seconds: interval,
                        priority: priority,
                        enabled: enabled,
                    });
                }
                
                editingNodeIndex = null;
                const addNodeBtn = document.getElementById('addNodeToTemplateBtn');
                if (addNodeBtn) {
                    addNodeBtn.textContent = '‚ûï Agregar Nodo';
                }
            } else {
                // Agregar nuevo nodo a la lista temporal
                templateNodes.push({
                    key: key,
                    name: name || key,
                    oid_id: parseInt(oidId, 10),
                    oid_nombre: oidText.split(' - ')[0],
                    oid_espacio: oidEspacio,
                    oid_marca_nombre: oidMarcaNombre,
                    oid_modelo_nombre: oidModeloNombre,
                    interval_seconds: interval,
                    priority: priority,
                    enabled: enabled,
                });
            }
            
            // Limpiar formulario y remover estilos de error
            if (elems.nodeKeyInput) {
                elems.nodeKeyInput.value = '';
                elems.nodeKeyInput.style.borderColor = '';
            }
            if (elems.nodeNameInput) {
                elems.nodeNameInput.value = '';
                elems.nodeNameInput.style.borderColor = '';
            }
            if (elems.nodeOidInput) {
                elems.nodeOidInput.value = '';
                elems.nodeOidInput.style.borderColor = '';
            }
            if (elems.nodeIntervalInput) {
                elems.nodeIntervalInput.value = '';
                elems.nodeIntervalInput.style.borderColor = '';
            }
            if (elems.nodePriorityInput) elems.nodePriorityInput.value = '3';
            if (elems.nodeEnabledInput) elems.nodeEnabledInput.checked = true;
            
            // Mostrar mensaje de √©xito
            const wasEditing = editingNodeIndex !== null;
            const msgElement = document.getElementById('templateFormMessage');
            if (msgElement) {
                setMessage(msgElement, wasEditing ? `Nodo "${key}" actualizado correctamente.` : `Nodo "${key}" agregado correctamente.`, 'success');
            }
            
            // Actualizar lista de nodos
            renderTemplateNodes();
            
            console.log(wasEditing ? 'Nodo actualizado exitosamente:' : 'Nodo agregado exitosamente:', { key, name, oidId });
        });
    }
    
    // Renderizar nodos de la plantilla
    function renderTemplateNodes() {
        const elements = getNodeFormElements();
        if (!elements.templateNodesList) return;
        
        if (templateNodes.length === 0) {
            elements.templateNodesList.innerHTML = `
                <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                    No hay nodos agregados a√∫n. Agrega el primero usando el formulario de abajo.
                </div>
            `;
            return;
        }
        
        elements.templateNodesList.innerHTML = templateNodes.map((node, index) => {
            const oidInfo = node.oid_nombre ? `${node.oid_nombre} (${node.oid_oid || ''})` : 'Sin OID';
            const espacioInfo = node.oid_espacio_display ? ` ¬∑ ${node.oid_espacio_display}` : '';
            const marcaInfo = node.oid_marca_nombre ? ` ¬∑ ${node.oid_marca_nombre}` : '';
            const modeloInfo = node.oid_modelo_nombre ? ` ¬∑ ${node.oid_modelo_nombre}` : '';
            return `
            <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">
                        ${node.name} <span style="color: var(--text-secondary); font-weight: normal; font-size: 0.85rem;">(${node.key})</span>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                        ${oidInfo}${espacioInfo}${marcaInfo}${modeloInfo} ¬∑ ${node.interval_seconds}s ¬∑ Prioridad ${node.priority} ¬∑ ${node.enabled ? '‚úÖ Habilitado' : '‚ùå Deshabilitado'}
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="button-secondary" onclick="editTemplateNode(${index})" style="padding: 0.35rem 0.75rem; font-size: 0.85rem;" title="Editar nodo">‚úèÔ∏è Editar</button>
                    <button class="button-secondary" onclick="toggleTemplateNodeEnabled(${index})" style="padding: 0.35rem 0.75rem; font-size: 0.85rem;" title="${node.enabled ? 'Deshabilitar' : 'Habilitar'} nodo">
                        ${node.enabled ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                    </button>
                    <button class="button-secondary" onclick="removeTemplateNode(${index})" style="padding: 0.35rem 0.75rem; font-size: 0.85rem;" title="Eliminar nodo">üóëÔ∏è Eliminar</button>
                </div>
            </div>
        `;
        }).join('');
    }
    
    // Eliminar nodo de la plantilla
    window.removeTemplateNode = async function(index) {
        if (!confirm('¬øEliminar este nodo de la plantilla?')) {
            return;
        }
        
        const node = templateNodes[index];
        if (!node || !node.id) {
            // Si no tiene ID, solo eliminarlo del array local
            templateNodes.splice(index, 1);
            renderTemplateNodes();
            return;
        }
        
        // Si tiene ID, eliminarlo del servidor
        if (!selectedTemplateId) {
            templateNodes.splice(index, 1);
            renderTemplateNodes();
            return;
        }
        
        try {
            const response = await apiFetch(`/snmp_jobs/api/workflow-templates/${selectedTemplateId}/nodes/${node.id}/`, {
                method: 'DELETE',
            });
            
            if (!response.ok) {
                const text = await response.text();
                throw new Error(text || 'Error al eliminar nodo');
            }
            
            templateNodes.splice(index, 1);
            renderTemplateNodes();
            
            const msgElement = document.getElementById('templateFormMessage');
            if (msgElement) {
                setMessage(msgElement, 'Nodo eliminado correctamente.', 'success');
            }
        } catch (error) {
            console.error('Error al eliminar nodo:', error);
            alert(`Error al eliminar nodo: ${error.message}`);
        }
    };
    
    // Editar nodo de la plantilla
    window.editTemplateNode = function(index) {
        const node = templateNodes[index];
        if (!node) return;
        
        // Cargar datos del nodo en el formulario
        const elems = getNodeFormElements();
        if (elems.nodeKeyInput) elems.nodeKeyInput.value = node.key || '';
        if (elems.nodeNameInput) elems.nodeNameInput.value = node.name || '';
        if (elems.nodeOidInput) elems.nodeOidInput.value = node.oid_id || '';
        if (elems.nodeIntervalInput) elems.nodeIntervalInput.value = node.interval_seconds || 300;
        if (elems.nodePriorityInput) elems.nodePriorityInput.value = node.priority || 3;
        if (elems.nodeEnabledInput) elems.nodeEnabledInput.checked = node.enabled !== false;
        
        // Guardar √≠ndice del nodo que se est√° editando
        editingNodeIndex = index;
        
        // Scroll al formulario
        const formSection = document.querySelector('.node-form-section');
        if (formSection) {
            formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Cambiar texto del bot√≥n
        const addNodeBtn = document.getElementById('addNodeToTemplateBtn');
        if (addNodeBtn) {
            addNodeBtn.textContent = 'üíæ Actualizar Nodo';
        }
    };
    
    // Activar/desactivar nodo de la plantilla
    window.toggleTemplateNodeEnabled = async function(index) {
        const node = templateNodes[index];
        if (!node || !node.id) {
            // Si no tiene ID, solo cambiar en el array local
            node.enabled = !node.enabled;
            renderTemplateNodes();
            return;
        }
        
        // Si tiene ID, actualizarlo en el servidor
        if (!selectedTemplateId) {
            node.enabled = !node.enabled;
            renderTemplateNodes();
            return;
        }
        
        try {
            const response = await apiFetch(`/snmp_jobs/api/workflow-templates/${selectedTemplateId}/nodes/${node.id}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    enabled: !node.enabled,
                }),
            });
            
            if (!response.ok) {
                const text = await response.text();
                throw new Error(text || 'Error al actualizar nodo');
            }
            
            const data = await response.json();
            node.enabled = data.node.enabled;
            renderTemplateNodes();
            
            const msgElement = document.getElementById('templateFormMessage');
            if (msgElement) {
                setMessage(msgElement, `Nodo ${node.enabled ? 'habilitado' : 'deshabilitado'} correctamente.`, 'success');
            }
        } catch (error) {
            console.error('Error al actualizar nodo:', error);
            alert(`Error al actualizar nodo: ${error.message}`);
        }
    };
    
    let editingNodeIndex = null;

    async function loadWorkflowTemplates() {
        const response = await apiFetch('/snmp_jobs/api/workflow-templates/');
        if (!response.ok) {
            setMessage(templateFormMessage, 'Error al cargar plantillas.', 'error');
            return;
        }
        const data = await response.json();
        renderTemplates(data.templates);
    }

    function renderTemplates(templates) {
        const tbody = document.getElementById('templatesTableBody');
        tbody.innerHTML = '';
        
        if (templates.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">No hay plantillas creadas</div>
                        <div style="font-size: 0.875rem;">Crea tu primera plantilla para comenzar</div>
                    </td>
                </tr>
            `;
            // Llenar select vac√≠o
            applyTemplateSelect.innerHTML = '<option value="">Selecciona una plantilla‚Ä¶</option>';
            return;
        }
        
        templates.forEach(tpl => {
            const row = document.createElement('tr');
            row.dataset.templateId = tpl.id;
            
            // Crear elementos del bot√≥n manualmente para poder agregar event listeners
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'template-actions';
            
            // Bot√≥n Nodos (m√°s visible y con mejor texto)
            const nodesBtn = document.createElement('button');
            nodesBtn.className = 'button-secondary';
            nodesBtn.innerHTML = '<span style="margin-right: 0.25rem;">‚öôÔ∏è</span> Gestionar Nodos';
            nodesBtn.title = 'Gestionar nodos de la plantilla';
            nodesBtn.style.cssText = 'padding: 0.5rem 0.875rem; font-size: 0.875rem; cursor: pointer; font-weight: 500;';
            nodesBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('Bot√≥n Nodos clickeado para plantilla:', tpl.id, tpl.name);
                if (typeof manageTemplateNodes === 'function') {
                    manageTemplateNodes(tpl.id);
                } else if (typeof editTemplate === 'function') {
                    editTemplate(tpl.id); // Fallback directo
                } else {
                    console.error('Funciones no est√°n definidas');
                    alert('Error: Las funciones no est√°n disponibles. Por favor, recarga la p√°gina.');
                }
            });
            
            // Bot√≥n Editar (m√°s visible y con mejor texto)
            const editBtn = document.createElement('button');
            editBtn.className = 'button-secondary';
            editBtn.innerHTML = '<span style="margin-right: 0.25rem;">‚úèÔ∏è</span> Editar';
            editBtn.title = 'Editar plantilla y sus nodos';
            editBtn.style.cssText = 'padding: 0.5rem 0.875rem; font-size: 0.875rem; cursor: pointer; font-weight: 500;';
            editBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('Bot√≥n Editar clickeado para plantilla:', tpl.id, tpl.name);
                if (typeof editTemplate === 'function') {
                    editTemplate(tpl.id);
                } else {
                    console.error('editTemplate no est√° definida');
                    alert('Error: La funci√≥n editTemplate no est√° disponible. Por favor, recarga la p√°gina.');
                }
            });
            
            // Bot√≥n Asignar (m√°s visible y con mejor texto)
            const applyBtn = document.createElement('button');
            applyBtn.className = 'button-primary';
            applyBtn.innerHTML = '<span style="margin-right: 0.25rem;">üîó</span> Asignar';
            applyBtn.title = 'Asignar plantilla a OLTs';
            applyBtn.style.cssText = 'padding: 0.5rem 0.875rem; font-size: 0.875rem; cursor: pointer; font-weight: 500;';
            applyBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('Bot√≥n Asignar clickeado para plantilla:', tpl.id, tpl.name);
                if (typeof showApplyForm === 'function') {
                    showApplyForm(tpl.id);
                } else {
                    console.error('showApplyForm no est√° definida');
                    alert('Error: La funci√≥n showApplyForm no est√° disponible.');
                }
            });
            
            actionsDiv.appendChild(nodesBtn);
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(applyBtn);
            
            row.innerHTML = `
                <td>
                    <div style="font-weight: 600; color: var(--text-primary);">${tpl.name}</div>
                    ${tpl.description ? `<div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">${tpl.description}</div>` : ''}
                </td>
                <td>
                    <span style="background: rgba(59,130,246,0.15); color: #3b82f6; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">
                        ${tpl.node_count} nodo${tpl.node_count !== 1 ? 's' : ''}
                    </span>
                </td>
                <td>
                    <span style="background: rgba(139,92,246,0.15); color: #8b5cf6; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">
                        ${tpl.workflow_count} OLT${tpl.workflow_count !== 1 ? 's' : ''}
                    </span>
                </td>
                <td>
                    <span class="template-status ${tpl.is_active ? 'active' : 'inactive'}">
                        ${tpl.is_active ? '‚óè Activa' : '‚óã Inactiva'}
                    </span>
                </td>
                <td style="text-align: center; padding: 0.75rem;"></td>
            `;
            
            // Agregar el div de acciones al √∫ltimo td
            const lastTd = row.querySelector('td:last-child');
            if (lastTd) {
                lastTd.style.textAlign = 'center';
                lastTd.style.padding = '0.75rem';
                lastTd.appendChild(actionsDiv);
            } else {
                console.error('No se encontr√≥ el √∫ltimo td para agregar acciones a la plantilla:', tpl.name);
            }
            
            tbody.appendChild(row);
        });
        
        // Llenar select de aplicar plantilla
        applyTemplateSelect.innerHTML = '<option value="">Selecciona una plantilla‚Ä¶</option>';
        templates.forEach(tpl => {
            const option = document.createElement('option');
            option.value = tpl.id;
            option.textContent = `${tpl.name} (${tpl.node_count} nodos)`;
            applyTemplateSelect.appendChild(option);
        });
    }

    async function editTemplate(templateId) {
        console.log('editTemplate llamado con ID:', templateId);
        
        // Validar que los elementos del DOM existan
        if (!templateModal || !templateNameInput || !templateDescriptionInput || !templateModalTitle) {
            console.error('Elementos del modal no encontrados:', {
                templateModal: !!templateModal,
                templateNameInput: !!templateNameInput,
                templateDescriptionInput: !!templateDescriptionInput,
                templateModalTitle: !!templateModalTitle,
            });
            alert('Error: No se pueden cargar los elementos del formulario. Por favor, recarga la p√°gina.');
            return;
        }
        
        try {
            const response = await apiFetch(`/snmp_jobs/api/workflow-templates/${templateId}/`);
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Error al cargar plantilla:', errorText);
                setMessage(templateFormMessage, `Error al cargar plantilla: ${errorText}`, 'error');
                return;
            }
            const data = await response.json();
            console.log('Datos de plantilla cargados:', data);
            
            selectedTemplateId = templateId;
            templateNameInput.value = data.template.name;
            templateDescriptionInput.value = data.template.description || '';
            templateModalTitle.textContent = `Editar Plantilla: ${data.template.name}`;
            
            // Cargar nodos existentes de la plantilla
            const nodesResponse = await apiFetch(`/snmp_jobs/api/workflow-templates/${templateId}/nodes/`);
            if (nodesResponse.ok) {
                const nodesData = await nodesResponse.json();
                console.log('Nodos cargados:', nodesData);
                templateNodes = nodesData.nodes.map(node => ({
                    key: node.key,
                    name: node.name,
                    oid_id: node.oid_id,
                    oid_nombre: node.oid_nombre,
                    oid_espacio: node.oid_espacio,
                    oid_marca_nombre: node.oid_marca_nombre,
                    oid_modelo_nombre: node.oid_modelo_nombre,
                    interval_seconds: node.interval_seconds,
                    priority: node.priority,
                    enabled: node.enabled,
                }));
            } else {
                console.warn('No se pudieron cargar los nodos de la plantilla');
                templateNodes = [];
            }
            
            // Asegurar que el modal est√© visible antes de inicializar
            templateModal.style.display = 'flex';
            templateModal.style.visibility = 'visible';
            templateModal.style.opacity = '1';
            templateModal.classList.remove('hidden');
            console.log('Modal abierto');
            
            // Inicializar listeners y cargar datos despu√©s de que el modal est√© visible
            setTimeout(async () => {
                console.log('Inicializando formulario de nodos (editar)...');
                nodeFormListenersInitialized = false; // Resetear flag
                initNodeFormListeners();
                await loadOIDs();
                renderTemplateNodes();
                console.log('Formulario inicializado (editar)');
            }, 300);
        } catch (error) {
            console.error('Error en editTemplate:', error);
            alert(`Error al editar plantilla: ${error.message}`);
        }
    }

    function showApplyForm(templateId) {
        applyTemplateSelect.value = templateId;
        document.querySelectorAll('.apply-olt-checkbox').forEach(cb => cb.checked = false);
        if (document.getElementById('selectAllOltsInModal')) {
            document.getElementById('selectAllOltsInModal').checked = false;
        }
        assignModal.style.display = 'flex';
        assignModal.style.visibility = 'visible';
        assignModal.style.opacity = '1';
        assignModal.classList.remove('hidden');
    }
    
    // NOTA: Los event listeners para applyTemplateBtn, closeTemplateModal, closeAssignModal, cancelTemplateBtn,
    // saveTemplateBtn, doApplyTemplateBtn, cancelApplyBtn se mover√°n despu√©s de las declaraciones de variables m√°s abajo

    // Botones para seleccionar/deseleccionar OLTs en aplicar plantilla
    document.getElementById('selectAllApplyOlts').addEventListener('click', () => {
        document.querySelectorAll('.apply-olt-checkbox').forEach(cb => cb.checked = true);
        document.getElementById('selectAllOltsInModal').checked = true;
    });
    
    document.getElementById('deselectAllApplyOlts').addEventListener('click', () => {
        document.querySelectorAll('.apply-olt-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('selectAllOltsInModal').checked = false;
    });
    
    // Checkbox "Seleccionar todas" en modal
    const selectAllOltsInModal = document.getElementById('selectAllOltsInModal');
    if (selectAllOltsInModal) {
        selectAllOltsInModal.addEventListener('change', (e) => {
            document.querySelectorAll('.apply-olt-checkbox').forEach(cb => cb.checked = e.target.checked);
        });
    }
    
    // Manejo de pesta√±as de plantillas
    const templatesTabBtn = document.getElementById('templatesTabBtn');
    const assignTabBtn = document.getElementById('assignTabBtn');
    
    if (templatesTabBtn) {
        templatesTabBtn.addEventListener('click', () => switchTab('templates'));
    }
    
    if (assignTabBtn) {
        assignTabBtn.addEventListener('click', () => switchTab('assign'));
    }

    // Funci√≥n para gestionar nodos de plantilla - abre el modal de edici√≥n
    function manageTemplateNodes(templateId) {
        editTemplate(templateId);
    }

    // Exponer funciones globalmente para onclick (por si acaso)
    window.editTemplate = editTemplate;
    window.showApplyForm = showApplyForm;
    window.switchTab = switchTab;
    window.manageTemplateNodes = manageTemplateNodes;
    
    // Tambi√©n exponer directamente en el objeto global para mayor compatibilidad
    if (typeof globalThis !== 'undefined') {
        globalThis.editTemplate = editTemplate;
        globalThis.showApplyForm = showApplyForm;
        globalThis.manageTemplateNodes = manageTemplateNodes;
    }
    
    console.log('Funciones expuestas globalmente:', {
        editTemplate: typeof window.editTemplate,
        showApplyForm: typeof window.showApplyForm,
        manageTemplateNodes: typeof window.manageTemplateNodes,
    });

    // Funciones para mostrar/ocultar modales (definir globalmente)
    window.showModal = function(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            console.log('Mostrando modal:', modalId);
            // Eliminar clase hidden
            modal.classList.remove('hidden');
            // Eliminar estilos inline que bloquean la visualizaci√≥n
            modal.removeAttribute('style');
            // Aplicar estilos necesarios con !important
            modal.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important; position: fixed !important; z-index: 1000 !important;';
            console.log('Modal mostrado, estilos aplicados:', modal.style.cssText);
        } else {
            console.error('Modal no encontrado:', modalId);
        }
    };
    
    window.hideModal = function(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            console.log('Ocultando modal:', modalId);
            modal.classList.add('hidden');
            modal.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important;';
        }
    };
    
    // Configuraci√≥n de tabs y botones principales (dentro del mismo DOMContentLoaded)
    const assignModal = document.getElementById('assignModal');
    const templateModal = document.getElementById('templateModal'); // Declarar UNA SOLA VEZ aqu√≠
    const templateModalEl = templateModal; // Alias para evitar conflictos
    if (assignModal) assignModal.classList.add('hidden');
    if (templateModal) templateModal.classList.add('hidden');
    
    // ============================================
    // NUEVA INTERFAZ: Event Listeners y Funciones
    // ============================================
    
    // Tabs DATA (Workflow/Plantilla)
    const dataWorkflowTab = document.getElementById('dataWorkflowTab');
    const dataPlantillaTab = document.getElementById('dataPlantillaTab');
    const workflowListContent = document.getElementById('workflowListContent');
    const plantillaListContent = document.getElementById('plantillaListContent');
    
    if (dataWorkflowTab && dataPlantillaTab) {
        dataWorkflowTab.addEventListener('click', () => {
            dataWorkflowTab.style.background = '#fbbf24';
            dataWorkflowTab.style.color = '#1e293b';
            dataPlantillaTab.style.background = '#e2e8f0';
            dataPlantillaTab.style.color = '#475569';
            workflowListContent.style.display = 'block';
            plantillaListContent.style.display = 'none';
            renderWorkflowList();
        });
        
        dataPlantillaTab.addEventListener('click', () => {
            dataPlantillaTab.style.background = '#fbbf24';
            dataPlantillaTab.style.color = '#1e293b';
            dataWorkflowTab.style.background = '#e2e8f0';
            dataWorkflowTab.style.color = '#475569';
            workflowListContent.style.display = 'none';
            plantillaListContent.style.display = 'block';
            renderPlantillaList();
        });
    }
    
    // Obtener referencias a elementos necesarios
    const createWorkflowBtnTop = document.getElementById('createWorkflowBtnTop');
    const createTemplateBtnTop = document.getElementById('createTemplateBtnTop');
    const createWorkflowModal = document.getElementById('createWorkflowModal');
    const closeCreateWorkflowModal = document.getElementById('closeCreateWorkflowModal');
    const cancelCreateWorkflowBtn = document.getElementById('cancelCreateWorkflowBtn');
    const templateNameInput = document.getElementById('templateName');
    const templateDescriptionInput = document.getElementById('templateDescription');
    const templateModalTitle = document.getElementById('templateModalTitle');
    const closeTemplateModal = document.getElementById('closeTemplateModal');
    const cancelTemplateBtn = document.getElementById('cancelTemplateBtn');
    
    // Referencias adicionales para plantillas (usadas m√°s abajo)
    const createTemplateBtn = document.getElementById('createTemplateBtn');
    const applyTemplateBtn = document.getElementById('applyTemplateBtn');
    const saveTemplateBtn = document.getElementById('saveTemplateBtn');
    const doApplyTemplateBtn = document.getElementById('doApplyTemplateBtn');
    const cancelApplyBtn = document.getElementById('cancelApplyBtn');
    const applyTemplateSelect = document.getElementById('applyTemplateSelect');
    const applyAutoSyncCheckbox = document.getElementById('applyAutoSync');
    const templateFormMessage = document.getElementById('templateFormMessage');
    const applyTemplateMessage = document.getElementById('applyTemplateMessage');
    const closeAssignModal = document.getElementById('closeAssignModal');
    
    console.log('Elementos encontrados:', {
        createWorkflowBtnTop: !!createWorkflowBtnTop,
        createTemplateBtnTop: !!createTemplateBtnTop,
        createWorkflowModal: !!createWorkflowModal,
        templateModal: !!templateModalEl,
        createTemplateBtn: !!createTemplateBtn
    });
    
    // Botones del top - Crear Workflow
    if (createWorkflowBtnTop) {
        createWorkflowBtnTop.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Bot√≥n Crear Workflow clickeado');
            window.showModal('createWorkflowModal');
        });
    } else {
        console.error('createWorkflowBtnTop no encontrado');
    }
    
    // Botones del top - Crear Plantilla
    if (createTemplateBtnTop) {
        createTemplateBtnTop.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Bot√≥n Crear Plantilla clickeado');
            // Resetear formulario de plantilla
            if (templateNameInput) templateNameInput.value = '';
            if (templateDescriptionInput) templateDescriptionInput.value = '';
            if (templateModalTitle) templateModalTitle.textContent = 'Crear Nueva Plantilla';
            const templateNodesList = document.getElementById('templateNodesList');
            if (templateNodesList) templateNodesList.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">No hay nodos agregados a√∫n. Agrega el primero usando el formulario de abajo.</div>';
            window.currentEditingTemplateId = null;
            if (window.templateNodes) window.templateNodes = []; // Limpiar nodos temporales
            window.showModal('templateModal');
        });
    } else {
        console.error('createTemplateBtnTop no encontrado');
    }
    
    // Event listener para createTemplateBtn (bot√≥n dentro del modal/tab)
    if (createTemplateBtn) {
        createTemplateBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            selectedTemplateId = null;
            templateNodes = [];
            if (templateNameInput) templateNameInput.value = '';
            if (templateDescriptionInput) templateDescriptionInput.value = '';
            if (templateModalTitle) templateModalTitle.textContent = 'Crear Nueva Plantilla';
            
            // Asegurar que el modal est√© visible antes de inicializar
            if (templateModal) {
                templateModal.style.display = 'flex';
                templateModal.style.visibility = 'visible';
                templateModal.style.opacity = '1';
                templateModal.classList.remove('hidden');
            }
            
            // Inicializar listeners y cargar datos despu√©s de que el modal est√© visible
            setTimeout(async () => {
                console.log('Inicializando formulario de nodos...');
                nodeFormListenersInitialized = false; // Resetear flag
                initNodeFormListeners();
                await loadOIDs();
                renderTemplateNodes();
                console.log('Formulario inicializado');
            }, 300);
        });
    }
    
    // Event listeners para botones de plantillas (despu√©s de declaraciones)
    if (applyTemplateBtn) {
        applyTemplateBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (applyTemplateSelect) applyTemplateSelect.value = '';
            document.querySelectorAll('.apply-olt-checkbox').forEach(cb => cb.checked = false);
            if (assignModal) {
                assignModal.style.display = 'flex';
                assignModal.style.visibility = 'visible';
                assignModal.style.opacity = '1';
                assignModal.classList.remove('hidden');
            }
        });
    }

    if (closeTemplateModal) {
        closeTemplateModal.addEventListener('click', () => {
            if (templateModal) {
                templateModal.style.display = 'none';
                templateModal.style.visibility = 'hidden';
                templateModal.style.opacity = '0';
                templateModal.classList.add('hidden');
            }
            selectedTemplateId = null;
        });
    }

    if (closeAssignModal) {
        closeAssignModal.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (assignModal) {
                assignModal.style.display = 'none';
                assignModal.style.visibility = 'hidden';
                assignModal.style.opacity = '0';
                assignModal.classList.add('hidden');
            }
            if (applyTemplateSelect) applyTemplateSelect.value = '';
            document.querySelectorAll('.apply-olt-checkbox').forEach(cb => cb.checked = false);
            if (document.getElementById('selectAllOltsInModal')) {
                document.getElementById('selectAllOltsInModal').checked = false;
            }
        });
    }

    if (cancelTemplateBtn) {
        cancelTemplateBtn.addEventListener('click', () => {
            if (templateModal) {
                templateModal.style.display = 'none';
                templateModal.style.visibility = 'hidden';
                templateModal.style.opacity = '0';
                templateModal.classList.add('hidden');
            }
            selectedTemplateId = null;
        });
    }
    
    if (cancelApplyBtn) {
        cancelApplyBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (assignModal) {
                assignModal.style.display = 'none';
                assignModal.style.visibility = 'hidden';
                assignModal.style.opacity = '0';
                assignModal.classList.add('hidden');
            }
            if (applyTemplateSelect) applyTemplateSelect.value = '';
            document.querySelectorAll('.apply-olt-checkbox').forEach(cb => cb.checked = false);
            if (document.getElementById('selectAllOltsInModal')) {
                document.getElementById('selectAllOltsInModal').checked = false;
            }
        });
    }
    
    // Event listener para saveTemplateBtn (despu√©s de declaraciones)
    if (saveTemplateBtn) {
        saveTemplateBtn.addEventListener('click', async () => {
            const name = templateNameInput ? templateNameInput.value.trim() : '';
            if (!name) {
                setMessage(templateFormMessage, 'El nombre es requerido.', 'error');
                return;
            }
            
            const url = selectedTemplateId 
                ? `/snmp_jobs/api/workflow-templates/${selectedTemplateId}/`
                : '/snmp_jobs/api/workflow-templates/';
            const method = selectedTemplateId ? 'PUT' : 'POST';
            
            // Primero crear/actualizar la plantilla
            const response = await apiFetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken(),
                },
                body: JSON.stringify({
                    name: name,
                    description: templateDescriptionInput ? templateDescriptionInput.value.trim() : '',
                    is_active: true,
                }),
            });
            
            if (!response.ok) {
                const text = await response.text();
                setMessage(templateFormMessage, text || 'Error al guardar plantilla.', 'error');
                return;
            }
            
            const templateData = await response.json();
            const finalTemplateId = templateData.template.id;
            
            // Guardar nodos de la plantilla
            if (templateNodes.length > 0) {
                // Si estamos editando, primero eliminar nodos existentes y luego crear los nuevos
                if (selectedTemplateId) {
                    const existingNodesResponse = await apiFetch(`/snmp_jobs/api/workflow-templates/${finalTemplateId}/nodes/`);
                    if (existingNodesResponse.ok) {
                        const existingNodesData = await existingNodesResponse.json();
                        for (const existingNode of existingNodesData.nodes) {
                            await apiFetch(`/snmp_jobs/api/workflow-templates/${finalTemplateId}/nodes/${existingNode.id}/`, {
                                method: 'DELETE',
                                headers: {
                                    'X-CSRFToken': csrfToken(),
                                },
                            });
                        }
                    }
                }
                
                // Crear los nodos nuevos
                for (const node of templateNodes) {
                    const nodeUrl = `/snmp_jobs/api/workflow-templates/${finalTemplateId}/nodes/`;
                    const nodeResponse = await apiFetch(nodeUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken(),
                        },
                        body: JSON.stringify({
                            key: node.key,
                            name: node.name,
                            oid_id: node.oid_id,
                            interval_seconds: node.interval_seconds,
                            priority: node.priority,
                            enabled: node.enabled,
                        }),
                    });
                    
                    if (!nodeResponse.ok) {
                        const text = await nodeResponse.text();
                        setMessage(templateFormMessage, `Error al guardar nodo "${node.key}": ${text}`, 'error');
                        return;
                    }
                }
            }
            
            setMessage(templateFormMessage, `Plantilla ${selectedTemplateId ? 'actualizada' : 'creada'} correctamente con ${templateNodes.length} nodo(s).`, 'success');
            await loadWorkflowTemplates();
            setTimeout(() => {
                if (window.hideModal) {
                    window.hideModal('templateModal');
                } else {
                    const modal = document.getElementById('templateModal');
                    if (modal) {
                        modal.classList.add('hidden');
                        modal.style.display = 'none';
                        modal.style.visibility = 'hidden';
                        modal.style.opacity = '0';
                    }
                }
                selectedTemplateId = null;
                templateNodes = [];
                renderTemplateNodes();
                renderPlantillaList();
            }, 1500);
        });
    }
    
    // Event listener para doApplyTemplateBtn (despu√©s de declaraciones)
    if (doApplyTemplateBtn) {
        doApplyTemplateBtn.addEventListener('click', async () => {
            const templateId = applyTemplateSelect ? applyTemplateSelect.value : '';
            if (!templateId) {
                setMessage(applyTemplateMessage, 'Selecciona una plantilla.', 'error');
                return;
            }
            
            const selectedOlts = Array.from(document.querySelectorAll('.apply-olt-checkbox:checked'))
                .map(cb => parseInt(cb.value, 10));
            
            if (selectedOlts.length === 0) {
                setMessage(applyTemplateMessage, 'Selecciona al menos una OLT.', 'error');
                return;
            }
            
            if (!confirm(`¬øAplicar plantilla a ${selectedOlts.length} OLT(s)?\n\nSe crear√°n o vincular√°n nodos seg√∫n las keys.`)) {
                return;
            }
            
            const response = await apiFetch(`/snmp_jobs/api/workflow-templates/${templateId}/apply-to-olts/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken(),
                },
                body: JSON.stringify({
                    olt_ids: selectedOlts,
                    auto_sync: applyAutoSyncCheckbox ? applyAutoSyncCheckbox.checked : false,
                    create_custom_nodes: true,
                }),
            });
            
            if (!response.ok) {
                const text = await response.text();
                setMessage(applyTemplateMessage, text || 'Error al aplicar plantilla.', 'error');
                return;
            }
            
            const data = await response.json();
            const stats = data.stats;
            
            let message = `‚úÖ Plantilla aplicada:\n`;
            message += `  - OLTs procesadas: ${stats.olts_processed || 0}\n`;
            message += `  - Nodos vinculados: ${stats.nodes_linked || 0}\n`;
            message += `  - Nodos creados: ${stats.nodes_created || 0}\n`;
            message += `  - Nodos omitidos: ${stats.nodes_skipped || 0}`;
            
            if (stats.errors && stats.errors.length > 0) {
                message += `\n\n‚ö†Ô∏è Errores:\n${stats.errors.join('\n')}`;
            }
            
            setMessage(applyTemplateMessage, message, stats.errors && stats.errors.length > 0 ? 'error' : 'success');
            
            // Limpiar selecci√≥n y cerrar modal
            setTimeout(() => {
                if (assignModal) {
                    assignModal.style.display = 'none';
                    assignModal.style.visibility = 'hidden';
                    assignModal.style.opacity = '0';
                    assignModal.classList.add('hidden');
                }
                document.querySelectorAll('.apply-olt-checkbox').forEach(cb => cb.checked = false);
                if (applyTemplateSelect) applyTemplateSelect.value = '';
            }, 2000);
            
            // Recargar workflows para ver cambios
            await loadWorkflows();
        });
    }
    
    // Cerrar modales
    if (closeCreateWorkflowModal) {
        closeCreateWorkflowModal.addEventListener('click', () => {
            window.hideModal('createWorkflowModal');
        });
    }
    
    if (cancelCreateWorkflowBtn) {
        cancelCreateWorkflowBtn.addEventListener('click', () => {
            window.hideModal('createWorkflowModal');
        });
    }
    
    if (closeTemplateModal) {
        closeTemplateModal.addEventListener('click', () => {
            window.hideModal('templateModal');
        });
    }
    
    if (cancelTemplateBtn) {
        cancelTemplateBtn.addEventListener('click', () => {
            window.hideModal('templateModal');
        });
    }
    
    // Cerrar modal al hacer clic fuera de √©l
    if (createWorkflowModal) {
        createWorkflowModal.addEventListener('click', (e) => {
            if (e.target === createWorkflowModal) {
                window.hideModal('createWorkflowModal');
            }
        });
    }
    
    if (templateModalEl) {
        templateModalEl.addEventListener('click', (e) => {
            if (e.target === templateModalEl) {
                window.hideModal('templateModal');
            }
        });
    }
    
    // Funci√≥n para renderizar lista de workflows
    function renderWorkflowList() {
        const container = document.getElementById('workflowListItems');
        if (!container) return;
        
        const workflowsWithNodes = workflows.filter(wf => wf.nodes && wf.nodes.length > 0);
        
        if (workflowsWithNodes.length === 0) {
            container.innerHTML = '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: #94a3b8;">No hay workflows con nodos creados.</td></tr>';
            return;
        }
        
        container.innerHTML = workflowsWithNodes.map(wf => {
            const nodeCount = wf.nodes ? wf.nodes.length : 0;
            const templateInfo = wf.linked_templates && wf.linked_templates.length > 0 
                ? wf.linked_templates.map(t => t.template_name).join(', ')
                : 'SIN PLANTILLA';
            const estado = wf.is_active ? 'HABILITADO' : 'DESHABILITADO';
            const estadoColor = wf.is_active ? '#22c55e' : '#94a3b8';
            
            return `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 0.75rem;">
                        <div style="font-weight: 600; color: #1e293b;">${wf.olt_name || 'OLT'}</div>
                        <div style="font-size: 0.875rem; color: #64748b;">${wf.name || 'Sin nombre'}</div>
                    </td>
                    <td style="padding: 0.75rem;">
                        <span style="font-weight: 600; color: #1e293b;">${nodeCount} NODO${nodeCount !== 1 ? 'S' : ''}</span>
                    </td>
                    <td style="padding: 0.75rem;">
                        <span style="color: #64748b;">${templateInfo}</span>
                    </td>
                    <td style="padding: 0.75rem;">
                        <span style="color: ${estadoColor}; font-weight: 600;">${estado}</span>
                    </td>
                    <td style="padding: 0.75rem; text-align: center;">
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button class="edit-workflow-btn" data-workflow-id="${wf.id}" style="padding: 0.35rem 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem; font-weight: 600;">Editar</button>
                            <button class="delete-workflow-btn" data-workflow-id="${wf.id}" style="padding: 0.35rem 0.75rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem; font-weight: 600;">Eliminar</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Usar event delegation para evitar agregar listeners m√∫ltiples veces
        // Remover listeners anteriores si existen
        container.replaceWith(container.cloneNode(true));
        const newContainer = document.getElementById('workflowListItems');
        
        // Event delegation para botones
        newContainer.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-workflow-btn');
            const deleteBtn = e.target.closest('.delete-workflow-btn');
            
            if (editBtn) {
                e.preventDefault();
                e.stopPropagation();
                const workflowId = editBtn.dataset.workflowId;
                console.log('Bot√≥n Editar clickeado, Workflow ID:', workflowId);
                
                // Buscar el workflow en la lista
                const workflow = workflows.find(w => w.id == workflowId);
                if (!workflow) {
                    alert('Workflow no encontrado en la lista');
                    return;
                }
                
                // Obtener el selector y seleccionar el workflow
                const workflowSelector = document.getElementById('workflowSelector');
                if (workflowSelector) {
                    // Verificar que el workflow est√© en las opciones del selector
                    const optionExists = Array.from(workflowSelector.options).some(opt => opt.value == workflowId);
                    if (!optionExists) {
                        console.warn('Workflow no est√° en las opciones del selector, recargando workflows...');
                        await loadWorkflows();
                    }
                    
                    workflowSelector.value = workflowId;
                    console.log('Valor del selector establecido:', workflowSelector.value);
                    
                    // Disparar evento change para cargar el workflow
                    const changeEvent = new Event('change', { bubbles: true, cancelable: true });
                    workflowSelector.dispatchEvent(changeEvent);
                    console.log('Evento change disparado, workflow deber√≠a estar cargado');
                    
                    // Verificar que se carg√≥
                    setTimeout(() => {
                        if (selectedWorkflow && selectedWorkflow.id == workflowId) {
                            console.log('‚úÖ Workflow cargado correctamente:', selectedWorkflow.name);
                        } else {
                            console.warn('‚ö†Ô∏è Workflow no se carg√≥ correctamente');
                        }
                    }, 100);
                } else {
                    console.error('workflowSelector no encontrado');
                    alert('Error: No se pudo encontrar el selector de workflows');
                }
            }
            
            if (deleteBtn) {
                e.preventDefault();
                e.stopPropagation();
                const workflowId = deleteBtn.dataset.workflowId;
                console.log('Bot√≥n Eliminar clickeado, Workflow ID:', workflowId);
                const workflow = workflows.find(w => w.id == workflowId);
                if (!workflow) {
                    alert('Workflow no encontrado');
                    return;
                }
                
                if (!confirm(`¬øEliminar workflow "${workflow.name}" de ${workflow.olt_name}?\n\nEsta acci√≥n NO se puede deshacer.`)) {
                    return;
                }
                
                (async () => {
                    try {
                        console.log('Eliminando workflow:', workflowId);
                        const response = await apiFetch(`/snmp_jobs/api/workflows/${workflowId}/`, {
                            method: 'DELETE',
                            headers: { 'X-CSRFToken': csrfToken() },
                        });
                        
                        if (response.ok) {
                            console.log('Workflow eliminado correctamente');
                            // Remover de la lista local
                            workflows = workflows.filter(w => w.id != workflowId);
                            await loadWorkflows();
                            renderWorkflowList();
                        } else {
                            const errorData = await response.json();
                            console.error('Error al eliminar:', errorData);
                            alert(`Error al eliminar: ${errorData.error || 'Error desconocido'}`);
                        }
                    } catch (error) {
                        console.error('Error al eliminar workflow:', error);
                        alert(`Error: ${error.message}`);
                    }
                })();
            }
        });
    }
    
    // Funci√≥n para renderizar lista de plantillas
    function renderPlantillaList() {
        const container = document.getElementById('plantillaListItems');
        if (!container) return;
        
        // Cargar plantillas si no est√°n cargadas
        if (!window.templatesList) {
            loadWorkflowTemplates().then(() => {
                if (window.templatesList) {
                    renderPlantillaListItems(window.templatesList);
                }
            });
            return;
        }
        
        renderPlantillaListItems(window.templatesList);
    }
    
    function renderPlantillaListItems(templates) {
        const container = document.getElementById('plantillaListItems');
        if (!container) return;
        
        if (!templates || templates.length === 0) {
            container.innerHTML = '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: #94a3b8;">No hay plantillas creadas.</td></tr>';
            return;
        }
        
        container.innerHTML = templates.map(tpl => {
            const nodeCount = tpl.nodes ? tpl.nodes.length : 0;
            const oltCount = tpl.linked_workflows ? tpl.linked_workflows.length : 0;
            const estado = tpl.is_active ? 'ACTIVA' : 'INACTIVA';
            const estadoColor = tpl.is_active ? '#22c55e' : '#94a3b8';
            
            return `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 0.75rem;">
                        <div style="font-weight: 600; color: #1e293b;">${tpl.name}</div>
                        <div style="font-size: 0.875rem; color: #64748b;">${tpl.description || 'Sin descripci√≥n'}</div>
                    </td>
                    <td style="padding: 0.75rem;">
                        <span style="font-weight: 600; color: #1e293b;">${nodeCount} NODO${nodeCount !== 1 ? 'S' : ''}</span>
                    </td>
                    <td style="padding: 0.75rem;">
                        <span style="color: #64748b;">${oltCount} OLT${oltCount !== 1 ? 'S' : ''} (ASIGNADOS)</span>
                    </td>
                    <td style="padding: 0.75rem;">
                        <span style="color: ${estadoColor}; font-weight: 600;">${estado}</span>
                    </td>
                    <td style="padding: 0.75rem; text-align: center;">
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button class="edit-template-btn" data-template-id="${tpl.id}" style="padding: 0.35rem 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem; font-weight: 600;">Editar</button>
                            <button class="delete-template-btn" data-template-id="${tpl.id}" style="padding: 0.35rem 0.75rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem; font-weight: 600;">Eliminar</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Event listeners
        container.querySelectorAll('.edit-template-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const templateId = btn.dataset.templateId;
                if (typeof editTemplate === 'function') {
                    editTemplate(templateId);
                }
            });
        });
        
        container.querySelectorAll('.delete-template-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                const templateId = btn.dataset.templateId;
                if (!confirm('¬øEliminar esta plantilla?')) return;
                
                try {
                    const response = await apiFetch(`/snmp_jobs/api/workflow-templates/${templateId}/`, {
                        method: 'DELETE',
                        headers: { 'X-CSRFToken': csrfToken() },
                    });
                    
                    if (response.ok) {
                        await loadWorkflowTemplates();
                        renderPlantillaList();
                    } else {
                        const errorData = await response.json();
                        alert(`Error al eliminar: ${errorData.error || 'Error desconocido'}`);
                    }
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            });
        });
    }
    
    // Actualizar loadWorkflowTemplates para guardar la lista
    const originalLoadWorkflowTemplates = loadWorkflowTemplates;
    loadWorkflowTemplates = async function() {
        await originalLoadWorkflowTemplates();
        const response = await apiFetch('/snmp_jobs/api/workflow-templates/');
        if (response.ok) {
            const data = await response.json();
            window.templatesList = data.templates || [];
            if (plantillaListContent && plantillaListContent.style.display !== 'none') {
                renderPlantillaList();
            }
        }
    };
    
    // Panel: Crear Workflow
    const createWorkflowHostSelect = document.getElementById('createWorkflowHostSelect');
    const saveCreateWorkflowBtn = document.getElementById('saveCreateWorkflowBtn');
    
    if (createWorkflowHostSelect) {
        createWorkflowHostSelect.addEventListener('change', (e) => {
            const option = e.target.selectedOptions[0];
            if (option && option.value) {
                const marca = option.dataset.marca || '-';
                const modelo = option.dataset.modelo || '-';
                document.getElementById('selectedMarca').textContent = marca;
                document.getElementById('selectedModelo').textContent = modelo;
                document.getElementById('selectedHostInfo').style.display = 'block';
            } else {
                document.getElementById('selectedHostInfo').style.display = 'none';
            }
        });
    }
    
    if (saveCreateWorkflowBtn) {
        saveCreateWorkflowBtn.addEventListener('click', async () => {
            const oltId = createWorkflowHostSelect ? createWorkflowHostSelect.value : null;
            const description = document.getElementById('createWorkflowDescription') ? document.getElementById('createWorkflowDescription').value : '';
            
            if (!oltId) {
                alert('Selecciona un OLT primero');
                return;
            }
            
            try {
                const response = await apiFetch('/snmp_jobs/api/workflows/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken(),
                    },
                    body: JSON.stringify({ olt_id: parseInt(oltId, 10), description: description }),
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Workflow creado:', data);
                    alert('Workflow creado correctamente');
                    if (createWorkflowHostSelect) createWorkflowHostSelect.value = '';
                    if (document.getElementById('createWorkflowDescription')) document.getElementById('createWorkflowDescription').value = '';
                    if (document.getElementById('selectedHostInfo')) document.getElementById('selectedHostInfo').style.display = 'none';
                    window.hideModal('createWorkflowModal');
                    await loadWorkflows();
                    renderWorkflowList();
                } else {
                    const text = await response.text();
                    console.error('Error al crear workflow:', text);
                    alert(`Error al crear workflow: ${text}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        });
    }
    
    // Panel: Crear Nodo (para workflows)
    const saveCreateNodeBtn = document.getElementById('saveCreateNodeBtn');
    const createNodeOidSelect = document.getElementById('createNodeOidSelect');
    const createNodeIntervalInput = document.getElementById('createNodeIntervalInput');
    const createNodeKeyInput = document.getElementById('createNodeKeyInput');
    
    // Cargar OIDs cuando se selecciona un host
    if (createWorkflowHostSelect && createNodeOidSelect) {
        createWorkflowHostSelect.addEventListener('change', async () => {
            const oltId = createWorkflowHostSelect.value;
            if (oltId) {
                await loadOIDsForHost(oltId, createNodeOidSelect);
            }
        });
    }
    
    async function loadOIDsForHost(oltId, selectElement) {
        try {
            const response = await apiFetch('/snmp_jobs/api/oids/');
            if (response.ok) {
                const data = await response.json();
                selectElement.innerHTML = '<option value="">Selecciona OID‚Ä¶</option>';
                data.oids.forEach(oid => {
                    const option = document.createElement('option');
                    option.value = oid.id;
                    option.textContent = `${oid.nombre} (${oid.oid})`;
                    option.dataset.espacio = oid.espacio;
                    selectElement.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error cargando OIDs:', error);
        }
    }
    
    function parseInterval(intervalStr) {
        if (!intervalStr) return 300;
        const str = intervalStr.trim().toLowerCase();
        if (str.endsWith('s')) {
            return parseInt(str.slice(0, -1), 10) || 300;
        } else if (str.endsWith('m')) {
            return (parseInt(str.slice(0, -1), 10) || 5) * 60;
        } else if (str.endsWith('h')) {
            return (parseInt(str.slice(0, -1), 10) || 1) * 3600;
        }
        return parseInt(str, 10) || 300;
    }
    
    if (saveCreateNodeBtn) {
        saveCreateNodeBtn.addEventListener('click', async () => {
            // Necesitamos un workflow seleccionado
            if (!selectedWorkflow) {
                alert('Primero selecciona un workflow de la lista');
                return;
            }
            
            const oidId = createNodeOidSelect ? createNodeOidSelect.value : null;
            const intervalStr = createNodeIntervalInput ? createNodeIntervalInput.value : '';
            const key = createNodeKeyInput ? createNodeKeyInput.value.trim() : '';
            
            if (!oidId || !key) {
                alert('Completa todos los campos requeridos (OID y Key)');
                return;
            }
            
            const interval = parseInterval(intervalStr);
            
            // Obtener TaskTemplate desde el OID
            try {
                const oidResponse = await apiFetch(`/snmp_jobs/api/oids/${oidId}/`);
                if (!oidResponse.ok) {
                    throw new Error('No se pudo obtener informaci√≥n del OID');
                }
                
                // Buscar un TaskTemplate apropiado
                const templatesResponse = await apiFetch('/snmp_jobs/api/task-templates/');
                if (!templatesResponse.ok) {
                    throw new Error('No se pudieron cargar las plantillas de tareas');
                }
                
                const templatesData = await templatesResponse.json();
                const oidData = await oidResponse.json();
                
                // Buscar template seg√∫n espacio del OID
                const functionType = oidData.espacio === 'descubrimiento' ? 'descubrimiento' : 'get';
                const taskTemplate = templatesData.templates.find(t => t.function_type === functionType);
                
                if (!taskTemplate) {
                    alert('No se encontr√≥ una plantilla de tarea apropiada para este OID');
                    return;
                }
                
                // Crear el nodo
                const nodeResponse = await apiFetch(`/snmp_jobs/api/workflows/${selectedWorkflow.id}/nodes/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken(),
                    },
                    body: JSON.stringify({
                        key: key,
                        name: key,
                        template_id: taskTemplate.id,
                        interval_seconds: interval,
                        priority: oidData.espacio === 'descubrimiento' ? 1 : 3,
                    }),
                });
                
                if (nodeResponse.ok) {
                    alert('Nodo creado correctamente');
                    if (createNodeOidSelect) createNodeOidSelect.value = '';
                    if (createNodeIntervalInput) createNodeIntervalInput.value = '';
                    if (createNodeKeyInput) createNodeKeyInput.value = '';
                    await selectWorkflow(selectedWorkflow.id);
                    renderWorkflowList();
                    renderNodesList();
                } else {
                    const text = await nodeResponse.text();
                    alert(`Error: ${text}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        });
    }
    
    // Panel: Modificar Nodo
    let editingNodeId = null;
    const saveModifyNodeBtn = document.getElementById('saveModifyNodeBtn');
    const modifyNodeOidSelect = document.getElementById('modifyNodeOidSelect');
    const modifyNodeIntervalInput = document.getElementById('modifyNodeIntervalInput');
    
    if (saveModifyNodeBtn) {
        saveModifyNodeBtn.addEventListener('click', async () => {
            if (!selectedWorkflow || !editingNodeId) {
                alert('Selecciona un nodo para modificar');
                return;
            }
            
            const oidId = modifyNodeOidSelect ? modifyNodeOidSelect.value : null;
            const intervalStr = modifyNodeIntervalInput ? modifyNodeIntervalInput.value : '';
            
            if (!oidId) {
                alert('Selecciona un OID');
                return;
            }
            
            const interval = parseInterval(intervalStr);
            
            try {
                const response = await apiFetch(`/snmp_jobs/api/workflows/${selectedWorkflow.id}/nodes/${editingNodeId}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken(),
                    },
                    body: JSON.stringify({
                        interval_seconds: interval,
                    }),
                });
                
                if (response.ok) {
                    alert('Nodo modificado correctamente');
                    editingNodeId = null;
                    if (modifyNodeOidSelect) modifyNodeOidSelect.value = '';
                    if (modifyNodeIntervalInput) modifyNodeIntervalInput.value = '';
                    await selectWorkflow(selectedWorkflow.id);
                    renderNodesList();
                } else {
                    const text = await response.text();
                    alert(`Error: ${text}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        });
    }
    
    // Funci√≥n para renderizar lista de nodos
    function renderNodesList() {
        const container = document.getElementById('nodesListContainer');
        if (!container || !selectedWorkflow) {
            if (container) {
                container.innerHTML = '<div style="padding: 1rem; text-align: center; color: #94a3b8;">Selecciona un workflow para ver sus nodos</div>';
            }
            return;
        }
        
        const nodes = selectedWorkflow.nodes || [];
        
        if (nodes.length === 0) {
            container.innerHTML = '<div style="padding: 1rem; text-align: center; color: #94a3b8;">No hay nodos creados en este workflow</div>';
            return;
        }
        
        container.innerHTML = nodes.map(node => {
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; background: #f8fafc; border-radius: 4px; border: 1px solid #e2e8f0;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 0.25rem;">
                            NODO: ${node.name || node.key || 'Sin nombre'}, e intervalo iniciando que espacio va llenar
                        </div>
                        <div style="font-size: 0.875rem; color: #64748b;">
                            Key: ${node.key || 'sin-key'} ¬∑ Intervalo: ${node.interval_seconds}s ¬∑ Prioridad: ${node.priority}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="modify-node-btn" data-node-id="${node.id}" style="padding: 0.35rem 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">modificar</button>
                        <button class="delete-node-btn" data-node-id="${node.id}" style="padding: 0.35rem 0.75rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">eliminar</button>
                    </div>
                </div>
            `;
        }).join('');
        
        // Event listeners
        container.querySelectorAll('.modify-node-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                editingNodeId = btn.dataset.nodeId;
                const node = selectedWorkflow.nodes.find(n => n.id == editingNodeId);
                if (node) {
                    if (modifyNodeOidSelect) {
                        // Cargar OIDs y seleccionar el del nodo
                        await loadOIDsForHost(selectedWorkflow.olt_id, modifyNodeOidSelect);
                        // Buscar el OID del nodo (necesitar√≠amos guardar esta info)
                    }
                    if (modifyNodeIntervalInput) {
                        modifyNodeIntervalInput.value = `${node.interval_seconds}s`;
                    }
                    modifyNodeIntervalInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        });
        
        container.querySelectorAll('.delete-node-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const nodeId = btn.dataset.nodeId;
                const node = selectedWorkflow.nodes.find(n => n.id == nodeId);
                if (!node) return;
                
                if (!confirm(`¬øEliminar nodo "${node.name || node.key}"?`)) return;
                
                try {
                    const response = await apiFetch(`/snmp_jobs/api/workflows/${selectedWorkflow.id}/nodes/${nodeId}/`, {
                        method: 'DELETE',
                        headers: { 'X-CSRFToken': csrfToken() },
                    });
                    
                    if (response.ok) {
                        await selectWorkflow(selectedWorkflow.id);
                        renderNodesList();
                        renderWorkflowList();
                    }
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            });
        });
    }
    
    // Ya est√° actualizado arriba con originalSelectWorkflowForOlts
    
    // Bot√≥n agregar nodo en secci√≥n Nodos
    const addNodeBtn = document.getElementById('addNodeBtn');
    if (addNodeBtn) {
        addNodeBtn.addEventListener('click', () => {
            if (!selectedWorkflow) {
                alert('Selecciona un workflow primero');
                return;
            }
            // Scroll al panel de crear nodo
            if (saveCreateNodeBtn) {
                saveCreateNodeBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    }
    
    // Cargar OLTs en secciones OLT
    async function renderOltsSections() {
        const selectedOltsList = document.getElementById('selectedOltsList');
        const assignOltsList = document.getElementById('assignOltsList');
        
        // Cargar OLTs desde el selector existente
        const oltOptions = oltSelector ? Array.from(oltSelector.options) : [];
        
        if (assignOltsList && oltOptions.length > 0) {
            assignOltsList.innerHTML = oltOptions
                .filter(opt => opt.value)
                .map(opt => {
                    const text = opt.textContent;
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 4px; margin-bottom: 0.25rem;">
                            <span style="font-size: 0.9rem;">${text}</span>
                            <input type="checkbox" class="assign-olt-checkbox-new" value="${opt.value}" style="cursor: pointer;">
                        </div>
                    `;
                }).join('');
        }
    }
    
    // Actualizar cuando se selecciona un workflow
    const originalSelectWorkflowForOlts = selectWorkflow;
    selectWorkflow = async function(workflowId, options = {}) {
        await originalSelectWorkflowForOlts(workflowId, options);
        renderNodesList();
        
        // Actualizar secci√≥n OLT seleccionada
        if (selectedWorkflow) {
            const selectedOltsList = document.getElementById('selectedOltsList');
            if (selectedOltsList) {
                selectedOltsList.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 4px;">
                        <span>${selectedWorkflow.olt_name || 'OLT'}</span>
                        <button class="remove-olt-btn" style="padding: 0.25rem 0.5rem; background: rgba(239,68,68,0.8); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Eliminar</button>
                    </div>
                `;
            }
            
            // Actualizar marca y modelo
            if (selectedWorkflow.olt_id) {
                // Buscar OLT en la lista
                const oltOption = oltSelector ? Array.from(oltSelector.options).find(opt => opt.value == selectedWorkflow.olt_id) : null;
                if (oltOption) {
                    document.getElementById('selectedOltMarca').textContent = oltOption.dataset.marca || '-';
                    document.getElementById('selectedOltModelo').textContent = oltOption.dataset.modelo || '-';
                }
            }
        }
    };
    
    renderOltsSections();

    // Cargar datos iniciales
    (async () => {
        // Asegurar que los modales est√©n cerrados antes de cargar datos
        const assignModal = document.getElementById('assignModal');
        const templateModal = document.getElementById('templateModal');
        if (assignModal) assignModal.classList.add('hidden');
        if (templateModal) templateModal.classList.add('hidden');
        
        await loadWorkflows();
        await loadGlobalLegacyJobs();
        await loadWorkflowTemplates();
        
        // Renderizar listas iniciales
        renderWorkflowList();
        
        // Asegurar que los modales est√©n cerrados despu√©s de cargar
        if (assignModal) assignModal.classList.add('hidden');
        if (templateModal) templateModal.classList.add('hidden');
    })();
    
    }); // Cierre del DOMContentLoaded principal
</script>
</body>
</html>


