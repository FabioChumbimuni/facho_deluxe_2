{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static 'admin/css/forms.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'admin/css/widgets.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'admin/css/changelists.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'snmp_jobs/css/admin_themes.css' %}">
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --border-color: #cccccc;
            --hover-bg: #f5f5f5;
            --disabled-bg: #eeeeee;
            --error-color: #ba2121;
            --error-bg: #fff0f0;
            --primary-color: #79aec8;
            --secondary-text: #666666;
            --tertiary-text: #999999;
            --shadow: rgba(0,0,0,0.2);
            --form-bg: #ffffff;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1e1e1e;
                --text-color: #e0e0e0;
                --border-color: #404040;
                --hover-bg: #2d2d2d;
                --disabled-bg: #333333;
                --error-color: #ff6b6b;
                --error-bg: #2d1b1b;
                --primary-color: #4a9eff;
                --secondary-text: #b0b0b0;
                --tertiary-text: #808080;
                --shadow: rgba(0,0,0,0.5);
                --form-bg: #1a1a1a;
            }
        }
        
        .readonly {
            background-color: var(--disabled-bg) !important;
            cursor: not-allowed !important;
            pointer-events: none;
        }
        
        /* Fondo del formulario - solo para tema claro */
        @media (prefers-color-scheme: light) {
            #content-main {
                background-color: #f8f8f8;
                padding: 15px;
                border-radius: 4px;
                margin: 5px 0;
            }
            
            .form-row {
                background-color: #ffffff;
                padding: 10px;
                margin: 5px 0;
                border-radius: 3px;
                border: 1px solid #e0e0e0;
            }
            
            .form-row:hover {
                box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            }
        }
        
        /* Mantener tema oscuro sin cambios */
        @media (prefers-color-scheme: dark) {
            #content-main {
                background-color: var(--form-bg);
                padding: 20px;
                border-radius: 8px;
                margin: 10px 0;
            }
            
            .form-row {
                background-color: var(--bg-color);
                padding: 12px;
                margin: 8px 0;
                border-radius: 4px;
                border: 1px solid var(--border-color);
            }
            
            .form-row:hover {
                box-shadow: 0 1px 3px var(--shadow);
            }
        }
        
        .form-row label {
            color: var(--text-color);
            font-weight: 600;
        }
        
        /* Estilos específicos para tema claro - corregir recuadros negros */
        @media (prefers-color-scheme: light) {
            /* Forzar tema claro */
            body, #content-main {
                background-color: #ffffff !important;
                color: #333333 !important;
            }
            
            .form-row {
                background-color: #ffffff !important;
                color: #333333 !important;
                border-color: #cccccc !important;
            }
            
            .form-row input[type="text"],
            .form-row input[type="number"],
            .form-row textarea,
            .form-row select {
                background-color: #ffffff !important;
                color: #333333 !important;
                border-color: #cccccc !important;
            }
            
            .form-row input[type="text"]:focus,
            .form-row input[type="number"]:focus,
            .form-row textarea:focus,
            .form-row select:focus {
                border-color: #79aec8 !important;
                box-shadow: 0 0 0 2px rgba(121, 174, 200, 0.2) !important;
            }
            
            .form-row label {
                color: #333333 !important;
            }
            
            .help {
                color: #666666 !important;
            }
            
            .field-oid_espacio_info input[readonly] {
                background-color: #f5f5f5 !important;
                color: #666666 !important;
            }
            
            /* Corregir selectores en tema claro */
            .selector-available select,
            .selector-chosen select {
                background-color: #ffffff !important;
                color: #333333 !important;
                border-color: #cccccc !important;
            }
            
            .selector-available option,
            .selector-chosen option {
                background-color: #ffffff !important;
                color: #333333 !important;
            }
            
            .selector-filter {
                background: #ffffff !important;
                border-color: #cccccc !important;
            }
            
            .selector-filter input {
                background: #ffffff !important;
                color: #333333 !important;
                border-color: #cccccc !important;
            }
            
            .selector-chooser {
                background-color: #f5f5f5 !important;
            }
            
            .oid-search-results {
                background: #ffffff !important;
                border-color: #cccccc !important;
            }
            
            .oid-search-item {
                color: #333333 !important;
                border-bottom-color: #cccccc !important;
            }
            
            .oid-search-item:hover {
                background-color: #f5f5f5 !important;
            }
            
            .oid-search-item .oid-value {
                color: #666666 !important;
            }
            
            .oid-search-item .oid-espacio {
                color: #999999 !important;
            }
        }
        
        /* Estilos adicionales para forzar tema claro cuando no hay dark-theme */
        body:not(.dark-theme) {
            background-color: #ffffff !important;
            color: #333333 !important;
        }
        
        body:not(.dark-theme) #content-main {
            background-color: #ffffff !important;
        }
        
        body:not(.dark-theme) .form-row {
            background-color: #ffffff !important;
            color: #333333 !important;
            border-color: #cccccc !important;
        }
        
        body:not(.dark-theme) .form-row input[type="text"],
        body:not(.dark-theme) .form-row input[type="number"],
        body:not(.dark-theme) .form-row textarea,
        body:not(.dark-theme) .form-row select {
            background-color: #ffffff !important;
            color: #333333 !important;
            border-color: #cccccc !important;
        }
        
        body:not(.dark-theme) .form-row label {
            color: #333333 !important;
        }
        
        body:not(.dark-theme) .help {
            color: #666666 !important;
        }
        
        /* Estilos para tema oscuro cuando se aplica manualmente - usando data-theme */
        html[data-theme="dark"] #content-main {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
        }
        
        html[data-theme="dark"] .form-row {
            background-color: #1e1e1e !important;
            color: #e0e0e0 !important;
            border-color: #404040 !important;
        }
        
        html[data-theme="dark"] .form-row input[type="text"],
        html[data-theme="dark"] .form-row input[type="number"],
        html[data-theme="dark"] .form-row textarea,
        html[data-theme="dark"] .form-row select {
            background-color: #1e1e1e !important;
            color: #e0e0e0 !important;
            border-color: #404040 !important;
        }
        
        /* Estilos adicionales más específicos para tema oscuro */
        html[data-theme="dark"] body #content-main {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
        }
        
        html[data-theme="dark"] body .form-row {
            background-color: #1e1e1e !important;
            color: #e0e0e0 !important;
            border-color: #404040 !important;
        }
        
        html[data-theme="dark"] body .form-row input[type="text"],
        html[data-theme="dark"] body .form-row input[type="number"],
        html[data-theme="dark"] body .form-row textarea,
        html[data-theme="dark"] body .form-row select {
            background-color: #1e1e1e !important;
            color: #e0e0e0 !important;
            border-color: #404040 !important;
        }
        
        [data-theme="dark"] .form-row input[type="text"]:focus,
        [data-theme="dark"] .form-row input[type="number"]:focus,
        [data-theme="dark"] .form-row textarea:focus,
        [data-theme="dark"] .form-row select:focus {
            border-color: #4a9eff !important;
            box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.2) !important;
        }
        
        [data-theme="dark"] .form-row label {
            color: #e0e0e0 !important;
        }
        
        [data-theme="dark"] .help {
            color: #b0b0b0 !important;
        }
        
        [data-theme="dark"] .field-oid_espacio_info input[readonly] {
            background-color: #333333 !important;
            color: #b0b0b0 !important;
        }
        
        /* Estilos más específicos para tema oscuro */
        html[data-theme="dark"] body .form-row input[type="text"]:focus,
        html[data-theme="dark"] body .form-row input[type="number"]:focus,
        html[data-theme="dark"] body .form-row textarea:focus,
        html[data-theme="dark"] body .form-row select:focus {
            border-color: #4a9eff !important;
            box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.2) !important;
        }
        
        html[data-theme="dark"] body .form-row label {
            color: #e0e0e0 !important;
        }
        
        html[data-theme="dark"] body .help {
            color: #b0b0b0 !important;
        }
        
        html[data-theme="dark"] body .field-oid_espacio_info input[readonly] {
            background-color: #333333 !important;
            color: #b0b0b0 !important;
        }
        
        /* Corregir selectores en tema oscuro */
        [data-theme="dark"] .selector-available select,
        [data-theme="dark"] .selector-chosen select {
            background-color: #1e1e1e !important;
            color: #e0e0e0 !important;
            border-color: #404040 !important;
        }
        
        [data-theme="dark"] .selector-available option,
        [data-theme="dark"] .selector-chosen option {
            background-color: #1e1e1e !important;
            color: #e0e0e0 !important;
        }
        
        [data-theme="dark"] .selector-filter {
            background: #1e1e1e !important;
            border-color: #404040 !important;
        }
        
        [data-theme="dark"] .selector-filter input {
            background: #1e1e1e !important;
            color: #e0e0e0 !important;
            border-color: #404040 !important;
        }
        
        [data-theme="dark"] .selector-chooser {
            background-color: #333333 !important;
        }
        
        [data-theme="dark"] .oid-search-results {
            background: #1e1e1e !important;
            border-color: #404040 !important;
        }
        
        [data-theme="dark"] .oid-search-item {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
        }
        
        [data-theme="dark"] .oid-search-item:hover {
            background-color: #2d2d2d !important;
        }
        
        [data-theme="dark"] .oid-search-item .oid-value {
            color: #b0b0b0 !important;
        }
        
        [data-theme="dark"] .oid-search-item .oid-espacio {
            color: #808080 !important;
        }
        
        /* Estilo de depuración para verificar que se aplica el tema oscuro */
        html[data-theme="dark"] .form-row {
            background-color: #1e1e1e !important;
            color: #e0e0e0 !important;
            border: 2px solid #ff0000 !important; /* Borde rojo para depuración */
        }
        
        html[data-theme="dark"] .form-row input[type="text"],
        html[data-theme="dark"] .form-row input[type="number"],
        html[data-theme="dark"] .form-row textarea,
        html[data-theme="dark"] .form-row select {
            background-color: #1e1e1e !important;
            color: #e0e0e0 !important;
            border: 2px solid #00ff00 !important; /* Borde verde para depuración */
        }
        
        .selector {
            width: 100%;
            max-width: 900px;
        }
        .selector select {
            width: 425px !important;
            height: 300px !important;
        }
        .selector-available, .selector-chosen {
            width: 380px !important;
        }
        .selector-available h2, .selector-chosen h2 {
            background: var(--primary-color);
            color: white;
            padding: 8px;
            margin: 0;
            font-size: 13px;
            font-weight: 400;
        }
        .selector-filter {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-width: 0 1px;
            padding: 8px;
        }
        .selector-filter input {
            width: 320px;
            margin: 0;
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .selector-chooser {
            width: 22px;
            background-color: var(--disabled-bg);
            border-radius: 10px;
            margin: 10em 5px 0 5px;
            padding: 0;
        }
        .selector-chooser li {
            margin: 0;
            padding: 3px;
            list-style-type: none;
        }
        .selector select option {
            padding: 3px 10px;
        }
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
        .error-message {
            color: var(--error-color);
            background-color: var(--error-bg);
            border: 1px solid var(--error-color);
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        /* Estilos para OLTs deshabilitadas */
        .olt-disabled {
            color: var(--error-color) !important;
            font-style: italic;
        }
        .oid-search-results {
            position: absolute;
            z-index: 1000;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            box-shadow: 0 2px 5px var(--shadow);
        }
        .oid-search-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .oid-search-item:hover {
            background-color: var(--hover-bg);
        }
        .oid-search-item.selected {
            background-color: var(--primary-color);
            color: white;
        }
        .oid-search-item .oid-name {
            font-weight: bold;
            color: inherit;
        }
        .oid-search-item .oid-value {
            color: var(--secondary-text);
            font-size: 0.9em;
        }
        .oid-search-item .oid-espacio {
            color: var(--tertiary-text);
            font-size: 0.8em;
            font-style: italic;
        }
        .oid-search-item.selected .oid-value,
        .oid-search-item.selected .oid-espacio {
            color: #e0e0e0;
        }
        
        /* Estilos adicionales para tema oscuro */
        @media (prefers-color-scheme: dark) {
            .form-row input[type="text"],
            .form-row input[type="number"],
            .form-row textarea,
            .form-row select {
                background-color: var(--bg-color);
                color: var(--text-color);
                border-color: var(--border-color);
            }
            
            .form-row input[type="text"]:focus,
            .form-row input[type="number"]:focus,
            .form-row textarea:focus,
            .form-row select:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.2);
            }
            
            .help {
                color: var(--secondary-text);
            }
            
            .field-oid_espacio_info input[readonly] {
                background-color: var(--disabled-bg);
                color: var(--secondary-text);
            }
            
            /* Mejorar contraste en selectores */
            .selector-available select,
            .selector-chosen select {
                background-color: var(--bg-color);
                color: var(--text-color);
                border-color: var(--border-color);
            }
            
            .selector-available option,
            .selector-chosen option {
                background-color: var(--bg-color);
                color: var(--text-color);
            }
        }
        
        /* Estilos adicionales para tema oscuro */
        .dark-theme {
            --bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #404040;
            --hover-bg: #2d2d2d;
            --disabled-bg: #333333;
            --error-color: #ff6b6b;
            --error-bg: #2d1b1b;
            --primary-color: #4a9eff;
            --secondary-text: #b0b0b0;
            --tertiary-text: #808080;
            --shadow: rgba(0,0,0,0.5);
            --form-bg: #1a1a1a;
        }
        
        .dark-theme .form-row input[type="text"],
        .dark-theme .form-row input[type="number"],
        .dark-theme .form-row textarea,
        .dark-theme .form-row select {
            background-color: var(--bg-color);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        
        .dark-theme .form-row input[type="text"]:focus,
        .dark-theme .form-row input[type="number"]:focus,
        .dark-theme .form-row textarea:focus,
        .dark-theme .form-row select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.2);
        }
        
        .dark-theme .help {
            color: var(--secondary-text);
        }
        
        .dark-theme .field-oid_espacio_info input[readonly] {
            background-color: var(--disabled-bg);
            color: var(--secondary-text);
        }
        
        .dark-theme .selector-available select,
        .dark-theme .selector-chosen select {
            background-color: var(--bg-color);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        
        .dark-theme .selector-available option,
        .dark-theme .selector-chosen option {
            background-color: var(--bg-color);
            color: var(--text-color);
        }
    </style>
{% endblock %}

{% block extrahead %}
    {{ block.super }}
    {{ media }}
    <script src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
    <script src="{% static 'admin/js/jquery.init.js' %}"></script>
    <script src="{% static 'admin/js/core.js' %}"></script>
    <script src="{% static 'admin/js/admin/RelatedObjectLookups.js' %}"></script>
    <script src="{% static 'admin/js/actions.js' %}"></script>
    <script src="{% static 'admin/js/urlify.js' %}"></script>
    <script src="{% static 'admin/js/prepopulate.js' %}"></script>
    <script src="{% static 'admin/js/vendor/xregexp/xregexp.js' %}"></script>
    <script src="{% static 'admin/js/SelectBox.js' %}"></script>
    <script src="{% static 'admin/js/SelectFilter2.js' %}"></script>
{% endblock %}

{% block content %}
<div id="content-main">
    {% if is_edit %}
        <h1>Editar Tarea SNMP: {{ original.nombre }}</h1>
    {% else %}
        <h1>{{ title }}</h1>
    {% endif %}
    
    <!-- Mensaje de error global -->
    <div id="global-error" class="error-message" style="display: none;"></div>
    
    <form method="post" id="snmp_job_form" novalidate>
        {% csrf_token %}
        <div>
            <fieldset class="module aligned">
                <div class="form-row field-nombre">
                    <div>
                        {{ form.nombre.errors }}
                        {{ form.nombre.label_tag }}
                        {{ form.nombre }}
                        {% if form.nombre.help_text %}
                            <div class="help">{{ form.nombre.help_text|safe }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="form-row field-descripcion">
                    <div>
                        {{ form.descripcion.errors }}
                        {{ form.descripcion.label_tag }}
                        {{ form.descripcion }}
                        {% if form.descripcion.help_text %}
                            <div class="help">{{ form.descripcion.help_text|safe }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="form-row field-marca">
                    <div>
                        {{ form.marca.errors }}
                        {{ form.marca.label_tag }}
                        {{ form.marca }}
                        {% if form.marca.help_text %}
                            <div class="help">{{ form.marca.help_text|safe }}</div>
                        {% endif %}
                    </div>
                </div>
            </fieldset>

            <fieldset class="module aligned">
                <h2>Selección de OLTs y OIDs</h2>
                <div class="form-row field-olts">
                    <div>
                        {{ form.olts.errors }}
                        <label for="id_olts">OLTs:</label>
                        <div class="selector">
                            <div class="selector-available">
                                <h2>OLTs Disponibles</h2>
                                <p class="selector-filter">
                                    <input type="text" placeholder="Filtrar" class="selector-filter-input">
                                </p>
                                <select multiple="multiple" class="filtered" id="id_olts_from" style="height: 300px; width: 380px;">
                                </select>
                                <a href="#" class="selector-chooseall">Seleccionar todos</a>
                            </div>
                            <ul class="selector-chooser">
                                <li><a href="#" class="selector-add" title="Elegir">›</a></li>
                                <li><a href="#" class="selector-remove" title="Quitar">‹</a></li>
                            </ul>
                            <div class="selector-chosen">
                                <h2>OLTs Seleccionadas</h2>
                                <select multiple="multiple" id="id_olts" name="olts" class="filtered" style="height: 300px; width: 380px;" required>
                                </select>
                                <a href="#" class="selector-clearall">Quitar todos</a>
                            </div>
                        </div>
                        {% if form.olts.help_text %}
                            <div class="help">{{ form.olts.help_text|safe }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="form-row field-oid">
                    <div>
                        {{ form.oid.errors }}
                        {{ form.oid.label_tag }}
                        {{ form.oid }}
                        {{ form.oid_id }}
                        {% if form.oid.help_text %}
                            <div class="help">{{ form.oid.help_text|safe }}</div>
                        {% endif %}
                        <div id="oid-search-results" class="oid-search-results" style="display: none;"></div>
                    </div>
                </div>
                <div class="form-row field-oid_espacio_info">
                    <div>
                        {{ form.oid_espacio_info.errors }}
                        {{ form.oid_espacio_info.label_tag }}
                        {{ form.oid_espacio_info }}
                        {% if form.oid_espacio_info.help_text %}
                            <div class="help">{{ form.oid_espacio_info.help_text|safe }}</div>
                        {% endif %}
                    </div>
                </div>
            </fieldset>

            <fieldset class="module aligned">
                <h2>Configuración de la Tarea</h2>
                <div class="form-row field-interval_raw">
                    <div>
                        {{ form.interval_raw.errors }}
                        {{ form.interval_raw.label_tag }}
                        {{ form.interval_raw }}
                        {% if form.interval_raw.help_text %}
                            <div class="help">{{ form.interval_raw.help_text|safe }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="form-row field-cron_expr">
                    <div>
                        {{ form.cron_expr.errors }}
                        {{ form.cron_expr.label_tag }}
                        {{ form.cron_expr }}
                        {% if form.cron_expr.help_text %}
                            <div class="help">{{ form.cron_expr.help_text|safe }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="form-row field-schedule_description">
                    <div>
                        {{ form.schedule_description.errors }}
                        {{ form.schedule_description.label_tag }}
                        {{ form.schedule_description }}
                        {% if form.schedule_description.help_text %}
                            <div class="help">{{ form.schedule_description.help_text|safe }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="form-row field-job_type">
                    <div>
                        {{ form.job_type.errors }}
                        {{ form.job_type.label_tag }}
                        {{ form.job_type }}
                        {% if form.job_type.help_text %}
                            <div class="help">{{ form.job_type.help_text|safe }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="form-row field-enabled">
                    <div>
                        {{ form.enabled.errors }}
                        {{ form.enabled.label_tag }}
                        {{ form.enabled }}
                        {% if form.enabled.help_text %}
                            <div class="help">{{ form.enabled.help_text|safe }}</div>
                        {% endif %}
                    </div>
                </div>
            </fieldset>
        </div>
        <div class="submit-row">
            <input type="submit" value="Guardar" class="default" name="_save">
        </div>
    </form>
</div>

<script>
(function($) {
    'use strict';
    
    // Variables globales
    var isUpdating = false;
    var currentMarcaId = null;
    
    $(document).ready(function() {
        // Inicializar
        initializeForm();
        
        // Configurar tema oscuro dinámico
        setupDarkTheme();
        
        // Event listeners
        setupEventListeners();
        
        // Cargar datos iniciales
        loadInitialData();
    });
    
    function initializeForm() {
        // Obtener marca inicial
        currentMarcaId = $('#id_marca').val();
        
        // Configurar validación del formulario
        $('#snmp_job_form').on('submit', function(e) {
            return validateForm(e);
        });
    }
    
    function setupEventListeners() {
        // Cambio de marca - solo si no es readonly
        $('#id_marca').off('change').on('change', function() {
            // Verificar si el campo está en modo readonly (edición de tarea existente)
            if ($(this).prop('readonly')) {
                return; // No permitir cambios si es readonly
            }
            
            var marcaId = $(this).val();
            if (marcaId && marcaId !== currentMarcaId) {
                currentMarcaId = marcaId;
                updateFormForBrand(marcaId);
            }
        });
        
        // Botones del selector dual
        setupSelectorButtons();
        
        // Filtro de búsqueda
        setupFilterInput();
        
        // Configurar descripción del horario
        setupScheduleDescription();
        
        // Configurar actualización del espacio del OID
        setupOIDEspacioInfo();
        
        // Configurar buscador de OIDs
        setupOIDSearch();
    }
    
    function setupSelectorButtons() {
        // Botón agregar
        $('.selector-add').off('click').on('click', function(e) {
            e.preventDefault();
            moveSelectedOptions('#id_olts_from', '#id_olts');
        });
        
        // Botón quitar
        $('.selector-remove').off('click').on('click', function(e) {
            e.preventDefault();
            moveSelectedOptions('#id_olts', '#id_olts_from');
        });
        
        // Botón seleccionar todos
        $('.selector-chooseall').off('click').on('click', function(e) {
            e.preventDefault();
            moveAllOptions('#id_olts_from', '#id_olts');
        });
        
        // Botón quitar todos
        $('.selector-clearall').off('click').on('click', function(e) {
            e.preventDefault();
            moveAllOptions('#id_olts', '#id_olts_from');
        });
        
        // Doble clic en opciones
        $('#id_olts_from').off('dblclick').on('dblclick', 'option', function() {
            moveSelectedOptions('#id_olts_from', '#id_olts');
        });
        
        $('#id_olts').off('dblclick').on('dblclick', 'option', function() {
            moveSelectedOptions('#id_olts', '#id_olts_from');
        });
    }
    
    function setupFilterInput() {
        $('.selector-filter-input').off('input').on('input', function() {
            var filter = this.value.toLowerCase();
            var selectFrom = $('#id_olts_from');
            
            selectFrom.find('option').each(function() {
                var text = $(this).text().toLowerCase();
                $(this).toggle(text.includes(filter));
            });
        });
    }
    
    function updateFormForBrand(marcaId) {
        if (isUpdating) return;
        
        isUpdating = true;
        showLoading(true);
        hideGlobalError();
        
        // Actualizar OLTs y OIDs en paralelo
        Promise.all([
            updateOLTs(marcaId),
            updateOIDs(marcaId)
        ]).then(function() {
            console.log('Formulario actualizado para marca:', marcaId);
        }).catch(function(error) {
            console.error('Error al actualizar formulario:', error);
            showGlobalError('Error al cargar datos para la marca seleccionada. Por favor, intente nuevamente.');
        }).finally(function() {
            isUpdating = false;
            showLoading(false);
        });
    }
    
    function updateOLTs(marcaId) {
        return new Promise(function(resolve, reject) {
            $.getJSON('{% url "admin:snmp_jobs_snmpjob_get_olts" %}', { marca_id: marcaId })
                .done(function(data) {
                    try {
                        populateOLTSelectors(data.results);
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    reject(new Error('Error al cargar OLTs: ' + textStatus));
                });
        });
    }
    
    function updateOIDs(marcaId) {
        return new Promise(function(resolve, reject) {
            $.getJSON('{% url "admin:snmp_jobs_snmpjob_get_oids" %}', { marca_id: marcaId })
                .done(function(data) {
                    try {
                        populateOIDSelector(data.results);
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    reject(new Error('Error al cargar OIDs: ' + textStatus));
                });
        });
    }
    
    function populateOLTSelectors(oltsData) {
        var selectFrom = $('#id_olts_from');
        var selectTo = $('#id_olts');
        
        // Limpiar selectores
        selectFrom.empty();
        selectTo.empty();
        
        // Agregar opciones
        oltsData.forEach(function(item) {
            var option = new Option(item.text, item.id);
            option.title = item.text;
            
            // Aplicar estilos si la OLT está deshabilitada
            if (item.enabled === false) {
                option.classList.add('olt-disabled');
                option.text = item.text + ' (Deshabilitada)';
            }
            
            selectFrom.append(option);
        });
        
        // Ordenar opciones
        sortSelectOptions(selectFrom[0]);
    }
    
    function populateOIDSelector(oidsData) {
        var oidSelect = $('#id_oid');
        
        // Limpiar selector
        oidSelect.empty();
        
        // Agregar opción vacía
        oidSelect.append(new Option('--------', ''));
        
        // Agregar opciones
        oidsData.forEach(function(item) {
            var option = new Option(item.text, item.id);
            option.title = item.text;
            oidSelect.append(option);
        });
        
        // Ordenar opciones
        sortSelectOptions(oidSelect[0]);
        
        // Trigger change event
        oidSelect.trigger('change');
    }
    
    function moveSelectedOptions(fromSelector, toSelector) {
        var from = $(fromSelector);
        var to = $(toSelector);
        var selected = from.find('option:selected');
        
        if (selected.length === 0) return;
        
        selected.each(function() {
            // Verificar si es una OLT deshabilitada en creación
            if (isCreationMode() && $(this).hasClass('olt-disabled')) {
                showGlobalError('No se pueden seleccionar OLTs deshabilitadas en nuevas tareas.');
                return;
            }
            to.append(this);
        });
        
        sortSelectOptions(to[0]);
    }
    
    function moveAllOptions(fromSelector, toSelector) {
        var from = $(fromSelector);
        var to = $(toSelector);
        var options = from.find('option:visible');
        
        if (options.length === 0) return;
        
        options.each(function() {
            // Verificar si es una OLT deshabilitada en creación
            if (isCreationMode() && $(this).hasClass('olt-disabled')) {
                return; // Saltar OLTs deshabilitadas en creación
            }
            to.append(this);
        });
        
        sortSelectOptions(to[0]);
    }
    
    function sortSelectOptions(select) {
        var options = Array.from(select.options);
        options.sort(function(a, b) {
            return a.text.localeCompare(b.text);
        });
        
        // Limpiar y reinsertar opciones ordenadas
        select.innerHTML = '';
        options.forEach(function(option) {
            select.appendChild(option);
        });
    }
    
    function loadInitialData() {
        var initialMarca = $('#id_marca').val();
        var oltsData = {{ olts_data|safe }};
        var oidsData = {{ oids_data|safe }};
        
        if (initialMarca && oltsData.length > 0) {
            populateOLTSelectors(oltsData);
            
            // Marcar OLTs seleccionadas
            var selectedOlts = oltsData.filter(function(item) { return item.selected; });
            selectedOlts.forEach(function(item) {
                var option = $('#id_olts_from option[value="' + item.id + '"]');
                if (option.length > 0) {
                    $('#id_olts').append(option.detach());
                }
            });
        }
        
        if (initialMarca && oidsData.length > 0) {
            populateOIDSelector(oidsData);
            
            // Marcar OID seleccionado
            var selectedOid = oidsData.find(function(item) { return item.selected; });
            if (selectedOid) {
                $('#id_oid').val(selectedOid.id);
            }
        }
        
        // Actualizar descripción del horario al cargar la página
        updateScheduleDescription();
    }
    
    function validateForm(e) {
        var selectedOlts = $('#id_olts option');
        
        if (selectedOlts.length === 0) {
            e.preventDefault();
            showGlobalError('Debe seleccionar al menos una OLT.');
            return false;
        }
        
        // Asegurar que todas las opciones en el select derecho estén seleccionadas
        selectedOlts.each(function() {
            this.selected = true;
        });
        
        return true;
    }
    
    function showLoading(show) {
        if (show) {
            $('.selector').addClass('loading');
            $('#id_oid').addClass('loading');
        } else {
            $('.selector').removeClass('loading');
            $('#id_oid').removeClass('loading');
        }
    }
    
    function showGlobalError(message) {
        $('#global-error').text(message).show();
        $('html, body').animate({
            scrollTop: $('#global-error').offset().top - 100
        }, 500);
    }
    
    function hideGlobalError() {
        $('#global-error').hide();
    }
    
    function isCreationMode() {
        // Verificar si estamos en modo creación (no edición)
        return !{{ is_edit|yesno:"true,false" }};
    }
    
    // Funciones para actualizar descripción del horario en tiempo real
    function setupScheduleDescription() {
        $('#id_interval_raw, #id_cron_expr').off('input change').on('input change', function() {
            updateScheduleDescription();
        });
    }
    
    function updateScheduleDescription() {
        var intervalRaw = $('#id_interval_raw').val().trim();
        var cronExpr = $('#id_cron_expr').val().trim();
        
        // Limpiar el otro campo si uno está lleno
        if (intervalRaw && cronExpr) {
            if ($(this).attr('id') === 'id_interval_raw') {
                $('#id_cron_expr').val('');
                cronExpr = '';
            } else {
                $('#id_interval_raw').val('');
                intervalRaw = '';
            }
        }
        
        var description = '';
        
        if (cronExpr) {
            description = parseCronDescription(cronExpr);
        } else if (intervalRaw) {
            description = parseIntervalDescription(intervalRaw);
        } else {
            description = 'Sin programación definida';
        }
        
        $('#id_schedule_description').val(description);
    }
    
    function parseCronDescription(cronExpr) {
        try {
            var parts = cronExpr.split(' ');
            if (parts.length === 5) {
                var minute = parts[0];
                var hour = parts[1];
                var day = parts[2];
                var month = parts[3];
                var weekday = parts[4];
                
                // Caso: */30 * * * * (cada 30 minutos)
                if (minute === "*/30" && hour === "*" && day === "*" && month === "*" && weekday === "*") {
                    return "Cada 30 minutos";
                }
                
                // Caso: */15 * * * * (cada 15 minutos)
                else if (minute === "*/15" && hour === "*" && day === "*" && month === "*" && weekday === "*") {
                    return "Cada 15 minutos";
                }
                
                // Caso: */10 * * * * (cada 10 minutos)
                else if (minute === "*/10" && hour === "*" && day === "*" && month === "*" && weekday === "*") {
                    return "Cada 10 minutos";
                }
                
                // Caso: */5 * * * * (cada 5 minutos)
                else if (minute === "*/5" && hour === "*" && day === "*" && month === "*" && weekday === "*") {
                    return "Cada 5 minutos";
                }
                
                // Caso: * * * * * (cada minuto)
                else if (minute === "*" && hour === "*" && day === "*" && month === "*" && weekday === "*") {
                    return "Cada minuto";
                }
                
                // Caso: 0 * * * * (cada hora)
                else if (minute === "0" && hour === "*" && day === "*" && month === "*" && weekday === "*") {
                    return "Cada hora";
                }
                
                // Caso: 0 0 * * * (cada día a medianoche)
                else if (minute === "0" && hour === "0" && day === "*" && month === "*" && weekday === "*") {
                    return "Cada día a medianoche";
                }
                
                // Caso: 0 8 * * * (todos los días a las 8:00 AM)
                else if (minute === "0" && hour !== "*" && day === "*" && month === "*" && weekday === "*") {
                    var hourInt = parseInt(hour);
                    if (hourInt === 0) {
                        return "Todos los días a medianoche";
                    } else if (hourInt === 12) {
                        return "Todos los días a mediodía";
                    } else if (hourInt > 12) {
                        return "Todos los días a las " + (hourInt - 12) + ":00 PM";
                    } else {
                        return "Todos los días a las " + hour + ":00 AM";
                    }
                }
                
                // Caso: 30 8 * * * (todos los días a las 8:30 AM)
                else if (minute !== "0" && minute !== "*" && hour !== "*" && day === "*" && month === "*" && weekday === "*") {
                    var hourInt = parseInt(hour);
                    var minuteInt = parseInt(minute);
                    if (hourInt === 0) {
                        return "Todos los días a las 12:" + (minuteInt < 10 ? "0" : "") + minuteInt + " AM";
                    } else if (hourInt === 12) {
                        return "Todos los días a las 12:" + (minuteInt < 10 ? "0" : "") + minuteInt + " PM";
                    } else if (hourInt > 12) {
                        return "Todos los días a las " + (hourInt - 12) + ":" + (minuteInt < 10 ? "0" : "") + minuteInt + " PM";
                    } else {
                        return "Todos los días a las " + hour + ":" + (minuteInt < 10 ? "0" : "") + minuteInt + " AM";
                    }
                }
                
                // Caso: 0 8 * * 1 (lunes a las 8:00 AM)
                else if (minute === "0" && hour !== "*" && day === "*" && month === "*" && weekday !== "*") {
                    var weekdays = {
                        "0": "domingo", "1": "lunes", "2": "martes", "3": "miércoles",
                        "4": "jueves", "5": "viernes", "6": "sábado", "7": "domingo"
                    };
                    var weekdayName = weekdays[weekday] || weekday;
                    var hourInt = parseInt(hour);
                    if (hourInt === 0) {
                        return "Cada " + weekdayName + " a medianoche";
                    } else if (hourInt === 12) {
                        return "Cada " + weekdayName + " a mediodía";
                    } else if (hourInt > 12) {
                        return "Cada " + weekdayName + " a las " + (hourInt - 12) + ":00 PM";
                    } else {
                        return "Cada " + weekdayName + " a las " + hour + ":00 AM";
                    }
                }
                
                else {
                    return "Programado con cron: " + cronExpr;
                }
            } else {
                return "Expresión cron: " + cronExpr;
            }
        } catch (e) {
            return "Error en cron: " + cronExpr;
        }
    }
    
    function parseIntervalDescription(intervalRaw) {
        try {
            var value = intervalRaw.replace(/\D/g, '');
            var unit = intervalRaw.replace(/\d/g, '').toLowerCase();
            
            if (unit === 's') {
                return "Cada " + value + " segundo" + (value != 1 ? "s" : "");
            } else if (unit === 'm') {
                return "Cada " + value + " minuto" + (value != 1 ? "s" : "");
            } else if (unit === 'h') {
                return "Cada " + value + " hora" + (value != 1 ? "s" : "");
            } else {
                return "Intervalo: " + intervalRaw;
            }
        } catch (e) {
            return "Intervalo: " + intervalRaw;
        }
    }
    
    // Función para configurar la actualización del espacio del OID
    function setupOIDEspacioInfo() {
        $('#id_oid').off('change').on('change', function() {
            updateOIDEspacioInfo();
        });
        
        // Actualizar al cargar la página si ya hay un OID seleccionado
        updateOIDEspacioInfo();
    }
    
    function updateOIDEspacioInfo() {
        var selectedOidId = $('#id_oid').val();
        var espacioInfoField = $('#id_oid_espacio_info');
        
        if (selectedOidId) {
            // Buscar el OID en los datos disponibles
            var oidsData = {{ oids_data|safe }};
            var selectedOid = oidsData.find(function(item) { 
                return item.id == selectedOidId; 
            });
            
            if (selectedOid && selectedOid.espacio) {
                var espacioText = selectedOid.espacio;
                var espacioDisplay = '';
                
                // Mapear códigos a texto legible
                switch(espacioText) {
                    case 'descubrimiento':
                        espacioDisplay = 'Descubrimiento - Llena tablas de discovery (OnuStatus, OnuInventory)';
                        break;
                    case 'descripcion':
                        espacioDisplay = 'Descripción - Información descriptiva de ONUs';
                        break;
                    case 'mac':
                        espacioDisplay = 'MAC - Direcciones MAC de ONUs';
                        break;
                    case 'inventario':
                        espacioDisplay = 'Inventario - Información de inventario';
                        break;
                    case 'estado':
                        espacioDisplay = 'Estado - Estados de ONUs';
                        break;
                    case 'configuracion':
                        espacioDisplay = 'Configuración - Parámetros de configuración';
                        break;
                    case 'estadisticas':
                        espacioDisplay = 'Estadísticas - Datos estadísticos';
                        break;
                    case 'otro':
                        espacioDisplay = 'Otro - Otros tipos de información';
                        break;
                    default:
                        espacioDisplay = espacioText;
                }
                
                espacioInfoField.val(espacioDisplay);
            } else {
                espacioInfoField.val('Espacio no disponible');
            }
        } else {
            espacioInfoField.val('');
        }
    }
    
    // Función para configurar el buscador de OIDs
    function setupOIDSearch() {
        var searchTimeout;
        var currentMarcaId = null;
        
        // Obtener marca actual
        updateMarcaForOIDSearch();
        
        // Configurar evento de cambio de marca
        $('#id_marca').off('change.oidsearch').on('change.oidsearch', function() {
            updateMarcaForOIDSearch();
        });
        
        // Configurar evento de búsqueda
        $('#id_oid').off('input.oidsearch keydown.oidsearch').on('input.oidsearch keydown.oidsearch', function(e) {
            var input = $(this);
            var query = input.val().trim();
            
            // Manejar navegación con teclado
            if (e.keyCode === 38 || e.keyCode === 40) { // Flechas arriba/abajo
                e.preventDefault();
                navigateSearchResults(e.keyCode === 40 ? 1 : -1);
                return;
            }
            
            if (e.keyCode === 13) { // Enter
                e.preventDefault();
                selectFirstResult();
                return;
            }
            
            if (e.keyCode === 27) { // Escape
                hideSearchResults();
                return;
            }
            
            // Limpiar timeout anterior
            clearTimeout(searchTimeout);
            
            if (query.length >= 2) {
                // Buscar después de 300ms de inactividad
                searchTimeout = setTimeout(function() {
                    searchOIDs(query);
                }, 300);
            } else {
                hideSearchResults();
            }
        });
        
        // Ocultar resultados al hacer clic fuera
        $(document).off('click.oidsearch').on('click.oidsearch', function(e) {
            if (!$(e.target).closest('.field-oid').length) {
                hideSearchResults();
            }
        });
        
        // Cargar OID inicial si estamos editando
        loadInitialOID();
    }
    
    function updateMarcaForOIDSearch() {
        currentMarcaId = $('#id_marca').val();
    }
    
    function searchOIDs(query) {
        if (!currentMarcaId) {
            hideSearchResults();
            return;
        }
        
        $.ajax({
            url: '{% url "admin:snmp_jobs_snmpjob_search_oids" %}',
            data: {
                'marca_id': currentMarcaId,
                'q': query,
                'limit': 10
            },
            success: function(response) {
                displaySearchResults(response.results);
            },
            error: function() {
                hideSearchResults();
            }
        });
    }
    
    function displaySearchResults(results) {
        var container = $('#oid-search-results');
        container.empty();
        
        if (results.length === 0) {
            container.html('<div class="oid-search-item">No se encontraron OIDs</div>');
        } else {
            results.forEach(function(oid, index) {
                var item = $('<div class="oid-search-item" data-oid-id="' + oid.id + '" data-index="' + index + '">');
                item.html(
                    '<div class="oid-name">' + oid.nombre + '</div>' +
                    '<div class="oid-value">' + oid.oid + '</div>' +
                    '<div class="oid-espacio">Espacio: ' + oid.espacio_display + '</div>'
                );
                
                item.on('click', function() {
                    selectOID(oid);
                });
                
                container.append(item);
            });
        }
        
        container.show();
    }
    
    function hideSearchResults() {
        $('#oid-search-results').hide();
    }
    
    function navigateSearchResults(direction) {
        var items = $('#oid-search-results .oid-search-item');
        var current = $('#oid-search-results .oid-search-item.selected');
        var currentIndex = current.length ? parseInt(current.data('index')) : -1;
        var newIndex = currentIndex + direction;
        
        if (newIndex >= 0 && newIndex < items.length) {
            current.removeClass('selected');
            items.eq(newIndex).addClass('selected');
        }
    }
    
    function selectFirstResult() {
        var firstItem = $('#oid-search-results .oid-search-item').first();
        if (firstItem.length) {
            var oidId = firstItem.data('oid-id');
            var oidData = getOIDDataFromResults(oidId);
            if (oidData) {
                selectOID(oidData);
            }
        }
    }
    
    function getOIDDataFromResults(oidId) {
        var item = $('#oid-search-results .oid-search-item[data-oid-id="' + oidId + '"]');
        if (item.length) {
            return {
                id: oidId,
                nombre: item.find('.oid-name').text(),
                oid: item.find('.oid-value').text(),
                espacio_display: item.find('.oid-espacio').text().replace('Espacio: ', '')
            };
        }
        return null;
    }
    
    function selectOID(oid) {
        $('#id_oid').val(oid.nombre + ' (' + oid.oid + ')');
        $('#id_oid_id').val(oid.id);
        
        // Actualizar información del espacio
        updateOIDEspacioInfoFromData(oid);
        
        hideSearchResults();
    }
    
    function updateOIDEspacioInfoFromData(oid) {
        var espacioInfoField = $('#id_oid_espacio_info');
        var espacioDisplay = '';
        
        // Mapear códigos a texto legible
        switch(oid.espacio_display) {
            case 'Descubrimiento':
                espacioDisplay = 'Descubrimiento - Llena tablas de discovery (OnuStatus, OnuInventory)';
                break;
            case 'Descripción':
                espacioDisplay = 'Descripción - Información descriptiva de ONUs';
                break;
            case 'MAC':
                espacioDisplay = 'MAC - Direcciones MAC de ONUs';
                break;
            case 'Inventario':
                espacioDisplay = 'Inventario - Información de inventario';
                break;
            case 'Estado':
                espacioDisplay = 'Estado - Estados de ONUs';
                break;
            case 'Configuración':
                espacioDisplay = 'Configuración - Parámetros de configuración';
                break;
            case 'Estadísticas':
                espacioDisplay = 'Estadísticas - Datos estadísticos';
                break;
            case 'Otro':
                espacioDisplay = 'Otro - Otros tipos de información';
                break;
            default:
                espacioDisplay = oid.espacio_display;
        }
        
        espacioInfoField.val(espacioDisplay);
    }
    
    function loadInitialOID() {
        // Si estamos editando y hay un OID seleccionado, cargar su información
        var selectedOidId = $('#id_oid_id').val();
        if (selectedOidId) {
            // Buscar en los datos disponibles
            var oidsData = {{ oids_data|safe }};
            var selectedOid = oidsData.find(function(item) { 
                return item.id == selectedOidId; 
            });
            
            if (selectedOid) {
                $('#id_oid').val(selectedOid.text);
                updateOIDEspacioInfoFromData({
                    espacio_display: selectedOid.espacio_display || selectedOid.espacio
                });
            }
        }
    }
    
    // Función para configurar tema oscuro dinámico
    function setupDarkTheme() {
        // Detectar preferencia de tema del sistema
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
        
        // Función para aplicar tema
        function applyTheme(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark-theme');
            } else {
                document.documentElement.classList.remove('dark-theme');
            }
        }
        
        // Detectar si Django Admin ya tiene tema oscuro aplicado
        function detectDjangoTheme() {
            // Verificar si el documento tiene data-theme="dark"
            const dataTheme = document.documentElement.getAttribute('data-theme');
            const hasDjangoDarkTheme = dataTheme === 'dark';
            
            return hasDjangoDarkTheme;
        }
        
        // Aplicar tema basado en Django Admin primero, luego en preferencias del sistema
        if (detectDjangoTheme()) {
            applyTheme(true);
        } else if (prefersDark.matches) {
            applyTheme(true);
        } else {
            applyTheme(false);
        }
        
        // Escuchar cambios de tema del sistema
        prefersDark.addEventListener('change', function(e) {
            // Solo cambiar si Django Admin no tiene tema manual
            if (!detectDjangoTheme()) {
                applyTheme(e.matches);
            }
        });
        
        // Detectar tema desde localStorage si está disponible
        const savedTheme = localStorage.getItem('admin-theme');
        if (savedTheme) {
            applyTheme(savedTheme === 'dark');
        }
        
        // Observar cambios en el DOM para detectar cambios de tema de Django Admin
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && 
                    (mutation.attributeName === 'data-theme' || mutation.attributeName === 'class')) {
                    if (detectDjangoTheme()) {
                        applyTheme(true);
                    } else if (!prefersDark.matches) {
                        applyTheme(false);
                    }
                }
            });
        });
        
        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['data-theme', 'class']
        });
        
        observer.observe(document.body, {
            attributes: true,
            attributeFilter: ['class']
        });
    }
    
})(django.jQuery);
</script>
<script src="{% static 'snmp_jobs/js/admin_themes.js' %}"></script>
{% endblock %}