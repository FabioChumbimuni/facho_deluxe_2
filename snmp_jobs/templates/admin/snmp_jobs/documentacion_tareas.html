{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        /* Tema Claro (default) */
        body {
            transition: background-color 0.3s, color 0.3s;
        }
        
        .intro-text {
            color: #666;
        }
        
        .doc-section {
            background: white;
            border-left: 4px solid #007bff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.3s, color 0.3s;
        }
        .doc-section.discovery {
            border-left-color: #28a745;
        }
        .doc-section.get {
            border-left-color: #007bff;
        }
        .doc-section.walk {
            border-left-color: #ffc107;
        }
        .doc-section.bulk {
            border-left-color: #fd7e14;
        }
        .doc-section.table {
            border-left-color: #6f42c1;
        }
        .doc-section h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            transition: color 0.3s, border-color 0.3s;
        }
        .doc-section .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            margin-right: 8px;
        }
        .badge.discovery { background: #28a745; }
        .badge.get { background: #007bff; }
        .badge.walk { background: #ffc107; color: #333; }
        .badge.bulk { background: #fd7e14; }
        .badge.table { background: #6f42c1; }
        .doc-content ul {
            line-height: 2;
        }
        .doc-content ul li {
            margin: 8px 0;
        }
        .code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 13px;
            color: #495057;
            transition: background-color 0.3s, color 0.3s;
        }
        .flow-diagram {
            background: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            font-family: monospace;
            font-size: 13px;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            color: #856404;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        .info-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            color: #0c5460;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        
        /* TEMA OSCURO - Sincronizado con Django Admin */
        html[data-theme="dark"] body,
        html[data-theme="dark"] #content {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        html[data-theme="dark"] .doc-section {
            background: #2d2d2d;
            color: #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        
        html[data-theme="dark"] .doc-section h2 {
            color: #f0f0f0;
            border-bottom-color: #444;
        }
        
        html[data-theme="dark"] .doc-section h3 {
            color: #d0d0d0;
        }
        
        html[data-theme="dark"] .code {
            background: #1a1a1a;
            color: #a0d468;
        }
        
        html[data-theme="dark"] .flow-diagram {
            background: #1a1a1a;
            border-color: #444;
            color: #d0d0d0;
        }
        
        html[data-theme="dark"] .warning-box {
            background: #3d3000;
            border-color: #ffc107;
            color: #ffd54f;
        }
        
        html[data-theme="dark"] .info-box {
            background: #003545;
            border-color: #17a2b8;
            color: #5ddef4;
        }
        
        html[data-theme="dark"] .badge.walk {
            color: #1a1a1a;
        }
        
        html[data-theme="dark"] table {
            color: #e0e0e0;
        }
        
        html[data-theme="dark"] table thead tr {
            background: #3d3d3d !important;
        }
        
        html[data-theme="dark"] table tbody td {
            border-color: #444 !important;
        }
        
        html[data-theme="dark"] table tbody tr:hover {
            background: #3d3d3d !important;
        }
        
        html[data-theme="dark"] .breadcrumbs {
            background: #2d2d2d;
            color: #e0e0e0;
        }
        
        html[data-theme="dark"] .breadcrumbs a {
            color: #5dade2;
        }
        
        html[data-theme="dark"] h1 {
            color: #f0f0f0;
        }
        
        html[data-theme="dark"] .intro-text {
            color: #c0c0c0 !important;
        }
        
        html[data-theme="dark"] p {
            color: #c0c0c0 !important;
        }
        
        html[data-theme="dark"] .doc-content p {
            color: #c0c0c0 !important;
        }
        
        html[data-theme="dark"] ul li {
            color: #c0c0c0 !important;
        }
        
        html[data-theme="dark"] strong {
            color: #f0f0f0 !important;
        }
        
        html[data-theme="dark"] .button {
            background: #007bff !important;
            color: white !important;
            border-color: #007bff !important;
        }
        
        html[data-theme="dark"] .button:hover {
            background: #0056b3 !important;
        }
    </style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:snmp_jobs_snmpjob_changelist' %}">{% trans 'Tareas SNMP' %}</a>
    &rsaquo; {% trans 'Documentaci√≥n' %}
</div>
{% endblock %}

{% block content %}
<h1>üìö Documentaci√≥n de Tareas SNMP</h1>

<p class="intro-text" style="font-size:14px; margin:20px 0;">
    Esta gu√≠a explica en detalle qu√© hace cada tipo de tarea SNMP, c√≥mo funciona su flujo de ejecuci√≥n, 
    y qu√© datos se almacenan en la base de datos.
</p>

<!-- DISCOVERY -->
<div class="doc-section discovery">
    <h2><span class="badge discovery">DISCOVERY</span> Descubrimiento de ONUs</h2>
    
    <div class="doc-content">
        <h3>üéØ ¬øQu√© hace?</h3>
        <p>Descubre todas las ONUs conectadas a una OLT mediante SNMP WALK y actualiza su estado de presencia.</p>
        
        <h3>üìã Flujo de Ejecuci√≥n</h3>
        <div class="flow-diagram">
1Ô∏è‚É£ <strong>discovery_main_task</strong> (cola: discovery_main o discovery_manual)<br>
   ‚Üì Ejecuta SNMP WALK sobre el OID configurado<br>
   ‚Üì Obtiene TODOS los √≠ndices SNMP encontrados<br>
   ‚Üì<br>
2Ô∏è‚É£ <strong>Guarda resultados en memoria</strong><br>
   ‚Üì Almacena temporalmente todos los √≠ndices detectados<br>
   ‚Üì<br>
3Ô∏è‚É£ <strong>SOLO si la tarea es SUCCESS</strong>:<br>
   ‚îú‚îÄ Crea/actualiza registros en <span class="code">onu_index_map</span><br>
   ‚îú‚îÄ Actualiza <span class="code">onu_status</span>:<br>
   ‚îÇ  ‚îú‚îÄ √çndices que APARECEN ‚Üí <span class="code">presence = 'ENABLED'</span> üü¢<br>
   ‚îÇ  ‚îî‚îÄ √çndices que NO APARECEN ‚Üí <span class="code">presence = 'DISABLED'</span> üî¥<br>
   ‚îî‚îÄ Finaliza
        </div>
        
        <h3>üíæ Datos que actualiza</h3>
        <ul>
            <li><span class="code">onu_index_map</span>: Mapeo de √≠ndices SNMP (raw_index_key, normalized_id)</li>
            <li><span class="code">onu_status</span>: Estado de presencia (ENABLED/DISABLED)</li>
        </ul>
        
        <h3>‚öôÔ∏è Configuraci√≥n</h3>
        <ul>
            <li><strong>Reintentos:</strong> 2 reintentos cada 30 segundos</li>
            <li><strong>Cola:</strong> <span class="code">discovery_main</span> (autom√°tica) o <span class="code">discovery_manual</span> (manual)</li>
            <li><strong>OID requerido:</strong> Debe apuntar a tabla de descubrimiento (ej: .1.3.6.1.4.1.2011.6.128.1.1.2.46.1.1)</li>
        </ul>
        
        <div class="info-box">
            <strong>üí° Importante:</strong> Esta tarea NO desactiva OLTs por fallos consecutivos. Solo actualiza el estado de las ONUs.
        </div>
    </div>
</div>

<!-- GET -->
<div class="doc-section get">
    <h2><span class="badge get">GET</span> Consulta Individual SNMP</h2>
    
    <div class="doc-content">
        <h3>üéØ ¬øQu√© hace?</h3>
        <p>Consulta valores individuales de ONUs mediante SNMP GET y actualiza campos espec√≠ficos en <span class="code">onu_inventory</span>.</p>
        
        <h3>üìã Flujo de Ejecuci√≥n</h3>
        <div class="flow-diagram">
1Ô∏è‚É£ <strong>get_main_task</strong> (cola: get_main o get_manual)<br>
   ‚Üì Consulta <span class="code">onu_status</span> filtrando <span class="code">presence = 'ENABLED'</span><br>
   ‚Üì Divide ONUs en lotes (default: 200 ONUs por lote)<br>
   ‚Üì<br>
2Ô∏è‚É£ <strong>get_poller_task</strong> (cola: get_poller) [PARALELO]<br>
   ‚îú‚îÄ M√°ximo 10 pollers simult√°neos por OLT<br>
   ‚îú‚îÄ M√°ximo 5 consultas SNMP simult√°neas por OLT (sem√°foro)<br>
   ‚Üì<br>
3Ô∏è‚É£ Para cada ONU:<br>
   ‚îú‚îÄ Ejecuta SNMP GET individual: <span class="code">OID + raw_index_key</span><br>
   ‚îú‚îÄ Si respuesta = <strong>NOSUCHINSTANCE</strong>:<br>
   ‚îÇ  ‚îú‚îÄ <span class="code">onu_status.presence = 'DISABLED'</span> üî¥<br>
   ‚îÇ  ‚îî‚îÄ <span class="code">onu_inventory.active = False</span><br>
   ‚îú‚îÄ Si respuesta = <strong>valor v√°lido</strong>:<br>
   ‚îÇ  ‚îî‚îÄ Actualiza campo en <span class="code">onu_inventory</span> seg√∫n configuraci√≥n OID<br>
   ‚îî‚îÄ Si <strong>timeout/error</strong>:<br>
      ‚îî‚îÄ Subdivisi√≥n progresiva: 200 ‚Üí 50 ‚Üí individual (2 reintentos)<br>
        </div>
        
        <h3>üíæ Datos que actualiza (seg√∫n OID configurado)</h3>
        <ul>
            <li><span class="code">snmp_description</span>: Descripci√≥n SNMP de la ONU</li>
            <li><span class="code">mac_address</span>: Direcci√≥n MAC (opci√≥n formatear: AC:DC:SD ‚Üí ACDCSD)</li>
            <li><span class="code">plan_onu</span>: Plan de servicio asignado</li>
            <li><span class="code">distancia_onu</span>: Distancia f√≠sica en km (convierte metros ‚Üí km)</li>
            <li><span class="code">modelo_onu</span>: Modelo del equipo ONU</li>
        </ul>
        
        <h3>üîÑ L√≥gica de "Mantener Valor Previo"</h3>
        <p>Si el OID tiene <span class="code">keep_previous_value = True</span>:</p>
        <ul>
            <li>‚úÖ <strong>Si GET devuelve valor nuevo</strong> ‚Üí SOBREESCRIBE (actualiza)</li>
            <li>‚úÖ <strong>Si GET devuelve vac√≠o</strong> ‚Üí MANTIENE valor anterior (no pierde dato)</li>
        </ul>
        
        <h3>‚öôÔ∏è Configuraci√≥n</h3>
        <ul>
            <li><strong>Lote inicial:</strong> 200 ONUs</li>
            <li><strong>Subdivisi√≥n:</strong> 50 ONUs</li>
            <li><strong>Reintentos individuales:</strong> 2 intentos con backoff exponencial</li>
            <li><strong>Pollers por OLT:</strong> M√°ximo 10 simult√°neos</li>
            <li><strong>Sem√°foro SNMP:</strong> M√°ximo 5 consultas simult√°neas por OLT</li>
            <li><strong>Colas:</strong> <span class="code">get_main</span>, <span class="code">get_poller</span>, <span class="code">get_retry</span>, <span class="code">get_manual</span></li>
        </ul>
        
        <div class="warning-box">
            <strong>‚ö†Ô∏è Prerequisito:</strong> Ejecuta primero una tarea <strong>DISCOVERY</strong> para tener ONUs con <span class="code">presence='ENABLED'</span>. 
            De lo contrario, GET no encontrar√° ONUs para consultar.
        </div>
    </div>
</div>

<!-- WALK -->
<div class="doc-section walk">
    <h2><span class="badge walk">WALK</span> SNMP Walk (Recorrido Completo)</h2>
    
    <div class="doc-content">
        <h3>üéØ ¬øQu√© hace?</h3>
        <p>Recorre completamente una rama del √°rbol MIB mediante SNMP WALK, obteniendo todos los valores bajo un OID base.</p>
        
        <h3>üìã Caracter√≠sticas</h3>
        <ul>
            <li>Obtiene <strong>m√∫ltiples valores</strong> en una sola operaci√≥n</li>
            <li>Recorre secuencialmente la tabla SNMP</li>
            <li>√ötil para descubrir estructura completa de datos</li>
        </ul>
        
        <div class="info-box">
            <strong>üí° Diferencia con DISCOVERY:</strong> WALK es gen√©rico (cualquier OID), mientras que DISCOVERY tiene l√≥gica espec√≠fica 
            para actualizar <span class="code">onu_index_map</span> y <span class="code">onu_status</span>.
        </div>
    </div>
</div>

<!-- BULK -->
<div class="doc-section bulk">
    <h2><span class="badge bulk">BULK</span> SNMP GetBulk (Consulta Masiva)</h2>
    
    <div class="doc-content">
        <h3>üéØ ¬øQu√© hace?</h3>
        <p>Obtiene m√∫ltiples valores en una sola petici√≥n SNMP de forma m√°s eficiente que WALK.</p>
        
        <h3>üìã Caracter√≠sticas</h3>
        <ul>
            <li><strong>M√°s r√°pido</strong> que WALK para tablas grandes</li>
            <li>Reduce el n√∫mero de peticiones SNMP</li>
            <li>Obtiene bloques de valores (ej: 10-50 valores por petici√≥n)</li>
            <li>Ideal para equipos con muchos puertos/ONUs</li>
        </ul>
        
        <div class="info-box">
            <strong>üí° Cu√°ndo usar BULK:</strong> Para consultar tablas grandes (>100 entradas) donde WALK ser√≠a muy lento.
        </div>
    </div>
</div>

<!-- TABLE -->
<div class="doc-section table">
    <h2><span class="badge table">TABLE</span> SNMP Table (Tabla Completa)</h2>
    
    <div class="doc-content">
        <h3>üéØ ¬øQu√© hace?</h3>
        <p>Obtiene una tabla SNMP completa con m√∫ltiples columnas de forma estructurada.</p>
        
        <h3>üìã Caracter√≠sticas</h3>
        <ul>
            <li>Obtiene <strong>m√∫ltiples columnas</strong> de una tabla</li>
            <li>Estructura los datos en formato tabla</li>
            <li>√ötil para obtener informaci√≥n relacionada de m√∫ltiples OIDs</li>
            <li>Ejemplo: tabla de interfaces con nombre, estado, velocidad, errores</li>
        </ul>
    </div>
</div>

<!-- COMPARACI√ìN -->
<div class="doc-section" style="border-left-color: #6c757d;">
    <h2>‚öñÔ∏è Comparaci√≥n de Tipos</h2>
    
    <table style="width:100%; border-collapse: collapse; margin-top:15px;">
        <thead>
            <tr style="background:#f8f9fa;">
                <th style="padding:10px; border:1px solid #dee2e6;">Tipo</th>
                <th style="padding:10px; border:1px solid #dee2e6;">Consulta</th>
                <th style="padding:10px; border:1px solid #dee2e6;">Velocidad</th>
                <th style="padding:10px; border:1px solid #dee2e6;">Uso Recomendado</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td style="padding:10px; border:1px solid #dee2e6;"><span class="badge discovery">DISCOVERY</span></td>
                <td style="padding:10px; border:1px solid #dee2e6;">WALK + l√≥gica espec√≠fica</td>
                <td style="padding:10px; border:1px solid #dee2e6;">‚ö° Media</td>
                <td style="padding:10px; border:1px solid #dee2e6;">Descubrir ONUs y actualizar estado</td>
            </tr>
            <tr>
                <td style="padding:10px; border:1px solid #dee2e6;"><span class="badge get">GET</span></td>
                <td style="padding:10px; border:1px solid #dee2e6;">Individual por ONU</td>
                <td style="padding:10px; border:1px solid #dee2e6;">üê¢ Lenta (muchas peticiones)</td>
                <td style="padding:10px; border:1px solid #dee2e6;">Valores espec√≠ficos (descripci√≥n, MAC, plan)</td>
            </tr>
            <tr>
                <td style="padding:10px; border:1px solid #dee2e6;"><span class="badge walk">WALK</span></td>
                <td style="padding:10px; border:1px solid #dee2e6;">Secuencial completa</td>
                <td style="padding:10px; border:1px solid #dee2e6;">‚ö° Media</td>
                <td style="padding:10px; border:1px solid #dee2e6;">Explorar estructura MIB</td>
            </tr>
            <tr>
                <td style="padding:10px; border:1px solid #dee2e6;"><span class="badge bulk">BULK</span></td>
                <td style="padding:10px; border:1px solid #dee2e6;">Bloques grandes</td>
                <td style="padding:10px; border:1px solid #dee2e6;">‚ö°‚ö° R√°pida</td>
                <td style="padding:10px; border:1px solid #dee2e6;">Tablas grandes (>100 entradas)</td>
            </tr>
            <tr>
                <td style="padding:10px; border:1px solid #dee2e6;"><span class="badge table">TABLE</span></td>
                <td style="padding:10px; border:1px solid #dee2e6;">M√∫ltiples columnas</td>
                <td style="padding:10px; border:1px solid #dee2e6;">‚ö° Media-R√°pida</td>
                <td style="padding:10px; border:1px solid #dee2e6;">Datos relacionados (interfaz completa)</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- WORKFLOW RECOMENDADO -->
<div class="doc-section" style="border-left-color: #17a2b8;">
    <h2>üîÑ Workflow Recomendado</h2>
    
    <div class="flow-diagram">
<strong>Paso 1: DISCOVERY</strong> (ejecutar primero)<br>
   ‚Üì Descubre todas las ONUs conectadas<br>
   ‚Üì Actualiza onu_status.presence (ENABLED/DISABLED)<br>
   ‚Üì<br>
<strong>Paso 2: GET</strong> (despu√©s de DISCOVERY)<br>
   ‚Üì Consulta solo ONUs con presence='ENABLED'<br>
   ‚Üì Actualiza descripci√≥n, MAC, plan, distancia, modelo<br>
   ‚Üì<br>
<strong>Paso 3: BULK/TABLE</strong> (opcional, para datos masivos)<br>
   ‚îî‚îÄ Obtiene informaci√≥n adicional de forma eficiente
    </div>
    
    <div class="warning-box">
        <strong>‚ö†Ô∏è Orden importante:</strong> Siempre ejecuta <strong>DISCOVERY primero</strong> para tener el inventario de ONUs actualizado. 
        Las tareas GET dependen de los datos de DISCOVERY para saber qu√© ONUs consultar.
    </div>
</div>

<div style="margin-top:30px; text-align:center;">
    <a href="{% url 'admin:snmp_jobs_snmpjob_changelist' %}" class="button" style="padding:10px 20px;">‚Üê Volver a Tareas SNMP</a>
</div>

{% endblock %}

